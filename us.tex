\documentclass[kpfonts]{patmorin}
\listfiles
\usepackage{pat}
\usepackage{paralist}
\usepackage{dsfont}  % for \mathds{A}
\usepackage[utf8x]{inputenc}
\usepackage{skull}

\usepackage{graphicx}
\usepackage[noend]{algorithmic}

\usepackage[normalem]{ulem}
\usepackage{cancel}
\usepackage{enumitem}

\usepackage[longnamesfirst,numbers,sort&compress]{natbib}

% Taken from
% https://tex.stackexchange.com/questions/42726/align-but-show-one-equation-number-at-the-end
\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}}


\setlength{\parskip}{1ex}

\title{\MakeUppercase{(Layered) Partitions versus Decompositions}}
\author{}

\DeclareMathOperator{\tw}{tw}
\DeclareMathOperator{\ltw}{ltw}
\DeclareMathOperator{\pw}{pw}
\DeclareMathOperator{\lpw}{lpw}
\DeclareMathOperator{\lhptw}{lhp-tw}
\DeclareMathOperator{\lhppw}{lhp-pw}


\title{\MakeUppercase{Asymptotically Optimal Vertex 2-Ranking of Planar Graphs}}
\author{Prosenjit Bose, Vida DujmoviÄ‡, Mehrnoosh Javarsineh, and Pat Morin}

\newcommand{\uqs}{\chi_2}
\newcommand{\hus}{\hat{\chi}_2}

\newtheorem{othertheorem}{Theorem}
\renewcommand*{\theothertheorem}{\Alph{othertheorem}}
\crefname{othertheorem}{Theorem}{Theorem}

\newtheoremstyle{named}{}{}{\itshape}{}{\bfseries}{.}{.5em}{#3}
\theoremstyle{named}
\newtheorem*{namedtheorem}{Unused}

\newcommand{\weirdref}[2]{\cref{#1}#2}
\newcommand{\weirdlabel}[2]{\label{#1-#1}}

\pagenumbering{roman}
\begin{document}
\begin{titlepage}
\maketitle

\begin{abstract}
  A 2-ranking is a labelling $\varphi:V(G)\to\N$ of the vertices of a graph $G$ with integer colours so that for any path $v_0,\ldots,v_r$ of length $r\le 2$, $\max\{\varphi(v_0),\ldots,\varphi(v_r)\}$ appears exactly once in the sequence $\varphi(v_0),\ldots,\varphi(v_r)$.  We show that every $n$-vertex planar graph has a 2-ranking using $O(\log n/\log\log\log\log n)$ colours and this is tight; for some $n$-vertex planar graphs, any 2-ranking requires $\Omega(\log n/\log\log\log n)$ colours.

  In developing this proof we obtain optimal results for 2-ranking $t$-trees, outerplanar graphs, and planar 3-trees.  These upper bounds are constructive and give $O(n\log n)$-time algorithms.  Additional results that come from our techniques include new sublogarithmic upper bounds on the number of colours needed to rank bounded genus graphs, apex minor-free graphs, and $k$-planar graphs.
\end{abstract}
\end{titlepage}

\tableofcontents

\newpage
\pagenumbering{arabic}

\section{Introduction}

A sequence of integers $\phi_0,\ldots,\phi_r$ is \emph{ranked} if $\max\{\phi_0,\ldots,\phi_r\}$ occurs exactly once in $\phi_0,\ldots,\phi_r$. A \emph{colouring} $\varphi:V(G)\to \N$ of a graph $G$ is an \emph{$\ell$-ranking} if, for every path $v_0,\ldots,v_r$ in $G$ of length\footnote{The length of a path $v_0,\ldots,v_r$ is the number, $r$, of edges in the path.} at most the sequence $\varphi(v_0),\ldots,\varphi(v_r)$ is ranked.\footnote{An alternative, but equivalent, condition is that for every path $v_0,\ldots,v_r$ of length $r\le\ell$,
\begin{inparaenum}[(i)]
   \item $\varphi(v_0)\neq \varphi(v_r)$; or
   \item $\max\{\varphi(v_0),\ldots,\varphi(v_r)\} > \varphi(v_0)$.
\end{inparaenum}
}
The $\ell$-ranking number $\chi_\ell(G)$ is the minimum integer $k$ such that $G$ has a $\ell$-ranking $\varphi:V(G)\to \{1,\ldots,k\}$.

The case $\ell=2$ has received special attention \cite{almeter.demircan.ea:graph,karpas.neiman.ea:on,shalu.antony:complexity}. A $2$-ranking is called a \emph{unique-superior colouring} (abbreviated \emph{us-colouring}) by \citet{karpas.neiman.ea:on} who prove the following result:

\setcounter{othertheorem}{19}
\begin{othertheorem}[\cite{karpas.neiman.ea:on}]\label{trees}
    For every $n$-vertex tree $T$, $\uqs(T)\in O(\log n/\log\log n)$ and this is asymptotically optimal: for infinitely many values of $n$, there exists an $n$-vertex tree $T$ with $\uqs(T)\in\Omega(\log n/\log\log n)$.
\end{othertheorem}

The same authors prove the following result for planar graphs:

\setcounter{othertheorem}{15}
\begin{othertheorem}[\cite{karpas.neiman.ea:on}]\label{planar-graphs}
    For every $n$-vertex planar graph $G$, $\uqs(G)\in O(\log n)$.
\end{othertheorem}

Since every tree is a planar graph and no better lower bound is known for planar graphs, this leaves an obvious question:  Which is the correct bound for planar graphs $\log n$ or $\log n/\log\log n$?  As it turns out, neither is correct.  Let $\log x =\max\{2,\log x\}$, let $\log^{(0)}x:=x$ and, for any integer $i>0$, let $\log^{(i)}x:=\log(\log^{(i-1)} x)$. We prove:


\begin{thm}\label{planar}
    For every $n$-vertex planar graph $G$, $\uqs(G)\in O(\log n/\log^{(3)} n)$ and this is asymptotically optimal: for infinitely many values of $n$, there exists an $n$-vertex planar graph $G$ with $\uqs(G)\in \Omega(\log n/\log^{(3)} n)$
\end{thm}

Our proof of the upper bound in \cref{planar} makes use of a recent \emph{product structure theorem} of \citet{dujmovic.joret.ea:planar} which states that every planar graph $G$ is a subgraph of $H\boxtimes K_3\boxtimes P$ where $H$ is a planar $3$-tree, $K_3$ is a 3-cycle, $P$ is a path, and $\boxtimes$ denotes the strong graph product.\footnote{Definitions of $t$-trees, treewidth and strong graph product appear later.}  To apply this theorem, we prove the following result:

\begin{thm}\label{three-trees}
    For every $n$-vertex planar $3$-tree, $\uqs(G) \in O(\log n/\log^{(3)}n)$.
    and this is asymptotically optimal: for infinitely many values of $n$, there exists an $n$-vertex planar $3$-tree $T$ with $\uqs(T)\in\Omega(\log n/\log^{(3)} n)$.
\end{thm}

\cref{three-trees} is then applied to the graph $H$ along with a simple product colouring lemma which shows that, for any two graphs $G_1$ and $G_2$, $\uqs(G_1\boxtimes G_2)\le \uqs(G_1)\cdot\uqs(G_2)$. It is easy to see that $\uqs(K_3)=3$ and $\uqs(P)\le 3$, so this implies that $\uqs(H\boxtimes K_3\boxtimes P)\le 9\uqs(H)$.

For general $t$-trees, we obtain the following generalization of \cref{trees}:

\begin{thm}\label{t-trees}
    For every fixed $t$ and every $n$-vertex $t$-tree, $\uqs(G) \in O(\log n/\log^{(t+1)}(n)$ and this is asymptotically optimal: for infinitely many values of $n$, there exists an $n$-vertex $t$-tree $T$ with $\uqs(T)\in\Omega(\log n/\log^{(t+1)} n)$.
\end{thm}

Observe that, for $t=2$, the bound in \cref{t-trees} matches the bounds in \cref{planar,three-trees}.  Since every $2$-tree is planar and is, in fact, a subgraph of a planar $3$-tree, the lower bound in \cref{t-trees} establishes the lower bounds in \cref{planar,three-trees}.

In addition to planar graphs, there are product structure theorems for a number of other graph classes, including bounded genus graphs, apex minor-free graphs, and $k$-planar graphs.  Using same proof along with product structure theorems for these graph classes, \cref{t-trees}, implies the following meta-theorem:

\begin{thm}\label{meta-theorem}
    For each of the following graph classes $\mathcal{G}$:
    \begin{compactenum}
        \item the class of graphs that have non-crossing drawings in a surface of genus at most $g$;
        \item the class of graphs excluding a particular apex graph $A$ as a minor;
        \item the class of graphs that can be drawn in a surface of genus $g$ with at most $k$ crossings per edge,
    \end{compactenum}
    there exists an integer $c=c(\mathcal{G})$ such that, for every $n$-vertex graph $G\in\mathcal{G}$, $\uqs(G)\in O(\log n/\log^{(c)} n)$.
\end{thm}

\subsection{Related Work}

For a graph $G$, a vertex $\infty$-ranking is known as a \emph{vertex ranking} \cite{bodlaender.deogun.ea:rankings} or \emph{ordered colouring} of $G$ \cite{katchalski.mccuaig.ea:ordered}.  Finding an $\infty$-ranking $\varphi$ that uses exactly $\chi_\infty(G)$ colours is equivalent to finding a minimum-height elimination tree of $G$ \cite{torre.greenlaw.ea:optimal,deogun.kloks.ea:on}.  This measure has applications to parallel Cholesky factorization of matrices \cite{bodlaender.gilbert.ea:approximating,duff.reid:multifrontal,liu:role,dereniowski.kubale:cholesky} and in VLSI layout \cite{leiserson:area,sen.deng.ea:on}.  More recently, \citet{even.smorodinsky:hitting} showed that $\chi_\infty(G)$ determines the competitive ratio of the best algorithm for the online hitting set problem in $G$.

The \emph{vertex ranking problem} of determining $\chi_\infty(G)$ for an arbitrary graph $G$ is known to be NP-hard, even on some restricted classes of graphs \cite{bodlaender.deogun.ea:rankings,llewellyn.tovey.ea:local,llewellyn.tovey.ea:erratum,dereniowski.nadolski:vertex}. Polynomial-time algorithms for the vertex ranking problem have been found for several families of graphs: \citet{schaeffer:optimal} showed this for trees and \citet{deogun.kloks.ea:on} showed this for permutation graphs.

A straightforward application of planar separators shows that, for any $n$-vertex planar graph $G$, $\chi_\infty(G) \in O(\sqrt(n))$ \cite{llewellyn.tovey.ea:local,katchalski.mccuaig.ea:ordered}, and this bound is optimal:  There exists $n$-vertex planar graphs $G$ with $\chi_\infty(G)\in \Omega(\sqrt{n})$ \cite{katchalski.mccuaig.ea:ordered}.  A lower bound of \citet{katchalski.mccuaig.ea:ordered} shows that upper bounds like this, based on separators are essentially tight: If, for every $r$-element set $S\subseteq V(G)$, the graph $G-S$ has a component of size at least $\alpha m$, then $\chi_\infty(G) \in\Omega(\alpha r)$. In a similar vein, \citet{bodlaender.gilbert.ea:approximating,kloks:treewidth} show that $\chi_\infty(G)$ is lower bounded by 1 plus the pathwidth of $G$.

It is not hard to see that, even for an $n$-vertex path $P$, $\chi_\infty(P)\in\Omega(\log n)$.  The same separator argument, applied to treewidth-$t$ graphs shows that every $n$-vertex treewidth-$t$ graph $G$ has $\chi_\infty(G)\in O(t\log n)$.  This shows that, even for graphs with constant-size separators, (worst-case asymptotically) optimal bounds are obtained by divide-and-conquer.

More recently, at least two works have considered $\chi_\ell$ for finite $\ell$.  \citet{karpas.neiman.ea:on} proved \cref{trees}: a tight bound of $\uqs(T)\in O(\log n/\log\log n)$ for every $n$-vertex tree $T$ and \cref{planar-graphs} the upper bound $\uqs(G)\in O(\log n)$ for every $n$-vertex planar graph.  More generally, the same authors show that, for any proper minor-closed family $\mathcal{G}$ of graphs and, for every positive integer $\ell$, $\chi_\ell(G)\in O(\ell\log n)$ for every $n$-vertex $G\in\mathcal{G}$.  Finally, they show that, for fixed $d$, every $n$-vertex $d$-degenerate graph $G$ has $\uqs(G)\in O(\sqrt{n})$ and there exists examples with $\uqs(G)\in\Omega(n^{1/3})$.

\citet{shalu.antony:complexity} show that determining the minimum number of colours required by a 2-ranking of a given graph is NP-hard, even when restricted to planar bipartite graphs.  \citet{almeter.demircan} determine the exact value of $\uqs(Q_d)=d+1$ where $Q_d$ is the $d$-cube.  They also shows that, for subcubic graphs $G$, $\uqs(G)\le 7$ and show the existence of a graph with maximum degree $k$ such that $\uqs(G)\in\Omega(k^2/\log k)$.


The remainder of this paper is organized as follows: \Cref{sec:basics} reviews some basic tools used in the following sections. \Cref{upper-bounds} proves the upper bounds in \cref{planar,t-trees,three-trees}.  \Cref{lower-bounds} proves the lower bound in \cref{t-trees}, which immediately implies the lower bounds in \cref{planar,three-trees}. \Cref{conclusion} gives a brief summary and conclusions.

\section{Preliminaries}
\seclabel{basics}

In this paper we use standard graph theory terminology as used in the book by \citet{diestel:graph}
Every graph $G$ we consider is finite simple and undirected with vertex set denoted $V(G)$ and edge set denoted $E(G)$.  We use the shorthand $|G|:=|V(G)|$.
We let $N_G(v)=\{w\in V(G): vw\in E(G)\}$.
For any set $L$, the induced subgraph  $G[L]$ is a graph with $V(G[L]):=V(G)\cap L$ and $E(G[L])=\{vw\in E(G): \{v,w\}\subseteq L\}$.

The \emph{length} of a path $v_0,\ldots,v_r$ in a graph is equal to the number, $r$, of edges in the path. A path is \emph{trivial} if it has length 0 and \emph{non-trivial} otherwise.

Let $T$ be a rooted tree rooted at some node $r\in v(T)$.  For any node $x\in V(T)$, let $P_T(x)$ denote the path, in $T$ from $r$ to $x$.  The \emph{$T$-depth} of $x\in V(T)$, denoted $d_T(x)$ is the length of the path $P_T(x)$.  A node $a\in V(T)$ is a \emph{$T$-ancestor} of $x\in V(T)$ if $a\in V(P_T(x))$. If $a$ is a $T$-ancestor of $x$ then $x$ is a \emph{$T$-descendant} of $a$.  Note that every node of $T$ is both a $T$-ancestor and $T$-descendant of itself.  If $a$ is a $T$-ancestor of $x$ and $x\neq a$ then $a$ is a \emph{strict} $T$-ancestor of $x$ and $x$ is a \emph{strict} $T$-descedant of $x$.

For any graph $H$, and any two vertices $v,w\in V(H)$, let $d_H(v,w)$ denote the length of the shortest path, in $H$, from $v$ to $w$. For any $v\in V(H)$ and any $W\subseteq V(H)$, let $d_H(v,W)=\min\{w\in W: d_H(v,w)$. A \emph{BFS layering} of $H$ is a partition $L_0,\ldots,L_m$ of $V(H)$ such that, for each $i\in\{1,\ldots,m\}$ and each $v\in L_i$, $d_H(v,L_0)=i$.


\subsection{Treewidth}

A graph $H$ is a \emph{$t$-tree} if $H$ is a clique of size at most $t$ or if it contains a vertex $v$ such that $H[N_H(v)]$ is a $t$-clique and $H-\{t\}$ is a $t$-tree.  This recursive definition of $t$-trees implies that there is a permutation $v_1,\ldots,v_n$ of $V(G)$ such that $v_1,\ldots,v_t$ form a clique and, for each $i\in\{1,\ldots,n\}$, $v_i$ is adjacent to exactly $\min\{i-1,t\}$ vertices among $v_1,\ldots,v_{i-1}$ which themselves form a clique, which we call the \emph{parent clique} of $v_i$.  We call $v_1,\ldots,v_n$ a \emph{construction order} for $H$.  (Note that the parent clique of any vertex $v_i$, is determined by the choice of the \emph{root clique} $v_1,\ldots,v_t$, in the same way that the parent of a vertex in a tree is determined by the choice of the root.)  A \emph{$t$-forest} is a graph whose connected components are $t$-trees.

For two graphs $H$ and $X$, an \emph{$X$-decomposition} of $H$ is a sequence $\mathcal{X}:=(B_x:x\in V(X))$ of subsets of $V(H)$ called \emph{bags} indexed by the nodes of $X$ and such that
 \begin{inparaenum}[(i)]
     \item for each $v\in V(H)$, $X[\{x\in V(X):v\in B_x\}]$ is connected; and
     \item for each $vw\in E(H)$, there exists some $x\in V(X)$ such that $\{v,w\}\subseteq B_x$.
\end{inparaenum}
The \emph{width} of $\mathcal{X}$ is $\max\{|B_x|:x\in V(X)\}-1$.

In the special case where $X$ is a tree (or a forest), $\mathcal{X}$ is called a \emph{tree decomposition} of $H$.  In the still more special case where $X$ is a path (or a collection of disjoint paths), $\mathcal{X}$ is called a \emph{path decomposition} of $H$. The \emph{treewidth} of $H$ is the minimum width of any tree decomposition of $H$. The \emph{pathwidth} $\pw(H)$ of a graph $H$ is the minimum width of any path decomposition of $H$.

It is not difficult to see that every $t$-tree $H$ has treewidth $t$ and a tree-decomposition of $H$ can be constructed incrementally from a construction order $v_1,\ldots,v_n$ of $H$: Start with a tree $T$ that consists of a single node $r$ with bag $B_r:=\{v_1,\ldots,v_{\min\{t+1,n\}}\}$ and, for $i\gets t+2,\ldots,n$, let $x_i$ be the minimum-depth node of $T$ such that $B_{x_i}$ contains the parent clique of $v_i$, and add a new leaf $v_i$ to $T$ adjacent to $x_i$ whose bag $B_{v_i}$ contains $v_i$ and its parent clique.  We call a tree-decomposition constructed this way a \emph{canonical} tree decomposition of $H$.

It is easy to see that, every bag of a canonical tree decomposition $\mathcal{T}$ of a $t$-tree $H$ has size exactly $\min\{t+1,|H|\}$, $T$ is rooted at $r$, and
\begin{inparaenum}[(i)]\setcounter{enumi}{2}
  \item for each node $y$ of $T$ with parent $x$, $|B_y\setminus B_x|=1$.\label{three}
\end{inparaenum}
Note that this implies that $|V(T)|=n-t$, since $B_r$ contains $t+1$ vertices of $H$ and, by (\ref{three}), each $x\in V(T)\setminus\{r\}$ includes exactly one vertex of $H$ that is not in its parent.  For each $v\in V(H)$, we let $x_T(v)$ be the minimum-depth node $x\in V(T)$ such that $v\in B_x$.

\subsection{The Strong Graph Product}

For two graphs $G_1$ and $G_2$, $G_1\boxtimes G_2$ is a graph whose vertex set is the Cartesian product $V(G_1\boxtimes G_2)= V(G_1)\times V(G_2)$ and that contains an edge between $v=(v_1,v_2)$ and $w=(w_1,w_2)$ if and only if
\begin{inparaenum}[(i)]
    \item $v_1=w_1$ and $v_2w_2\in E(G_2)$;
    \item $v_2=w_2$ and $v_1w_1\in E(G_1)$; or
    \item $v_1w_1\in E(G_1)$ and $v_2w_2\in E(G_2)$.
\end{inparaenum}

The following recent result shows that every planar graph is the subgraph of a strong product of very simple graphs.

\begin{thm}\cite{dujmovic.joret.ea:planar}\label{product-structure}
    For every $n$-vertex planar graph $G$, there exists an at most $n$-vertex planar 3-tree $H$ and a path $P$ such that $G$ is isomorphic to a subgraph of $H\boxtimes P$.
\end{thm}

As the following simple lemma shows, product structure is highly relevant to 2-ranking:

\begin{lem}\label{product-lemma}
    For any two graphs $G_1$ and $G_2$, $\uqs(G_1\boxtimes G_2)\le \uqs(G_1)\cdot\uqs(G_2)$.
\end{lem}

\begin{proof}
  Use a product colouring $\varphi(x,y)=\uqs(G_2)\cdot \rho(x) + \psi(y)$ where $\rho:V(G_1)\to\{0,\ldots,\uqs(G_1)-1\}$ and $\psi:V(G_2)\to\{0,\ldots,\uqs(G_2)-1\}$ are 2-rankings of $G_1$ and $G_2$.  Consider any path $uvw$ in $G_1\boxtimes G_2$.  If the projection of $uvw$ onto $G_1$ is a path, then contribution of $\psi$ to $\varphi$ is irrelevant and the fact that $\rho$ is a 2-ranking of $G_1$ implies that $\varphi(u)\neq \varphi(w)$ or that $\varphi(v)>\varphi(w)$.  If the projection of $uvw$ onto $G_1$ has only two vertices, then $uvw$ is a $3$-cycle in $G_1\boxtimes G_2$ and $\varphi(u)$, $\varphi(v)$ and $\varphi(w)$ are all distinct.  If the projection of $uvw$ onto $G_1$ has only one vertex then the projection of $uvw$ onto $G_2$ has three vertices.  In this case, the contribution of $\rho$ to $\varphi$ is irrelevant and  and the fact that $\rho$ is a 2-ranking of $G_2$ implies that $\varphi(u)\neq \varphi(w)$ or that $\varphi(v)>\varphi(w)$.
\end{proof}

\cref{product-lemma,product-structure,three-trees} immediately imply the upper bound in \cref{planar}.

\subsection{Inequalities for Iterated Logarithms}

For any $x> 0$ and $a\ge 0$, we have the ineqality,
\begin{equation}
    \log (x+a) = \log (x(1+a/x)) = \log x + \log(1+a/x) \le \log x + \log e^{a/x} = \log x + \frac{a\log e}{x} \enspace , \label{log-x-plus-a}
\end{equation}
where the inequality follows from the inequality $e^z \le 1+z$, valid for all $z\in\R$.

Define the \emph{$\tau$ower of $\tau$wos} function $\tau:\N\to\N$ by
\[
  \tau(i) :=
    \begin{cases}
        1 & \text{for $i=0$} \\
        2^{\tau(i-1)} & \text{for $i\ge 1$} \\
    \end{cases}
\]
Recall that, for any integer $i\ge 0$,
\[
    \log^{(i)} x :=
      \begin{cases}
          x & \text{for $i=0$} \\
          \log\left(\log^{(i-1)}x\right) & \text{for $i\ge 1$} \\
      \end{cases}
\]

For any $x > \tau(i-1)$ and any $a\ge 0$, \cref{log-x-plus-a} generalizes as follows (by induction on $i$):
\begin{equation}
    \log^{(i)}(x+a) \le \log^{(i)} x + \frac{a(\log e)^i}{\prod_{j=0}^{i-1}\log^{(j)} x} \label{logi-x-plus-a}
\end{equation}

In several places we have ratios involving iterated logarithms, in which case we make use of the following consequence of \cref{logi-x-plus-a}
\begin{equation}
    \frac{\log^{(i)} x+a}{\log^{(i)} x} \le 1 + \frac{a(\log e)^i}{\prod_{j=0}^{i}\log^{(j)} x} \enspace, \label{logi-ratio}
\end{equation}
which is again valid for all $x> \tau(i-1)$.

\section{Upper Bounds}
\label{upper-bounds}

In this section we prove asymptotically tight bounds for the worst-case number of colours needed to 2-rank $n$-vertex $t$-trees.  Note that, throughout this section, and the rest of the paper, we treat $t$ as a fixed constant that does not depend on $n$.  Asymptotic notations $O$, $\Omega$, and $o$ are used are used assuming that $n$ (or some increasing function of $n$) is the only parameter tending to infinity.

\subsection{The Upper Bound for $t$-Trees}

We begin by proving the first half of \cref{t-trees}:

\begin{namedtheorem}[\weirdref{t-trees}{a}]\weirdlabel{t-trees}{a}
    For every fixed $t\ge 1$ and every $n$-vertex $t$-tree $H$, $\uqs(H)\in O(\log n/\log^{(t+1)} n)$.
\end{namedtheorem}

We now give a brief overview of the proof of \weirdref{t-trees}{a}.  The proof is by induction on the value of $t$.  The base case, $t=1$, is handled by \cref{trees}.  We need to prove that $H$ has a 2-ranking using colours $\{1,\ldots,ak\}$ for some constant $a$ and some $k\in O(\log n/\log^{(t+1)} n)$.  An asymptotically equivalent statement of this is: If $n \le (\log^{(t-1)}k)^k$, then $H$ has a 2-ranking using colours $\{1,\ldots,ak\}$, and this is the version of the statement that we prove.

The proof considers a BFS layering $L_1,\ldots,L_m$ of $H$ and uses the fact that each layer $L_i$ induces a $(t-1)$-forest $H[L_i]$, on which we can apply \weirdref{t-trees}{a} inductively.  The main difficulty with this approach is that a vertex $v$ in $H[L_i]$ dominates an entire $(t-1)$-forest $F$ in $H[L_{i+1}]$.  If some colour $\phi$ is used more than once in the colouring of $F$, then $v$ must be assigned a colour larger than $\phi$.

To account for this, we use a strengthening of \weirdref{t-trees}{a} that applies to any $t$-forest $H'$ contained in $H[L_{i+1}\cup\cdots\cup L_m]$.  This strengthening shows that, if $H'$ has size at most $(\log^{(t-1)} k)^k/(\log^{(t-1)} c)^c$ then $H'$ has a 2-ranking using colours $\{1,\ldots,ak\}$ in which no colour larger than $a(k-c-1)$ appears more than once in the colouring of $H'[L_{i+1}]$.  In essence, the size of $H'$ provides a lower bound on the colour assigned to some vertex $v$ in $L_i$.

It turns out to be easier to work with a $(t-1)$-forest $F$ contained in $H[L_i]$, in which each vertex $v$ is assigned a lower bound $a(k-\gamma(v)-1)$ on its colour.  This lower bound can also be interpreted as a weight  $(\log^{(t-1)}k)^k/(\log^{(t-1)}\gamma(v))^{\gamma(v)}$ that describes the size of the $t$-forest $H'$ in $H[L_{i+1}\cup\cdots\cup L_m]$ that is attached to $v$.  The condition that $H'$ has size at most $(\log^{(t-1)} k)^k/(\log^{(t-1)} c)^c$ translates roughly into the condition
\[
   \sum_{v\in V(F)}\frac{(\log^{(t-1)}k)^k}{(\log^{(t-1)}\gamma(v)^{\gamma(v)}} \le \frac{(k\log k)^k}{(c\log c)^c}
\]
We are able to show that $F$ has a special kind of separator $S$ such that
\begin{compactenum}
    \item $F[S]$ can be 2-ranked using $O(c)$ large colours in $\{a(k-c)+1,\ldots,ak\}$ that are each used only once and $O(t)$ small colours in $\{a(k-c-1)+1,\ldots,a(k-c)\}$ (that are used repeatedly); and
    \item Each component of $F-S$ can be 2-ranked using $O(k-c)$ small colours $\{1,\ldots,a(k-c-1)\}$.
\end{compactenum}
Each of these colourings respect the lower bounds given by $\gamma(v)$ for each vertex $v$ of $F$.  The separator $S$ has a \emph{shadow-completeness} property: if $uvw$ is a path with $u,w\in S$ and $v\in V(F-S)$, then $uw\in E(F[S])$.  This ensures that the resulting colouring is a 2-ranking of $F$.

The preceding sketch ignores a difficulty caused by the fact that forests in $H[L_{i+1}]$ are attached to $t$-cliques in $H[L_i]$ rather than individual vertices of $H[L_i]$.  If we treat each of these forests individually, then we run into the problem that there may be two $t$-cliques $C_1$ and $C_2$ with a vertex $v$ in common.  A $(t-1)$-forest $F_1$ attached to $C_1$ may avoid using colours larger than $a(k-c)$ more than once and a forest $F_2$ attached to $C_2$ may avoid using colours larger than $a(k-c)$ more than once.  Nevertheless, $F_1$ may have one vertex $u$ of colour $\phi >a(k-c)$ and $F_2$ may also have one vertex $w$ of colour $\phi$.  Since $uvw$ is a path in $H$, $v$'s colour must be larger than $\phi$.  We get around this by using an auxilliary colouring $\zeta$ of the $t$-cliques in $H[L_i]$ so that if two $t$-cliques $C_1$ and $C_2$ have a vertex in common and the preceding situation occurs, then $\zeta(C_1)\neq \zeta(C_2)$.  The vertices in $F_1$ receive the secondary colour $\zeta(C_1)$ and the vertices in $F_2$ receive the secondary colour $\zeta(C_2)$.  In this way, the vertices $u$ and $w$ described above receive different colours.

\subsubsection{Some Combination Lemmas}

A path $v_i,\ldots,v_r$ in $H$ is \emph{vertical} if $x_T(v_{i-1})$ is a strict $T$-ancestor of $x_T(v_i)$, for each $i\in\{1,\ldots,r\}$. (Equivalently, $v_0,\ldots,v_r$ is a subsequence of $v_1,\ldots,v_n$.) Any path in $H$ that is not vertical is \emph{humped}.  This allows us to define the humped us-chromatic number $\hus(H)=\hus(H,\mathcal{T})$ as the minimum number of colours needed in a humped 2-ranking of $H$.

\begin{lem}\label{humped}
    For any $t$-tree $H$, $\uqs(H)\le (\binom{t+2}{t}-1)\hus(H)$.
\end{lem}

\begin{proof}
    A lemma of \citet{pilipczuk.siebertz:polynomial} (see \cite[Lemma~13]{pilipczuk.siebertz:polynomial-arxiv}) shows that from any vertex $v\in V(H)$, the number of vertical paths of length at most $p$ that end at $v$ is at most $\binom{t+p}{t}$.  Applying this with $p=2$ implies that we can greedily colour $v_1,\ldots,v_n$ to obtain a colouring $\psi:V(H)\to \{0,\ldots,\binom{t+2}{t}-2\}$ so that the endpoints of any non-trivial vertical path of length at most $2$ are assigned different colours.  Let $\varphi':V(H)\to\{1,\ldots,k\}$ be a humped 2-ranking of $H$.  Then the colouring $\varphi:V(H)\to\{1,\ldots,\binom{t+2}{t}k\}$ defined by $\varphi(v):=(\binom{t+2}{t}-1)\varphi'(v)-\psi(v)$ proves the result.
\end{proof}


\begin{lem}\label{pathwidth}
    For any graph $H$, $\uqs(H)\le 3\pw(H) + 1$
\end{lem}

\begin{proof}
    The proof is by induction on $\pw(H)$.  The base case $\pw(H)=0$ is trivial: In this case, $H$ contains no edges and can be coloured with $1 = 3\pw(H)+1$ colour.

    For $\pw(H)>1$, it is well known that $H$ contains a sequence of vertices $v_1,\ldots,v_m$  such that
    \begin{inparaenum}[(i)]
        \item $H$ contains no edge $v_iv_j$ with $|i-j|>1$;
        \item $H$ contains no path $v_iw v_j$ with $|i-j|>1$; and
        \item $\pw(H-\{v_1,\ldots,v_m\})\le \pw(H)-1$.
    \end{inparaenum}
    Property~(iii) implies that we can therefore inductively colour $H-\{v_1,\ldots,v_m\}$ using colours $\{1,\ldots,3\pw(H)-2\}$ and then colour each $v_i$ with colour $3\pw(H)-1+i\bmod 3$.  Property~(i) ensures that this gives a 2-ranking of $H[v_1,\ldots,v_m]$.  Property~(ii) and the fact that $v_1,\ldots,v_m$ are coloured using larger colours than those used $H-\{v_1,\ldots,v_m\}$ ensures that the resulting colouring is a 2-ranking of $H$.
\end{proof}

A node $x$ in a rooted tree $T$ is a \emph{branching node} if $x$ has at least two children.  Let $\Lambda(T)$ denote the set of branching nodes in a tree $T$. For a graph $H$ with a rooted tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$, we define the $\mathcal{T}$-skeleton $\hat{H}$ of $H$ as the graph with vertex set $V(\hat{H}):=\bigcup_{x\in \Lambda(T)} B_x$ and containing the edge $vw$ if there exists $x,y\in V(T)$ with $v\in B_x$, $w\in B_y$ such that the path in $T$ from $x$ to $y$ contains no branching node in its interior.  It is worth noting that the skeleton $\hat{H}$ of $H$ is a minor of $H$ since it can be obtained from $H$ by repeatedly contracting an edge $vw$ with $v\in V(\hat{H})$ and $w\not\in V(\hat{H})$ into $v$.

\begin{obs}\label{skeleton-size}
    Let $H$ be a $t$-tree and $\mathcal{T}:=(B_x:x\in V(T))$ be a width-$t$ tree decomposition of $H$.  Then the $\mathcal{T}$-skeleton $\hat{H}$ of $H$ is also $t$-tree and has a tree decomposition $(B_x:x\in V(\hat{T}))$ where $|\hat{T}|=|\Lambda(T)|$ and therefore $|\hat{H}|\le (t+1)|\Lambda(T)|$.
\end{obs}

\begin{lem}\label{skeleton-colour}
    Let $H$ be a graph having a width-$t$ tree decomposition $\mathcal{T}$, and let $\hat{H}$ be the $\mathcal{T}$-skeleton of $H$.  Then $\uqs(H)\le \uqs(\hat{H}) + 3t+1$.
\end{lem}

\begin{proof}
    Let $\varphi:V(\hat{H})\to \{3t+2,\ldots,\uqs(\hat{H})+3t+1\}$ be a 2-ranking of $\hat{H}$. The graph $P:=T-\Lambda(T)$ consists of disjoint paths and, for any edge $vw\in H-V(\hat{H})$ there is a node $x\in V(P)$ such that $\{v,w\}\subseteq B_x$.  Therefore $H-V(\hat{H})$ has pathwidth at most $t$ so, by \cref{pathwidth}, it can be 2-ranked using colours $1,\ldots,3t+1$.  This gives the desired colouring of $H$ using colours $\{1,\ldots,\uqs(\hat{H})+3t+1\}$.  To see why this is a 2-ranking observe that for any path $uvw$ with $u,w\in V(\hat{H})$ and $v\in V(H)\setminus V(\hat{H})$, the edge $uw\in\hat{H}$, so $\varphi(u)\neq\varphi(w)$.
\end{proof}

\subsubsection{The Meat}

In order to eventually prove a tight bound for planar 3-trees (\cref{three-trees}) we introduce a light abstraction so that the proof of \weirdref{t-trees}{a} generalizes easily.  We say that a $(t-1)$-forest $L$ is \emph{$\mu$-bounded} if, for every minor $M$ of $L$, $\uqs(M)\in O(\log|M|/\log^{(\mu)}|M|)$.  For a $t$-tree $H$ with construction order $v_1,\ldots,v_n$, and BFS layering $L_0,\ldots,L_m$ with $L_0:=\{v_1,\ldots,v_{t+1}\}$ we say that $H$ is \emph{BFS-$\mu$-bounded} if, for each $i\in\{1,\ldots,m\}$, the $(t-1)$-forest $H[L_i]$ is $\mu$-bounded.

Recall that we are working on a proof of \weirdref{t-trees}{a} that works by induction on $t$ and the base case $t=1$ is already established by \cref{trees}. In terms of $\mu$-boundedness, the inductive hypothesis states that $H$ is BFS-$t$-bounded.  Indeed, for each layer $L_i$, $H[L_i]$ is a $(t-1)$-forest.  Since taking minors does not increase treewidth, $\tw(M)\le (t-1)$ for any minor $M$ of $H[L_i]$ so, by \weirdref{t-trees}{a}, $\uqs(M)\in O(\log|M|/\log^{(t)}|M|)$.

Before working directly with $t$-trees and $t$-forests we will work with node-weighted $(t-1)$-trees and $(t-1)$-forests in which each node $v$ is given a lower bound $a(k-\lambda(v)-1)+1$ on its colour. The following lemma give a \emph{slackness} condition that makes it possible to find a colouring that does not use \emph{any} colour larger than $a(k-c)$.

\begin{lem}\label{t-tree-slack}
Let $t,k\in\N$ and $\mu,c\in\R$ with $2\le \mu\le t$ and $\tau(t)\le c\le k-1$; let $H$ be a $\mu$-bounded $(t-1)$-tree; let $t':=\min\{t, |H|\}$; let $v_1,\ldots,v_{|H|}$ be a construction order for $H$ generating a canonical tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$ of $H$ rooted at $r\in V(T)$ with $B_r:=\{v_1,\ldots,v_{t'}\}$; let $\gamma:V(H)\to\{z\in\N: z\ge \tau(t-1)\}$, and let
\[
    n_r:=\sum_{v\in V(H)\setminus (B_r\setminus\{v_1\})} \frac{\left(\log^{(\mu-1)} k\right)^k}{\left(\log^{(\mu-1)} \gamma(v)\right)^{\gamma(v)}} \enspace .
\]
There exists an integer constant $a>0$ such that,
if
\begin{equation}
     n_r \le \frac{(\log^{(\mu-1)} k)^k}{\left(\log^{(\mu-1)} (c + s)\right)^{c+s}} \enspace ,
 \label{total-weight-i}
\end{equation}
where
\[
    s := \frac{\log c}{\log^{(\mu)} c}
\]
then $H$ has a 2-ranking $\varphi:V(H)\to\N$ such that
\begin{compactenum}[(P1)]
    \item for each $i\in\{1,\ldots,{t'}\}$, $\varphi(v_1)=\lfloor a(k-c-1)\rfloor+i-1$; and
    \item for each $v\in V(H)\setminus B_r$, $a(k-\gamma(v)-1) < \varphi(v) \le a(k-c-1)$.
\end{compactenum}
\end{lem}

\begin{proof}
    For each node $x\in V(T)$, let $T_x$ denote the subtree of $T$ induced by $x$ and all its descendants and let $H_x:=H[\bigcup_{y\in V(T_x)} B_y]$. Recall that, for $x\neq r$, $B_x$ contains exactly one vertex $v_1'$ that is not present in $B_p$ where $p$ is the $T$-parent of $x$.  Define
    \[
        n_x:=\sum_{v\in V(H_x)\setminus (B_x\setminus \{v_1'\})}(\log^{(\mu-1)} k)^k/(\log^{(\mu-1)}\gamma(v))^{\gamma(v)} \enspace .
    \]
    Note that, when $x=r$, this coincides with the definition of $n_r$ in the statement of the lemma (with $v_1'=v_1$).

    The proof is by induction on $|H|$.  In the base case, $|H|\le t$, in which case $T$ has only one node $r$. We set $\varphi(v_i):a(k-c-1)+i-1$ for each $i\in\{1,\ldots,t'\}$ in order to satisfy (P1).  In this case Condition (P2) is vacuous since it does not apply to vertices in $B_r$.

    Now assume $|H|\ge t+1$, so $|T|=|H|-t+1\ge 2$.  We say that node $x$ of $T$ is \emph{heavy} if
    \[
        n_v > \frac{(\log^{(\mu-1)} k)^k}{\left(\log^{(\mu-1)}\left(c+s+\tfrac{\log(c+s)}{\log^{(\mu)}(c+s)}\right)\right)^{c+s+\tfrac{\log(c+s)}{\log^{(\mu)}(c+s)}}} \enspace ,
    \]
    and $v$ is \emph{light} otherwise.  For a heavy node $v$,
    \begin{align*}
        (\log^{(\mu-1)} k)^k/n_v & < \left(\log^{(\mu-1)}\left(c+s+\tfrac{\log(c+s)}{\log^{(\mu)}(c+s)}\right)\right)^{c+s+\tfrac{\log(c+s)}{\log^{(\mu)}(c+s)}} \\
        & = \left(\log^{(\mu-1)}(c+s)\right)^{\left(c+s+\tfrac{\log(c+s)}{\log^{(\mu)}(c+s)}\right)
            \left(\tfrac{\log^{(\mu)}(c+s+\log(c+s)/\log^{(\mu)}(c+s))}{\log^{(\mu)}(c+s)}\right)}
            & \text{(change of base)} \\
        & < (\log^{(\mu-1)}(c+s))^{\left(c+s+\tfrac{\log(c+s)}{\log^{(\mu)}(c+s)}\right)
            \left(1 + \tfrac{(\log e)^\mu(\log(c+s))/\log^{(\mu)}(c+s)}{\prod_{j=0}^{\mu}\log^{(j)}(c+s)}\right)}
            & \text{(by \cref{logi-ratio})}\\
        & = (\log^{(\mu-1)}(c+s))^{\left(c+s+\tfrac{\log(c+s)}{\log^{(\mu)}(c+s)}\right)
            \left(1 + \tfrac{(\log e)^\mu}{(c+s)\cdot\left(\prod_{j=2}^{\mu-1}\log^{(j)}(c+s)\right)(\log^{(\mu)}(c+s))^2}\right)} &
            \text{(for $\mu\ge 2$)}\\
        & \le (\log^{(\mu-1)}(c+s))^{\left(c+s+\tfrac{\log(c+s)}{\log^{(\mu)}(c+s)}\right)
            \left(1 + \tfrac{(\log e)^\mu}{(c+s)\cdot(\log^{(\mu)}(c+s))^2}\right)}
            & \text{($c\ge \tau(\mu)$, so $\prod_{j=2}^{\mu-1}\log^{(j)}c\ge 1$)} \\
        & = (\log^{(\mu-1)}(c+s))^{c+s+\tfrac{\log(c+s)}{\log^{(\mu)}(c+s)} +
            \tfrac{(\log e)^\mu}{(\log^{(\mu)}(c+s))^2} + \tfrac{(\log e)^\mu\log(c+s)}{(c+s)(\log^{(\mu)}(c+s))^3}}  \\
        & = (\log^{(\mu-1)}(c+s))^{c+s+\tfrac{\log(c+s)}{\log^{(\mu)}(c+s)} + o_c\left(\frac{1}{\log^{(\mu)}(c+s)}\right)}  \\
        & = (\log(c+s))^{c+s}\cdot (c+s)\cdot (1+o_c(1)) \enspace .
        \numberthis \label{sizer}
    \end{align*}

    Let $T'$ be the subtree of $T$ induced by the set of heavy nodes.  Since no leaf of $T'$ is a $T$-descendant of any other leaf, it follows from \cref{total-weight-i,sizer} that the number of leaves of $T'$ is $O(c+s)=O(c)$.

    Let $H':=H[\bigcup_{x\in V(T')} B_x]$ and notice that $\mathcal{T}':=(B_x:x\in V(T'))$ is a width-$(t-1)$ tree decomposition of $H'$. The tree $T'$ has $O(c)$ leaves and therefore has at most $O(c)$ branching nodes. By \cref{skeleton-size}, the $\mathcal{T}'$-skeleton $\hat{H'}$ of $H'$ is a $t$-tree and $|\hat{H}'|\in O(c)$.  Since $H$ is $\mu$-bounded and $\hat{H}'$ is a minor of $H'$ (and therefore a minor of $H$),
    \[
       \uqs(\hat{H}')\in
       O\left(\frac{\log|\hat{H}'|}{\log^{(\mu)}|\hat{H}'|}\right)
       \subseteq O\left(\frac{\log c}{\log^{(\mu)} c}\right) = O(s) \enspace .
    \]
    Therefore, $H'$ has a 2-ranking $\varphi:V(H')\to \{a(k-c-1)-r,\ldots,a(k-c-1)-1\}$ for some $r\in O(s)$. Modifying $\varphi$ so that it colours $\varphi(v_i):=a(k-c-1)+i-1$ for each $i\in\{1,\ldots,t\}$ preserves the fact that $\varphi$ is a 2-ranking.

    The colouring $\varphi$ of $H'$ is a partial colouring of $H$. By definition, $\varphi$ satisifies requirement (P1). For a sufficiently large constant $a$, $a(k-c-1)-r > a(k-c-s-1)$, so each vertex in $H'$ receives a colour larger than $a(k-c-s-1)$.  For any vertex $v\in V(H)\setminus (B_r\setminus \{v_1\})$,
    \[ \frac{(\log^{(\mu-1)} k)^k}{(\log^{(\mu-1)}\gamma(v))^{\gamma(v)}}
         \le n_r
         \le \frac{(\log^{(\mu-1)} k)^k}{(\log^{(\mu-1)}(c+s))^{(c+s)}}
    \]
    so $\gamma(v)\ge c+s$, so the partial colouring $\varphi$ satisifies requirement (P2).

   Now, $T-T'$ is a forest of trees $T_1,\ldots,T_m$ rooted at nodes $r_1,\ldots,r_m$, respectively.
   For each $i\in\{1,\ldots,m\}$, $r_i$ is light, so
   \[
       n_{r_i} \le \frac{(\log k)^k}{
        \left(
            \log^{(\mu-1)}
                \left(
                   c+s+\tfrac{\log^{(\mu-1)} (c+s)}{\log^{(\mu)}(c+s)}
               \right)
        \right)^{\left(
           c+s+\tfrac{\log^{(\mu-1)} (c+s)}{\log^{(\mu)}(c+s)}
       \right)}
       }
   \]
   Therefore, we can apply induction on each graph $H_{r_1},\ldots,H_{r_m}$ since these graphs satisfy \cref{total-weight-i} with the value $c'=c+s$.
   Consider one particular such graph $H_{r_j}$ and let $v_1',\ldots,v_t'$ denote the vertices of $B_{r_i}$.  The vertices $v_2',\ldots,v_t'$ appear in $H'$ and have already received colours greater than $a(k-c'-1)$.  The vertex $v_1'$ has not been assigned a colour yet and it can receive colour $a(k-c'-1)$.  Applying the inductive hypothesis colours the remaining vertices $V(H_{r_i})\setminus B_{r_i}$ using colours smaller than $a(k-c'-1)$.  Doing this for each of $H_{r_1},\ldots,H_{r_m}$ completes the colouring $\varphi$ to a total colouring of $H$.

   All that remains is to verify that $\varphi$ is a 2-ranking of $H$. To see this, consider any length-2 path $uvw$.  There are a few cases to consider:
   \begin{enumerate}
    \item If $\varphi(u)=\varphi(w) \ge a(k-c'-1)$ then $\{u,w\}\subseteq V(H')$. Either
    \begin{enumerate}
       \item $v\in V(H')$ in which case $\varphi(v)>\varphi(u)$ since $\varphi$ is a 2-ranking of $H'$ (by the application of \weirdref{t-trees}{a}); or
       \item $v\in V(H_{r_i})\setminus V(H')$ for some $i\in\{1,\ldots,m\}$.  This case is not possible.  Since $v\not\in V(H')$, there is no $x\in V(T')$ with $v\in B_x$.  But this implies that both $u$ and $w$ are contained in $B_{r_i}$, so $uw\in E(H')$, so $\varphi(u)\neq\varphi(w)$ since $\varphi$ is a proper colouring of $H'$.
   \end{enumerate}
   \item If $\varphi(u)=\varphi(w) < a(k-c'-1)$ then $u\in V(H_{r_i})\setminus V(H')$ and $w\in V(H_{r_j})\setminus V(H')$.  Either
   \begin{enumerate}
    \item $v\in V(H')$ in which case $\varphi(v)>a(k-c'-1)\ge\varphi(u)$; or
    \item $v\not\in V(H')$ in which case $i=j$ and $v\in V(H_{r_i})$ so $\varphi(v)>\varphi(u)$ (by the application of induction on $H_{r_i}$). \qedhere
    \end{enumerate}
   \end{enumerate}
\end{proof}

The next lemma tells us what to do when we don't necessarily have the slack $s$ available in \cref{t-tree-slack}.  In this case we use the top $O(c)$ colours (which we can only use once) to create the slack needed to apply \cref{t-tree-slack}.

\begin{lem}\label{t-tree-no-slack}
    Let $t,k\in\N$ and $\mu,c\in\R$ with $2\le \mu\le t$ and $\tau(t)\le c\le k-1$; let $H$ be a $\mu$-bounded $(t-1)$-tree; let $t':=\min\{t, |H|\}$; let $v_1,\ldots,v_{|H|}$ be a construction order for $H$ generating a canonical tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$ of $H$ rooted at $r\in V(T)$ with $B_r:=\{v_1,\ldots,v_{t'}\}$; let $\gamma:V(H)\to\{z\in\N: z\ge \tau(t-1)\}$, and let
    \[
        n_r:=\sum_{v\in V(H)\setminus (B_r\setminus\{v_1\})} \frac{\left(\log^{(\mu-1)} k\right)^k}{\left(\log^{(\mu-1)} \gamma(v)\right)^{\gamma(v)}} \enspace .
    \]
    There exists an integer constant $a\ge 1$ such that,
    if
    \begin{equation}
         n_r \le \frac{(\log^{(\mu-1)} k)^k}{(\log^{(\mu-1)} c)^{c}} \enspace ,
     \label{total-weight-ii}
    \end{equation}
    then $H$ has a 2-ranking $\varphi:V(T)\to\{1,\ldots,ak\}$ such that
    \begin{compactenum}[(P1)]
        \item for each $i>a(k-c-1)$, there is at most one $v\in V(H)$ with $\varphi(v)=i$.
        % \item for each $i\in\{1,\ldots,{t'}\}$, $\varphi(v_1)=a(k-c-1)+i-1$; and
        \item for each $v\in V(H)\setminus B_r$, $\varphi(v)> a(k-\gamma(v)-1)$.
    \end{compactenum}
\end{lem}

\begin{proof}
    The proof is by induction on $|H|$. In the base case, $1\le|H|\le t+1$, so $|T|=1$, we set $\varphi(v_i):=ak-i+1$ for each $i\in\{1,\ldots,t'\}$.  This certainly satisfies (P1).  Furthermore, \cref{total-weight-ii} implies that $\gamma(v)\ge c$ for each $v\in V(H)$, so (P2) is satisfied for $a\ge t$.

    Now we may assume that $|H|\ge t+1$, so that $|T|\ge 2$.  For each node $v$ of $T$, define $n_v$ as in the proof of \cref{t-tree-slack}.   We say that a node $v$ of $T$ is \emph{heavy} if
    \[
        n_v> \frac{\left(\log^{(\mu-1)} k\right)^k}{\log^{(\mu-1)}\left(c+\tfrac{\log c}{\log^{(\mu)} c}\right)^{c+\tfrac{\log c}{\log^{(\mu)} c}}} \enspace ,
    \]
    otherwise $v$ is \emph{light}.  For a heavy node $v$,
    \begin{align*}
        \left(\log^{(\mu-1)} k\right)^k/n_v
        & < \left(\log^{(\mu-1)}\left(c+\tfrac{\log c}{\log^{(\mu)} c}\right)\right)^{c+\tfrac{\log c}{\log^{(\mu)} c}} \\
        & = \left(\log^{(\mu-1)}c\right)^{\left(c+\tfrac{\log c}{\log^{(\mu)} c}\right)
        \left(\tfrac{\log^{(\mu)}\left(c+\log c/\log^{(\mu)} c\right)}{\log^{(\mu)} c}\right)} &\text{(change of base)} \\
        & = \left(\log^{(\mu-1)}c\right)^{\left(c+\tfrac{\log c}{\log^{(\mu)} c}\right)
        \left(
        1 + \tfrac{(\log e)^t\log c/\log^{(\mu)} c}{\prod_{j=0}^{\mu}\log^{(j)}c}
        \right)} & \text{(by \cref{logi-ratio})} \\
        & = \left(\log^{(\mu-1)}c\right)^{\left(c+\tfrac{\log c}{\log^{(\mu)} c}\right)
        \left(
        1 + \tfrac{(\log e)^t}{c\cdot\left(\prod_{j=2}^{\mu-1}\log^{(j)}c\right)\cdot(\log^{(\mu)} c)^2}
        \right)} & \text{(for $\mu\ge 2$)} \\
        & \le \left(\log^{(\mu-1)}c\right)^{\left(c+\tfrac{\log c}{\log^{(\mu)} c}\right)
        \left(
        1 + \tfrac{(\log e)^t}{c\cdot(\log^{(\mu)} c)^2}
        \right)} & \text{($c\ge \tau(\mu)$, so $\prod_{j=2}^{\mu-1}\log^{(j)}c\ge 1$)} \\
        & = \left(\log^{(\mu-1)}c\right)^{\left(c+\tfrac{\log c}{\log^{(\mu)} c}+
        \tfrac{(\log e)^t}{(\log^{(\mu)} c)^2} + \tfrac{(\log e)^t\log c}{c\cdot(\log^{(\mu)} c)^3}
        \right)}  \\
        & = \left(\log^{(\mu-1)}c\right)^{\left(c+\tfrac{\log c}{\log^{(\mu)} c}
          + o_c\left(\tfrac{1}{\log^{(\mu)} c}\right)
        \right)}  \\
        & = \left(\log^{(\mu-1)}c\right)^c \cdot c\cdot (1+o_c(1))  \numberthis \label{heavy-size}
    \end{align*}

    Let $T'$ be the subtree of $T$ induced by its heavy nodes.  We say that a node of $T'$ is \emph{special} if it is a leaf of $T'$ or it is a branching node of $T'$ and we let $S$ denote the set of branching nodes.  Together, \cref{heavy-size} and \cref{total-weight-ii} imply that the number of leaves of $T'$ is at most $(1+o(1))c$.  In any tree with $\ell$ leaves, the number of branching nodes is at most $\ell-1$.  Therefore the number of special nodes of $T'$ is $|S|\le (2+o(1))c$.

    Let $H'=H[\bigcup_{x\in V(T')} B_x]$ and observe that $(B_x:x\in V(T'))$ is a width-$(t-1)$ tree decomposition of $H'$.  We can obtain a 2-ranking of $H'$ as follows: (this is similar to the proof of \cref{skeleton-colour}):  Let $B:=\bigcup_{x\in S} B_x$ and assign each vertex  $v\in B$ a distinct colour $\varphi(v)\in\{\lfloor a(k-c-1)\rfloor+1,\ldots,ak\}$.  This clearly produces a 2-ranking of the graph $H'[B]$.

    Next, consider the as-yet-uncoloured vertex set $U:=V(H')\setminus B$. The sequence $(B_x:x\in V(T'-S))$ is a width-$(t-1)$ $(T'-S)$-decomposition of $H'[U]=H[U]$. The graph $T'-S$ is a collection of disjoint paths, therefore $\pw(H')\le t-1$. Therefore, by \cref{pathwidth} $H'[U]$ has a 2-ranking $\varphi:U\to \{a(k-c-2)+\lceil a/2\rceil,\ldots,\lfloor a(k-c-1)\rfloor\}$, provided that $a/2\ge 3t-2$.  It is straightforward to check that the colouring $\varphi$ produced this way is a 2-ranking of the entire graph $H'$.

    This gives a colouring $\varphi$ of $H'$ that certainly satisfies (P1).  To see that it also satisfies (P2), observe that, since $|V(T)|\ge 2$, the sum in \cref{total-weight-ii} has at least two terms, which implies that $\gamma(v) > c$ for all $v\in V(H)$. Since $\gamma$ is integer valued, this means that $\gamma(v)\ge c+1$.  Therefore, for each $v\in V(T')$, $\varphi(v)\ge a(k-c-2)+a/2 \ge a(k-c-2)+1\ge a(k-\gamma(v)-1)+1$ so that $\varphi$ satisfies (P2).

    We are now left with the problem of extending the colouring $\varphi$ of $H'$ to a colouring of $H$.  The forest $T-T'$ contains trees $T_1,\ldots,T_m$ with roots $r_1,\ldots,r_m$, respectively.  For each $i\in\{1,\ldots,m\}$, $r_i$ is a light node, so
    \[
        n_{r_i} \le \frac{(\log^{(\mu-1)} k)^k}{\left(\log^{(\mu-1)}\left(c + \frac{\log c}{\log^{(\mu)} c}\right)\right)^{c+\frac{\log c}{\log^{(\mu)} c}}}
        = \frac{(\log k)^k}{\left(\log\left(c + s\right)\right)^{c+s}}
    \]
    with $s$ defined as in the statement of \cref{t-tree-slack}.
    Now we can apply \cref{t-tree-slack} to the graph $H_{i}:=H[\bigcup_{x\in V(T_{i})} B_x]$.  This produces a colouring $\varphi:V(H_i)\to\{1,\ldots,a(k-c-s)\}\cup \bigcup_{v\in B_{r_i}}\varphi(v)$ in which the colours of vertices in $B_{r_i}$ are unchanged and are all at least $a(k-c-s)+a/2$ and the colour of each vertex $v\in V(H_i)\setminus B_{r_i}$ is $\varphi(v)<a(k-c-s)+a/2$.  Therefore, (P2) is satisified.  The colours assigned to vertices in $H_i-B_{r_i}$ by \cref{t-tree-slack} satisfy (P1).
    The proof that this produces a valid 2-ranking of $H$ is exactly as in the proof of \cref{t-tree-slack}.
\end{proof}



% We say that a path $xyz$ in $H$ is \emph{BFS-humped} if $x,z\in L_i$ and $y\in L_{i-1}$ for some $i\in\{1,\ldots,m\}$.  A colouring $\varphi:V(H)\to\{1,\ldots,k\}$ is a \emph{BFS-humped 2-ranking} if $\max\{\varphi(x),\varphi(y),\varphi(z)\}$ is unique for each BFS-humped path $xyz$ in $H$.



\begin{lem}\label{two-tree-technical}
    For every fixed positive integer $t$ and every $2\le\mu\le t$, there exists constants $q,a>0$ such that, for every integer $k\ge \tau(t)$, every $n\le (\log^{(\mu-1)} k)^{k-q}$, and every $n$-vertex BFS-$\mu$-bounded $t$-tree $H$, $\uqs(H)\le ak$.
\end{lem}

\begin{proof}
    Assume $n\ge t+1$, otherwise the result obtained trivially for any $a\ge t+1$ by colouring each vertex of $H$ with a distinct colour.

    % When a BFS layering $L_0,\ldots,L_m$ of $H$ is given, we use the notations $H_i=H[L_i]$, and $H_{\ge i}=H[\bigcup_{j=i}^m L_i]$.  When $H$ is a $t$-tree and $L_0=\{v_1,\ldots,v_t\}$ is a $t$-clique in $H$, each component of $H_i$ is a $(t-1)$-tree.  It is helpful to think of $H_{\ge i}$ as a union of overlapping $t$-trees, each of which is rooted at a $t$-clique in $H_i$. In this way, $H_i$ is a $(t-1)$-forest with $t$-trees hanging off its $t$-cliques.

    % For each $t$-clique $C$ in $H_i$, we use $H_C$ to denote the connected component of $H[C\cup\bigcup_{j=i+1}^m L_j]$ that contains $C$.  If $v_1,\ldots,v_n$ is a construction order for $H$ then for any component $H'$ of $L_i$, the subsequence $v_{i_1},\ldots,v_{i_{|H'|}}$ of $v_1,\ldots,v_n$ containing only those vertices in $V(H')$ is a construction order for $H'$.  In this way, each vertex $v_{i_j}$, has a naturally defined parent clique in $H'$ which is a subset of its parent clique in $H$.


    Let $v_1,\ldots,v_n$ be a construction order for $H$ and let $L_0,\ldots,L_m$ be a BFS layering of $H$ with $L_0=\{v_1,\ldots,v_{t+1}\}$.
    For each $v\in V(H)$, let $\ell(v)$ be such that $v\in L_{\ell(v)}$.
    For each $t$-clique $C$ in $H_i$, we use $H_C$ to denote the connected component of $H[C\cup\bigcup_{j=i+1}^m L_j]$ that contains $C$.
    % For each $i\in\{1,\ldots,m\}$ and each edge $vw\in E(H_i)$, recall that $H_{vw}$ is the component of $H[\{v,w\}\cup\bigcup_{j=i+1}^m L_i]$ that contains $vw$.

    For each vertex $v\in L_i$, let $N_i(v)$ denote the set of $t$-cliques in $H[L_i]$ that contain $v$ and let
    \begin{equation}
        n_v=\sum_{C\in N_i(v)}|H_{C}| \enspace . \label{nv}
    \end{equation}
    In words, $n_v$ counts the sizes of all the $t$-trees hanging off all the $t$-cliques of $H_i$ that contain $v$.

    \begin{clm}\label{size-claim}
        For each $i\in\{1,\ldots,m\}$ and each component $H'$ of $H[\bigcup_{j=i}^m L_j]$, $|H'|\le \sum_{v\in H'[L_i]} n_v \le t^2|H'|$.
    \end{clm}

    \begin{proof}[Proof of \cref{size-claim}]
        The lower bound on the sum is trivial since each vertex of $H'$ is counted at least once.

        Each vertex $w\in V(H'[L_{i+1}\cup\cdots\cup L_{i+m}])$ appears in $H_C$ for exactly one $t$-clique $C$ in $H_i$, so $w$ is counted exactly $t$ times---as part of $n_v$ for each $v\in C$. Therefore the contribution of vertices in $H'[L_{i+1}\cup\cdots\cup L_{i+m}]$ to the sum is exactly $t|H'[L_{i+1}\cup\cdots\cup L_{i+m}]|\le t^2|H'[L_{i+1}\cup\cdots\cup L_{i+m}]|$

        Each of the $t$ vertices of each $t$-clique $C$ of $H'[L_i]$ are counted $t$ times---once as part of $n_v$ for each vertex in $v\in C$. Therefore the contribution of vertices in $L_i$ to the sum is $t^2$ times the number of $t$-cliques in $H'[L_i]$.  But $H_i$ is a $(t-1)$-tree with $|H'[L_i]|$ vertices.  It is well known, and not hard to show, that the number of $t$-cliques in an $n$-vertex $(t-1)$-tree is $\max\{0,n-t+1\}\le n$. Therefore the contribution of vertices in $H'[L_i]$ to the sum is at most $t^2|H'[L_i]|$.

        Therefore
        \[
            \sum_{v\in H'[L_i]} n_v \le t^2|H'[L_i]| + t^2|H'[L_{i+1}\cup\cdots\cup L_{i+m}]| = t^2|H'| \enspace . \qedhere
        \]
    \end{proof}

Our proof is based on the following claim:

    \begin{clm}\label{main-claim}
        Let $H'$ be the union of one or more connected component of $H[\bigcup_{j=i}^m L_i]$. There exists a constant $q$ such that,  if
        \begin{equation}
            \sum_{v\in V(H'[L_i])} n_v\le \frac{(\log^{(\mu-1)} k)^{k-q}}{(\log^{(\mu-1)} c)^c} \enspace , \label{main-size}
        \end{equation}
        then there exists $\varphi:V(H')\to\{1,\ldots,ak\}$ and $\psi:V(H')\to\{0,\ldots,t-1\}$ such that
        \begin{compactenum}[(P1)]
            \item The function $\theta:V(H')\to\{1,\ldots,2tak\}$ defined by $\theta(v)=2t\varphi(v) - 2\psi(v) -(\ell(v)\bmod 2)$ is a humped 2-ranking of $H'$;
            \item for each $v\in V(H'[L_i])$, $\psi(v)=0$;
            \item for each $\iota\in\{a(k-c-1)+1,\ldots,ak\}$ there is at most one vertex $v$ in $V(H'[L_i])$ with $\varphi(v)=\iota$.
        \end{compactenum}
    \end{clm}

    \begin{proof}[Proof of \cref{main-claim}]
        In all cases, (P2) requires setting $\psi(v)=0$ for all $v\in V(H'[L_i])$, so we do this now and will not mention it again.

        The proof is by induction on $m-i$. In the base case $m-i=0$ and $H'$ is a $(t-1)$-forest.
        To handle this case, we set $\gamma(v):=k$ for each $v\in V(H')$.  Then
        \begin{align*}
            \sum_{v\in V(H')} \frac{(\log^{(\mu-1)} k)^k}{(\log^{(\mu-1)} \gamma(v))^{\gamma(v)}}
            & = \sum_{v\in V(H')} 1 \\
            & = |H'| \\
            & \le \sum_{v\in V(H'[L_i])} n_v  & \text{(by \cref{size-claim})}\\
            & \le \frac{(\log^{(\mu-1)} k)^{k-q}}{(\log^{(\mu-1)} c)^c} & \text{(by \cref{main-size})}\\
            & \le \frac{(\log^{(\mu-1)} k)^{k}}{(\log^{\mu-1} c)^c} \enspace .
        \end{align*}
        Since $H$ is BFS-$\mu$-bounded, $H[L_i]$ is $\mu$-bounded, so
        Applying \cref{t-tree-no-slack} then gives a colouring $\varphi: V(H')\to\{1,\ldots,ak\}$ that satisfies (P1)--(P3).

        In the general case, we set $\gamma(v):=\max\{c\in\N:(\log^{(\mu-1)} k)^k/(\log^{(\mu-1)} c)^c \ge n_v\}$ for each $v\in V(H'[L_i])$.  This implies that
        \[
            \frac{(\log^{(\mu-1)} k)^k}{(\log^{(\mu-1)}(\gamma(v)+1))^{\gamma(v)+1}} < n_v
        \]
        Since $\gamma(v)+1\le k$ [TODO: Explain!],
        \[
           n_v > \frac{(\log^{(\mu-1)} k)^k}{(\log^{(\mu-1)}(\gamma(v)+1))^{\gamma(v)+1}}
           = \frac{(\log^{(\mu-1)} k)^{k-1}}{(\log^{(\mu-1)}(\gamma(v)+1))^{\gamma(v)}}
            \cdot
            \frac{\log^{(\mu-1)} k}{\log^{(\mu-1)}(\gamma(v)+1)}
           \ge
           \frac{(\log^{(\mu-1)} k)^{k-1}}{(\log^{(\mu-1)}\gamma(v))^{\gamma(v)}}
       \]
       Therefore,
       \[
           \sum_{v\in H'[L_i]} \frac{(\log^{(\mu-1)} k)^k}{(\log^{(\mu-1)} \gamma(v))^{\gamma(v)}} < \sum_{v\in H'[L_i]} n_v(\log k)
           \le \frac{(\log^{(\mu-1)} k)^{k-q+1}}{(\log^{(\mu-1)} c)^c}
           \le \frac{(\log^{(\mu-1)} k)^k}{(\log^{(\mu-1)} c)^c}
       \]
       for $q\ge 1$.  This satisfies the requirements for \cref{t-tree-no-slack}, so we can find a 2-ranking $\varphi$ of the $(t-1)$-forest $H'[L_i]$ that satisfies (P3) and satisfies (P1), at least for the graph $H'[L_i]$. In addition $\varphi(v)> a(k-c-\gamma(v)-1)$ for each $v\in V(H'[L_i])$.  It remains to show that we can extend $\varphi$ to a complete colouring of $H'$.

       Recall that $v_1,\ldots,v_n$ is a construction order for $H$. For each vertex $w$ in $H'[L_{i+1}]$ we define the $i$-parent $p(w)$ of $w$ to be the vertex $v_j\in H'[L_i]$ such that $wv_j\in E(H')$ and $j$ is minimized.  That is, $v_j$ is the first vertex in $w$'s parent clique that appears in the construction order.  For each vertex $v$ in $H'[L_i]$ we define $D_v:=\{w\in H'[L_{i+1}]: p(w)=v\}$.

       For each $v\in V(H'[L_i])$, define the graph $H_v$ to be the component of $H'[D_v\cup \bigcup_{j=i+2}^m L_j]$ that contains $D_v$.
       Now, $H_v[L_{i+1}]$ is a rooted $(t-1)$-forest with roots $r_1,\ldots,r_d$.  We apply the inductive hypothesis to $H_v$ and we obtain $\varphi:V(H_v)\to\{1,\ldots,ak\}$ and $\psi:V(H_w)\to\{0,1\}$ that satisfy the conditions of the claim.  We do this to colour $H_v$ for each $v\in V(H'[L_i])$.

       \begin{figure}
           \begin{center}
                \includegraphics{figs/subproblems}
           \end{center}
           \caption{The definition of the set $D_w$, that determines $H_w$.}
           \label{subproblems}
       \end{figure}

       At this point colourings $\varphi:V(H')\to\{1,\ldots,ak\}$ and $\psi:V(H')\to\{0,1\}$ are completely defined.  We must, however, make one small modification to $\psi$.  Since each vertex in $H'[L_{i+1}]$ is coloured by induction on some graph $H_v$, $\psi(w)=0$ for each $w\in V(H'[L_{i+1}])$.  Now, the graph $H'[L_i]$ is a $(t-1)$-forest and therefore has a proper $t$-colouring $\zeta:V(H'[L_i])\to\{0,\ldots,t-1\}$.  For each vertex $w$ in $H'[L_{i+1}]$ we set $\psi(w):=\zeta(p(w))$.  This completes the description of the colourings $\varphi$ and $\psi$.

       We have already ensured that $\varphi$ and $\psi$ satisfy (P2) and (P3). All that remains is to ensure that they satisfy (P1).  To do this, consider some humped path $xyz$ in $H'$.  There are a few cases to consider:
       \begin{compactenum}
          \item If $xyz$ is completely contained in the forest $H'[L_i]$ then this path is properly coloured because \cref{t-tree-no-slack} produces a 2-ranking $\varphi$ of $H'[L_i]$.
          \item If $xyz$ is completely contained in $H_v$ for some $v\in H'[L_i]$ then the inductive hypothesis already ensures that $\theta$ was already a humped 2-ranking of $H_w$ and the subsequent modifications to $\psi(v)$ for $v\in H_w[L_{i+1}]$ do not change this. In fact, these modifications do not change the relative order of $\theta(x)$ and $\theta(y)$ or the relative order of $\theta(y)$ and $\theta(z)$.
          \item If $x,y\in L_i$ and $z\in L_{i+1}$ then $\ell(x)\bmod 2\neq\ell(z)\bmod 2$ so $\theta(x)\neq\theta(z)$.
          \item The only case that remains is when $x\in V(H_{v})$, $y\in V(H'[L_i])$ and $z\in V(H_w)$ for some $v\neq w$. Refer to \cref{proper}.  In this case, the vertices $x$ and $z$ did not appear in the same application of induction so it is possible that $\varphi(x)=\varphi(z)=\phi$ for some value $\phi>\varphi(y)$.

          Since $xy\in E(H)$, $yz\in E(H)$ and $xz\not\in E(H)$, the tree node
          $x_T(y)$ is a common ancestor of $x_T(x)$ and $x_T(z)$.  This means that each of $x_T(p(x))$ and $x_T(p(z))$ are $T$-ancestors of $x_T(y)$  is a $T$-ancestor $x_T(y)$. Therefore $\{p(x),p(y)\}\subseteq B_{x_T(y)}$, so $p(x)p(z)\in H'[L_i]$, so $\psi(x)=\zeta(p(x))\neq\zeta(p(z))=\psi(z)$ since $\zeta$ is a proper colouring of $H'[L_i]$.
      \end{compactenum}
      This completes the proof of \cref{main-claim}.
       \begin{figure}
           \begin{center}
            \includegraphics{figs/proper}
            \end{center}
           \caption{$\psi(x)\neq\psi(z)$ ensures that $\theta(x)\neq \theta(z)$ in the humped path $xyz$ with $x\in H_x$}
           \label{proper}
       \end{figure}
    \end{proof}
    Finally, to complete the proof of \cref{two-tree-technical} we apply \cref{main-claim} with $i=0$ and $H'=H$.  By \cref{size-claim} we can do this with any value $k$ such that $t^2n \le (\log k)^{k-q}$ to show that $\hus(H)\le 2ta'k$ for some constant $a'$.  By \cref{humped}, this implies that $\uqs(H)\le 3\hus(H)\le ak$, for $a=6ta'$.
\end{proof}

Rewriting \cref{two-tree-technical} in terms of $n$ yields the following result:

\begin{thm}\label{mu-bounded}
    For every fixed integer $t\ge 1$, every $2\le\mu\le t$, and every $n$-vertex BFS-$\mu$-bounded $t$-tree $H$, $\uqs(H)\in O(\log n/\log^{(\mu)} n)$.
\end{thm}

By \cref{trees}, forests are $2$-bounded and therefore 2-trees are BFS-2-bounded.  Therefore \cref{mu-bounded} implies \weirdref{t-trees}{a} for $t=2$, i.e, that $2$-trees are $3$-bounded.  Induction on $t$ then proves \weirdref{t-trees}{a} for all $t\ge 1$.


\subsection{Planar 3-Trees}
\seclabel{planar}

To complete the upper bound in \cref{planar},  all that remains is to prove the upper upper in \cref{three-trees} on the number of colours required by $2$-rankings of $n$-vertex planar $3$-trees. To do this, we make use of the following observation:

\begin{obs}\label{outerplanar-layers}
    Let $H$ be a planar 3-tree and let $L_0,\ldots,L_m$ be a BFS layering of $H$ where $L_0:=\{v_1,\ldots,v_4\}$ is a clique in $H$.  Then, for each $i\in\{1,\ldots,m\}$, $H[L_i]$ is outerplanar.
\end{obs}

We prove the following optimal result for outerplanar graphs:

\begin{thm}\label{outerplanar}
    For every $n$-vertex outerplanar graph $G$, $\uqs(G)\in O(\log n/\log^{(2)} n)$.
\end{thm}

Before proving \cref{outerplanar} we show how it completes the proof of the upper bound in \cref{three-trees}.  Since outerplanarity is preserved under taking minors, \cref{outerplanar,outerplanar-layers} imply that every planar 3-tree is BFS-$2$-bounded.  The upper bound in \cref{three-trees} then follows from \cref{mu-bounded}.

% [TODO: Question: Is there a product structure theorem for outerplanar graphs?  Maybe $G\subseteq T\boxtimes P$ where $P$]
\begin{lem}\label{outerplanar-technical}
    Let $c,k$ be positive integers with $0\le c < k$, Let $G$ be an edge-maximal outerplane graph with outer face $F=v_1,\ldots,v_n$ and $3\le n:=|G|\le k!/c!-2$. Then, for any distinct $\phi_1,\phi_2,\phi_3\in\{a(k-c-1)+1,\ldots,ak\}$, there exists a weak 2-ranking $\varphi:V(G)\to\{1,\ldots,k\}$ such that $\varphi(v_i)=\phi_i$ for each $i\in\{1,2,3\}$.
\end{lem}

\begin{proof}
    The proof is by induction on $n:=|G|$. The base case $n=3$ is trivial since, for any $a\ge 3$ we can colour the vertices of $G$ with the three colours $\phi_1$, $\phi_2$, and $\phi_3$.

    For $n\ge 3$, let $w_1,\ldots,w_d$ denote the neighbours of $v_2$ in cyclic order, ordered so that $w_1=v_1$ and $w_d=v_3$. Then $w_1,\ldots,w_d$ is a path in $G$.  Consider the subgraph $X$ of $G$ induced by every vertex of every inner face of $G$ that is bounded by $w_iw_{i+1}$ for some $i\in\{1,\ldots,d-1\}$.

    More formally, for each $i\in\{1,\ldots,d-1\}$, let
    $Z_i$ denote the set of vertices $v$ such that $v\neq v_2$ and $vw_iw_{i+1}$ is an inner face of $G$. Observe that $|Z_i|\le 1$ since there are at most two faces bounded by $w_iw_{i+1}$ and one of these is $v_2w_iw_{i+1}$.  Then $X=G[v_2,w_1,\ldots,w_{d}\cup\bigcup_{j=1}^{i-1} Z_i]$.  We claim that $\pw(X)\le 3$.  Indeed, consider the path decomposition $(B_x:x\in P)$ where $P:=1,\ldots,d-1$ and, for each $x\in\{1,\ldots,d-1\}$, $B_x:=\{v_2,w_i,w_{i+1}\}\cup Z_i$.  Each bag $B_x$ in this path decomposition has size 4 or less.

    For convenience, define $Z_0:=Z_{d+1}:=\emptyset$.  Fix some $i\in\{1,\ldots,d\}$ and consider the graph $G-\{w_{i}\}-Z_{i-1}-Z_i$.  This graph has a component $C$ that contains $v_2$ and (possibly) other components $C_1,\ldots,C_m$.  Let $G_i:=G[w_i\cup Z_{i-1}\cup Z_i\bigcup_{j=1}^m V(C_j)]$.  We say that $G_i$ is \emph{heavy} if $|G_i|-2 > k!/(c+1)!$ and let $I\subseteq\{1,\ldots,d\}$ consist of all $i$ for which $G_i$ is heavy.  Observe that $\sum_{i=1}^{d}(|G_i|-2)\le |G|-2$.  Therefore, $|I|< c+1$ so $|I|\le c$.

    Let $Q=\bigcup_{i\in I}\left(Z_i\cup\{w_{i},w_{i+1}\}\right)$ be the set of vertices that bound heavy subgraph.  Now, $|Q|\le 3|I|\le 3c$.  Therefore, each vertex $v\in Q$ can be assigned a distinct colour $\varphi(v)\in\{a(k-c-1)+1,\ldots,ak\}\setminus\{\phi_1,\phi_2,\phi_3\}$, provided that $a(c+1)-3\ge 3c$ which is satisfied for $a\ge 3$.

    Since $\pw(X)\le 3$, $\pw(X-Q)$ has pathwidth 3. Therefore, by \cref{pathwidth} $X-Q$ has a 2-ranking $\varphi:V(X-Q)\to\{a(k-c-2)+1,\ldots,a(k-c-1)\}$ provided that $a \ge 10\ge 3\pw(X-Q)+1$.  We can then apply induction to complete the colouring for each graph $G_i$.
\end{proof}

% The proof of \cref{outerplanar} is obtained by combining \cref{trees} with the following product structure theorem for outerplanar graphs:
%
% \begin{thm}\label{product-structure-outerplanar}
%     For every $n$-vertex outerplanar graph $G$, there exists an at most $n$-vertex tree $T$ and a path $P$ of length at most $n-1$ such that $G$ is isomorphic to a subgraph of $T\boxtimes P$.
% \end{thm}
%
% \begin{proof}
%
% \end{proof}


\begin{proof}[Proof of \cref{outerplanar}]
    We apply \cref{outerplanar-technical} to obtain a weak 2-ranking of $G$ with respect to the layering $L_0,\ldots,L_m$ and then triple the number of colours to obtain a 2-ranking. 
    % This is an immediate consequence of \cref{product-structure-outerplanar,product-colouring,trees}.
\end{proof}

%
%     This is the proof we've been discussing with Mehrnoosh. It uses the fact that the neighbourhood of a vertex in an outerplanar graph has bounded pathwidth.
% \end{proof}

\section{Lower Bounds}
\label{lower-bounds}

Next we prove the lower bound in \cref{t-trees} which implies the lower bounds in \cref{planar,three-trees}.

\begin{lem}\label{apex-graph}
    Let $h,k\ge 1$ be integers, let $U$ be a graph with $\uqs(U)\ge h$ and let $G$ be a graph obtained by taking $k+1$ disjoint copies $U_0,\ldots,U_k$ of $U$ and adding an apex vertex $a$ adjacent to each $v\in\bigcup_{i=0}^k V(U_i)$.  Then, for any integer $k_0\in \{1,\ldots,k\}$ and any 2-ranking of $\varphi:V(G)\to\{k_0,\ldots,k\}$, $\varphi(a) \ge k_0+1$.
\end{lem}

\begin{proof}
    Since $\uqs(U_i)\ge h$, there exists $v_i\in V(U_i)$ such that $\varphi(v_i)\ge h$, for each $i\in\{0,\ldots,k\}$.  Since $|\{0,\ldots,k\}=k+1>k-k_0+1=|\{k_0,\ldots,k\}|$ the Pigeonhole Principle implies that there exists distinct $i,j\in\{0,\ldots,k\}$ such that $\varphi(v_i)=\varphi(v_j)$.  Since $v_i a v_j$ is a path in $G$, this implies that $\varphi(a)\ge \varphi(v_i)+1\ge h+1$.
\end{proof}

For a graph $U$ with and integers $h,\ell\ge 0$, we define the $(h,\ell)$-boost $U^{(h,\ell)}$ of $U$ as follows: The vertex set of $U^{(h,\ell)}$ is the disjoint union of $L_0,\ldots,L_\ell$.  The set $L_0:=\{a_0\}$ consists of a single vertex. For each $i\in\{1,\ldots,\ell\}$ and each $a\in L_{i-1}$, $U^{(h,\ell)}$ contains $h\ell+1$ disjoint copies $U_{a,0},\ldots,U_{a,h\ell}$ of $U$ and contains the edge $av$ for each $v\in\bigcup_{j=0}^{h\ell} V(U_j)$.  This determines the set $L_i=\bigcup_{a\in L_{i-1}}\bigcup_{j=0}^{h\ell} V(U_{a,j})$.

\begin{lem}\label{boost}
    For any graph $U$, any integer $\ell\ge 0$, and any $h\ge\uqs(U)$, $\uqs(U^{(h,\ell)})\ge h\ell +1$.
\end{lem}

\begin{proof}
    Suppose, for the sake of contradiction, that $\uqs(U^{(h,\ell)})=k<h\ell+1$ and let $\varphi:V(U^{(h,\ell)})\to\{1,\ldots,k\}$ be a 2-ranking of $U_{(h,\ell)}$.  Let $L_0,\ldots,L_{\ell}$ be the partition of $V(U^{(h,\ell)})$ used in the definition of $V(U^{(h,\ell)})$.
    % (Alternatively, $L_0,\ldots,L_{\ell}$ are the breadth-first-search layers of $U^{(h,\ell)}$ rooted at $a_0$.)
    We will show by induction on $\ell-i$ that, for each $a\in L_{i}$, $\varphi(a)\ge(\ell-i)h+1$. This gives the desired contradiction since it implies that, for the unique vertex $a_0\in L_0$, $\varphi(a_0)\ge \ell h+1 > k$.

    The base case of the induction, $\ell-i=0$, is trivial; it simply asserts that $\varphi(v)\ge 1$ for each $v\in L_\ell$.  For any $i\in\{0,\ldots,\ell-1\}$ we apply the inductive hypothesis to conclude that $\varphi(v)\in\{(\ell-i-1)h+1,\ldots,k\}$ for each $v\in L_{i+1}$.  For each $a\in L_i$, the subgraph of $U^{(h,\ell)}$ induced by $a$ and its neighbours in $L_{i+1}$ contains the graph described in \cref{apex-graph} with $k_0:=(\ell-i-1)h+1$.  The conclusion of \cref{apex-graph} therefore implies that $\varphi(a)\ge k_0+h=(\ell-i)h+1$, as required.
\end{proof}

\begin{lem}\label{boost-size}
    For any graph $U$ and any integers $h,\ell \ge 1$, $|U^{(h,\ell)}| \le (|U|(h\ell))^{\ell}\cdot (1+O((|U|h\ell)^{-1})$.
\end{lem}

\begin{proof}
    It is easy to see that, for each $i\in \{0,\ldots,\ell\}$, $|L_i|=(|U|(h\ell+1))^i$.  Therefore,
    \[ |U^{h,\ell}| = \sum_{i=0}^\ell |L_i| = \sum_{i=0}^\ell (|U|(h\ell+1))^i = (|U|(h\ell))^{\ell}\cdot (1+O((|U|h\ell)^{-1}) \enspace . \qedhere
    \]
\end{proof}


\begin{lem}\label{boost-treewidth}
    For any graph $U$ and any integers $h,\ell\ge$, $\tw(U^{(h,\ell)})\le \tw(U)+1$.
\end{lem}

\begin{proof}
  Create a width-$(\tw(U)+1)$ tree-decomposition $(B_x:x\in V(T))$ of $U^{(h,\ell)}$ as follows: Start with $T$ having a single node $z_0$ with $B_{z_0}=L_0$.  For each $i\in\{1,\ldots,\ell\}$, and each $a\in L_{i-1}$, find some bag $B_z$ in the current decomposition that contains $a$, take $h+1$ disjoint copies $(A_x:x\in V(T_0)),\ldots,(A_x:x\in V(T_h))$ of some width-$t$ tree decomposition $\mathcal{T}$ of $U$.  For each $i\in\{0,\ldots,h\}$, add an edge from $z$ to any node of the tree in $T_i$ and add $a$ to every bag in $T_i$.  It is straightforward to verify that this does, indeed, give a width-$\tw(U)+1$ tree-decomposition of $U^{(h,\ell)}$.
\end{proof}


\begin{thm}\label{treewidth-lower-bound}
    For each integer $t\ge 0$, there exists $\alpha,\beta>0$
    such that, for each integer $\ell\ge 2^{2^{2^{\ddots}}}$, there exists a graph $G$, with $|G|\le (\log^{(t-1)}\ell)^{\alpha\ell}$, $\tw(G)\le t$, and $\uqs(G)\ge (\beta\ell\log\ell)/\log^{(t)}(\ell\log\ell)$.
\end{thm}

\begin{proof}
    The case $t=0$ is trivial; For every $n\ge 1$, taking $G$ to be an $\ell^\ell$-vertex graph with no edges gives a graph with $\tw(G)=0$ and
    \[
        \uqs(G)=1=\frac{\ell\log \ell}{\ell\log\ell} = \frac{(\ell\log \ell)}{\log^{(0)}(\ell\log\ell)} \enspace .
    \]
    This establishes the result for $t=0$ with $\alpha=\beta=1$.

    The remainder of the proof is by induction on $t$.  The base case $t=1$ has already been established by \citet{karpas.neiman.ea:on} who show that the complete $(\ell+1)$-ary tree $T$ of height $\ell-1$ has $\uqs(T)\ge \ell$.  The tree $T$ has size $\sum_{i=0}^{\ell-1} (\ell+1)^i \le \ell^\ell$.
    Observe that
    \[
        \uqs(T) \ge \ell = \frac{\ell\log\ell}{\log\ell} \ge \frac{\ell\log\ell}{\log(\ell\log\ell)} = \frac{\ell \log \ell}{\log^{(1)}(\ell\log\ell)}
    \]
    This establishes the result for $t=1$ with the constant $\alpha=\beta=1$.

    For $t>1$ we can apply the inductive hypothesis to obtain a graph $U$, with $\tw(U)\le t-1$, $|U|=(\log^{(t-2)}m)^{\alpha'm}$ and $\uqs(U)\ge \beta' m\log m/\log^{(t-1)}(m\log m)=:h$.
    We do this with the value $m:=\log^{(2)}(\ell^\ell)/\log^{(t+1)}(\ell^\ell)=\log (\ell\log\ell)/(\log^{(t)}(\ell\log\ell))$.  Now we take the graph $G:=U^{(h,\ell)}$.  By \cref{boost-treewidth}, $\tw(U^{(h,\ell)})\le \tw(U)+1\le t$.  By \cref{boost},
    \begin{align*}
       \uqs(G) & \ge \ell h+1 > \ell h\\
               & = \frac{\ell \beta' m\log m}{\log^{(t-1)}(m\log m)} \\
               & = \left(\beta'\ell m\right)\left(\frac{\log m}{\log^{(t-1)}(m\log m)}\right) \\
               & = \left(\frac{\beta'\ell \log(\ell\log\ell)}{\log^{(t)}(\ell\log\ell)}\right)\left(\frac{\log m}{\log^{(t-1)}(m\log m)}\right) \\
               & \ge \left(\frac{\beta'\ell \log\ell}{\log^{(t)}(\ell\log\ell)}\right) \left(\frac{\log m}{\log^{(t-1)}(m\log m)}\right) \\
               & \ge \frac{(\beta'/2)\ell \log\ell}{\log^{(t)}(\ell\log\ell)}
   \end{align*}
   where the final inequality holds for all $t\ge 2$ and $m\ge 1$ (which holds for all $\ell\ge 2$).

   By \cref{boost-size}, the size of $G$ is given by
   \begin{align*}
        |G| & \le \gamma\cdot \left((\log^{(t-2)}m)^{\alpha' m}\ell h\right)^\ell \\
        & = \gamma ((\log^{(t-2)}m)^{\alpha'\ell m}) (\ell^\ell) (h^\ell) \\
        & = \gamma \left(\log^{(t-2)}\left(\frac{\log(\ell\log\ell)}{\log^{(t)}(\ell\log\ell)}\right)\right)
        ^{\frac{\alpha'\ell\log(\ell\log\ell)}{\log^{(t)}(\ell\log\ell)}} \cdot (\ell^\ell) (h^\ell) \\
        & \le \gamma \left(\log^{(t-2)}(\log(\ell\log\ell))\right)
        ^{\frac{\alpha'\ell\log(\ell\log\ell)}{\log^{(t)}(\ell\log\ell)}} \cdot (\ell^\ell) (h^\ell) \\
        & = \gamma \left(\log^{(t-1)}(\ell\log\ell)\right)
        ^{\frac{\alpha'\ell\log(\ell\log\ell)}{\log^{(t)}(\ell\log\ell)}} \cdot (\ell^\ell) (h^\ell) \\
        & = \gamma (\ell\log\ell)^{\alpha'\ell} (\ell^\ell) (h^\ell) \\
        & = \ell^{(\alpha'+1)\ell + \frac{\ell\log h + \ell\log\log\ell \log\gamma}{\log\ell}} \\
        & = \ell^{(\alpha'+4)\ell}
   \end{align*}
   for all sufficiently large $\ell$.
\end{proof}

Rewriting \cref{treewidth-lower-bound} in terms of $n:=|G|$, we obtain a more-readily digestible corollary:

\begin{cor}\label{treewidth-lower-bound-n}
    For every integer $t\ge 0$, there exists a constant $\alpha>0$ such that, for infinitely many $n\in\N$,   there exists an $n$-vertex graph $G$ with $tw(G)\le t$ and  $\uqs(G)\ge \alpha\log n/\log^{(t+1)} n$.
\end{cor}

Since every graph of treewidth at most 2 is planar and is even a subgraph of a planar 3-tree, we obtain the following corollary from \cref{treewidth-lower-bound-n}:

\begin{cor}\label{planar-lower-bound}
    There exists a constant $\alpha>0$ such that, for infinitely many $n\in\N$, there is an $n$-vertex planar 3-tree $G$ with $\uqs(G)\ge \alpha\log n/\log^{(3)} n$.
\end{cor}

\cref{planar-lower-bound} establishes the lower bounds in \cref{planar,three-trees}.

\section{Discussion}
\label{conclusion}

We have given asymptotically optimal bounds on the number of colours required by $2$-rankings of $n$-vertex $t$-trees, planar 3-trees, outerplanar graphs, and planar graphs.  Prior to this work, the best known bounds were $\Omega(n/\log n)$ (trees) and $O(\log n)$.

Our upper bounds are constructive and lead to $O(n)$ time algorithms for finding $2$-rankings of $t$-trees, planar 3-trees, and outerplanar graphs.  For planar graphs, we require an algorithic version of \cref{product-structure}. Currently, the fastest such algorithm runs in $O(n\log n)$ time \cite{morin:fast}.


\section{Other Ideas}

\begin{itemize}
\item Approximation algorithm for trees.  Using characterization in terms of $T_{h+1,h}$.

\item Extension to $\chi_\ell(G)$ for constant values of $\ell$.
\end{itemize}


\bibliographystyle{plainnat}
\bibliography{us}

\end{document}
