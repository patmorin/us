\documentclass[kpfonts]{patmorin}
\listfiles
\usepackage{pat}
\usepackage{paralist}
\usepackage{dsfont}  % for \mathds{A}
\usepackage[utf8x]{inputenc}
\usepackage{skull}

\usepackage{graphicx}
\usepackage[noend]{algorithmic}

\usepackage[normalem]{ulem}
\usepackage{cancel}
\usepackage{enumitem}

\usepackage[longnamesfirst,numbers,sort&compress]{natbib}

% Taken from
% https://tex.stackexchange.com/questions/42726/align-but-show-one-equation-number-at-the-end
\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}}


\setlength{\parskip}{1ex}

\title{\MakeUppercase{(Layered) Partitions versus Decompositions}}
\author{}

\DeclareMathOperator{\diam}{diam}
\DeclareMathOperator{\tw}{tw}
\DeclareMathOperator{\stw}{stw}
\DeclareMathOperator{\ltw}{ltw}
\DeclareMathOperator{\pw}{pw}
\DeclareMathOperator{\lpw}{lpw}
\DeclareMathOperator{\lhptw}{lhp-tw}
\DeclareMathOperator{\lhppw}{lhp-pw}

\newcommand{\ellt}{{\lfloor\ell/2\rfloor}}

\title{\MakeUppercase{Asymptotically Optimal Vertex Ranking of Planar Graphs}}
\author{Prosenjit Bose, Vida DujmoviÄ‡, Mehrnoosh Javarsineh, and Pat Morin}

\newcommand{\trn}{\chi_2}
\newcommand{\lrn}{\chi_{\ell}}
\newcommand{\dtcn}{\bar{\chi}_2}
\newcommand{\dlcn}{\bar{\chi}_\ell}
% \newcommand{\htrn}{\hat{\chi}_2}
\newcommand{\scn}{\chi_{\star}}

\newtheorem{othertheorem}{Theorem}
\renewcommand*{\theothertheorem}{\Alph{othertheorem}}
\crefname{othertheorem}{Theorem}{Theorem}

\newtheoremstyle{named}{}{}{\itshape}{}{\bfseries}{.}{.5em}{#3}
\theoremstyle{named}
\newtheorem*{namedtheorem}{Unused}

\newcommand{\weirdref}[2]{\cref{#1}#2}
\newcommand{\weirdlabel}[2]{\label{#1-#1}}

\pagenumbering{roman}
\begin{document}
\begin{titlepage}
\maketitle

\begin{abstract}
  A (vertex) $\ell$-ranking is a labelling $\varphi:V(G)\to\N$ of the vertices of a graph $G$ with integer colours so that for any path $u_0,\ldots,u_p$ of length at most $\ell$, $\varphi(u_0)\neq\varphi(u_p)$ or $\varphi(u_0)<\max\{\varphi(u_0),\ldots,\varphi(u_p)\}$.  We show that, for any fixed integer $\ell\ge 2$, every $n$-vertex planar graph has an $\ell$-ranking using $O(\log n/\log\log\log n)$ colours and this is tight even when $\ell=2$; for some $n$-vertex planar graphs, any 2-ranking requires $\Omega(\log n/\log\log\log n)$ colours.  This result also extends to bounded genus graphs.

  In developing this proof we obtain optimal bounds on the number of colours needed for $\ell$-ranking graphs of treewidth $t$ and graphs of simple treewidth $t$ (this includes planar 3-trees and outerplanar graphs).  These upper bounds are constructive and give $O(n\log n)$-time algorithms.  Additional results that come from our techniques include new sublogarithmic upper bounds on the number of colours needed for $\ell$-rankings of apex minor-free graphs and $k$-planar graphs.
\end{abstract}
\end{titlepage}

\tableofcontents

\newpage
\pagenumbering{arabic}

\section{Introduction}

% A sequence of integers $\phi_0,\ldots,\phi_p$ is \emph{ranked} if $\max\{\phi_0,\ldots,\phi_p\}$ occurs exactly once in $\phi_0,\ldots,\phi_p$.

A \emph{colouring} $\varphi:V(G)\to \N$ of a graph $G$ is an \emph{$\ell$-ranking} of $G$ if, for every non-trivial path $u_0,\ldots,u_p$ in $G$ of length\footnote{The length of a path $u_0,\ldots,u_p$ is the number, $r$, of edges in the path. A path is \emph{trivial} if its length is 0 and non-trivial otherwise.} at most $\ell$,
\begin{inparaenum}[(i)]
    \item $\varphi(u_0)\neq\varphi(u_p)$; or \item $\varphi(u_0)<\max\{\varphi(u_0),\ldots,\varphi(u_{r})\}$.
\end{inparaenum}
The $\ell$-ranking number $\chi_\ell(G)$ of $G$ is the minimum integer $k$ such that $G$ has a $\ell$-ranking $\varphi:V(G)\to \{1,\ldots,k\}$.  Note that, for any $\ell\ge 1$ any $\ell$-ranking of $G$ is a proper colouring\footnote{A colouring $\varphi:V(G)\to \N$ is \emph{proper} if, for each edge $vw\in E(G)$, $\varphi(v)\neq\varphi(w)$ and the \emph{chromatic number}, $\chi(G)$, of $G$ is the minimum integer $k$ such that there exists a proper colouring $\varphi:V(G)\to\{1,\ldots,k\}$ of $G$.} of $G$, so $\chi(G)\le \chi_\ell(G)$, and any proper colouring of $G$ is a 1-ranking of $G$, so $\chi(G)=\chi_1(G)$.

Besides the case $\ell=1$, two cases have received special attention: An $\infty$-ranking is called a \emph{vertex ranking} or \emph{ordered colouring}. The parameter $\chi_\infty(G)$ is called the \emph{vertex ranking number} of $G$ and has applications to matrix factorization \cite{bodlaender.gilbert.ea:approximating,duff.reid:multifrontal,liu:role,dereniowski.kubale:cholesky}, VLSI layout \cite{leiserson:area,sen.deng.ea:on}, and the analysis of online algorithms \cite{even.smorodinsky:hitting}. The case $\ell=2$ has also received special attention \cite{almeter.demircan.ea:graph,karpas.neiman.ea:on,shalu.antony:complexity}. A $2$-ranking is called a \emph{unique-superior colouring} (abbreviated \emph{us-colouring}) by \citet{karpas.neiman.ea:on} who prove the following result:

\setcounter{othertheorem}{19}
\begin{othertheorem}[\cite{karpas.neiman.ea:on}]\label{trees}
    For every $n$-vertex tree $T$, $\trn(T)\in O(\log n/\log\log n)$ and this is asymptotically optimal: for infinitely many values of $n$, there exists an $n$-vertex tree $T$ with $\trn(T)\in\Omega(\log n/\log\log n)$.
\end{othertheorem}

The same authors prove the following result for planar graphs:

\setcounter{othertheorem}{15}
\begin{othertheorem}[\cite{karpas.neiman.ea:on}]\label{planar-graphs}
    For every integer $\ell$ and every $n$-vertex planar graph $G$, $\lrn(G)\in O(\ell\log n)$.
\end{othertheorem}

Since every tree is a planar graph and no better lower bound is known for planar graphs, this leaves an obvious question:  Which is the correct bound for 2-ranking $n$-vertex planar graphs, $\log n$ or $\log n/\log\log n$?  As it turns out, the truth is somewhere in between.  Let $\log x :=\ln x$ denote the natural logarithm of $x$ and define $\log^{(0)}x:=x$ and, for any integer $i>0$, let $\log^{(i)}x:=\log(\log^{(i-1)} x)$. We prove:


\begin{thm}\label{planar}
    For any fixed integer $\ell\ge 2$, every $n$-vertex planar graph $G$ has $\lrn(G)\in O(\log n/\log^{(3)} n)$ and this is asymptotically optimal: for infinitely many values of $n$, there exists an $n$-vertex planar graph $G$ with $\trn(G)\in \Omega(\log n/\log^{(3)} n)$
\end{thm}

Our proof of the upper bound in \cref{planar} makes use of a recent \emph{product structure theorem} of \citet{dujmovic.joret.ea:planar} which states that every planar graph $G$ is a subgraph of $H\boxtimes K_3\boxtimes P$ where $H$ is a planar planar graph of treewidth at most $3$, $K_3$ is a 3-cycle, $P$ is a path, and $\boxtimes$ denotes the strong graph product.\footnote{Definitions of $t$-trees, simple $t$-trees, treewidth, simple treewidth, and strong graph product appear later, in \cref{sec:basics}.}  To apply this theorem, we prove the following result:

\begin{thm}\label{simple-t-trees}
    For any fixed integers $\ell\ge 2$ and $t\ge 1$, every $n$-vertex graph $H$ of simple treewidth at most $t$ has $\lrn(H) \in O(\log n/\log^{(t)}n)$ and this is asymptotically optimal: for any fixed integer $t\ge 0$ and infinitely many values of $n$, there exists an $n$-vertex graph $H$ of simple treewidth $t$ that has $\trn(H)\in\Omega(\log n/\log^{(t)} n)$.
\end{thm}

The lower bound in \cref{simple-t-trees} immediately implies the lower bound in \cref{planar} because a graph has simple treewidth at most 3 if and only if it is planar and has treewidth at most 3. Therefore, the lower bound in \cref{simple-t-trees} shows the existence of $n$-vertex planar graphs $H$ with $\trn(H)\in\Omega(\log n/\log^{(3)} n)$.

To obtain the upper bound in \cref{planar}, we apply the upper bound in \cref{simple-t-trees} to the graph $H$ defined by the product structure theorem along with a simple lemma which shows that, for any two graphs $G_1$ and $G_2$, $\lrn(G_1\boxtimes G_2)\le \lrn(G_1)\cdot\dlcn(G_2)$ where $\dlcn(G_2)$ is the \emph{distance-$\ell$ colouring number} of $G_2$;  the minimum number of colours needed to colour $G_2$ so that the endpoints of each non-trivial path of length at most $\ell$ have different colours.  It is easy to see that $\dlcn(K_3\times P)\le 3(\ell+1)$, so $\lrn(H\boxtimes K_3\boxtimes P)\le 3(\ell+1)\cdot\lrn(H)$.

Every graph of treewidth at most $t$ has simple treewidth at most $t+1$. Therefore, the upper bound in \cref{simple-t-trees} implies the (upper bound in the) following generalization of \cref{trees}:

\begin{thm}\label{t-trees}
    For any fixed integers $\ell\ge 2$, $t\ge 0$, every $n$-vertex graph $H$ of treewidth at most $t$ has $\lrn(H) \in O(\log n/\log^{(t+1)} n)$ and this is asymptotically optimal: for any fixed integer $t\ge 0$ and infinitely many values of $n$, there exists an $n$-vertex graph $H$ of treewidth $t$ with $\trn(H)\in\Omega(\log n/\log^{(t+1)} n)$.
\end{thm}

The lower bound in \cref{t-trees} is through a construction of a treewidth-$t$ graph $H$ with $\trn(H)\in\Omega(\log n/\log^{(t+1)} n)$.  Again, since any graph of treewidth at most $t-1$ has simple treewidth at most $t$, the lower bound in \cref{t-trees} implies the lower bound in \cref{simple-t-trees}.

In addition to planar graphs, there are product structure theorems for a number of other graph classes, including bounded genus graphs, apex minor-free graphs, and $k$-planar graphs.  Using product structure theorems for these graph classes along with \cref{simple-t-trees,t-trees}, we obtain the following two results:

\begin{thm}\label{bounded-genus}
    For any fixed integer $\ell\ge 2$ and any integer $g\ge 0$, every $n$-vertex graph $G$ of Euler genus at most $g$ has $\lrn(G)\in O(g\log n/\log^{(3)} n)$.
\end{thm}

\begin{thm}\label{meta-theorem}\label{meta}
    For each of the following graph classes $\mathcal{G}$:
    \begin{compactenum}
        % \item the class of graphs that have non-crossing drawings in a surface of genus at most $g$;
        \item the class of graphs excluding a particular apex graph $A$ as a minor; and
        \item the class of graphs that can be drawn in a surface of genus $g$ with at most $k$ crossings per edge,
    \end{compactenum}
    there exists an integer $c=c(\mathcal{G})$ such that, for any fixed integer $\ell\ge 2$, every $n$-vertex graph $G\in\mathcal{G}$ has $\lrn(G)\in O(\log n/\log^{(c)} n)$.
\end{thm}



\subsection{Related Work}

For a graph $G$, a vertex $\infty$-ranking is known as a \emph{vertex ranking} \cite{bodlaender.deogun.ea:rankings} or \emph{ordered colouring} of $G$ \cite{katchalski.mccuaig.ea:ordered}.  Finding a vertex ranking $\varphi$ that uses exactly $\chi_\infty(G)$ colours is equivalent to finding a minimum-height elimination tree of $G$ \cite{torre.greenlaw.ea:optimal,deogun.kloks.ea:on}.  This measure has applications to parallel Cholesky factorization of matrices \cite{bodlaender.gilbert.ea:approximating,duff.reid:multifrontal,liu:role,dereniowski.kubale:cholesky} and in VLSI layout \cite{leiserson:area,sen.deng.ea:on}.  More recently, \citet{even.smorodinsky:hitting} showed that $\chi_\infty(G)$ determines the competitive ratio of the best algorithm for the online hitting set problem in $G$.

The \emph{vertex ranking problem} of determining $\chi_\infty(G)$ for an arbitrary graph $G$ is known to be NP-hard, even on some restricted classes of graphs \cite{bodlaender.deogun.ea:rankings,llewellyn.tovey.ea:local,llewellyn.tovey.ea:erratum,dereniowski.nadolski:vertex}. Polynomial-time algorithms for the vertex ranking problem have been found for several families of graphs: \citet{schaeffer:optimal} showed this for trees and \citet{deogun.kloks.ea:on} showed this for permutation graphs.

A straightforward application of divide-and-conquer using planar separators shows that, for any $n$-vertex planar graph $G$, $\chi_\infty(G) \in O(\sqrt{n})$ \cite{llewellyn.tovey.ea:local,katchalski.mccuaig.ea:ordered}, and this bound is optimal:  There exists $n$-vertex planar graphs $G$ with $\chi_\infty(G)\in \Omega(\sqrt{n})$ \cite{katchalski.mccuaig.ea:ordered}.  A lower bound of \citet{katchalski.mccuaig.ea:ordered} shows that upper bounds like this, using divide-and-conquer with separators, are essentially tight: If, for every $r$-element set $S\subseteq V(G)$, the graph $G-S$ has a component of size at least $\alpha n$, then $\chi_\infty(G) \in\Omega(\alpha r)$. In a similar vein, \citet{bodlaender.gilbert.ea:approximating,kloks:treewidth} show that $\chi_\infty(G)$ is lower bounded by 1 plus the pathwidth of $G$.

It is not hard to see that, even for an $n$-vertex path $P$, $\chi_\infty(P)\in\Omega(\log n)$.  The same separator argument, applied to treewidth-$t$ graphs shows that every $n$-vertex treewidth-$t$ graph $G$ has $\chi_\infty(G)\in O(t\log n)$.  This shows that, even for graphs with constant-size separators, (worst-case asymptotically) optimal bounds are obtained by divide-and-conquer using separators.  More references on vertex ranking are available in Section 7.19 of the dynamic survey by \citet{gallian:dynamic}.

\begin{table}
    \centering{
        \begin{tabular}{|l|c|c|l|} \hline
            Graph class & Upper Bound & Lower Bound & Ref. \\ \hline
            Trees & $O(\log n/\log\log n)$ & $\Omega(\log n/\log\log n)$ & \cite{karpas.neiman.ea:on} \\
            Planar graphs & $O(\ell\log n)$ & $\Omega(\log n/\log\log n)$ & \cite{karpas.neiman.ea:on} \\
            Proper minor closed & $O(\log n)$ & $\Omega(\log n/\log\log n)$ & \cite{karpas.neiman.ea:on} \\
            $d$-cubes & $d+1$ & $d+1$ & \cite{almeter.demircan.ea:graph} \\
            Max-degree 3 & $7$ & & \cite{almeter.demircan.ea:graph} \\
            Max-degree $\Delta$ & $O(\min\{\Delta^2,\Delta\sqrt{n}\})$ & $\Omega(\Delta^2/\log \Delta)$ & \cite{karpas.neiman.ea:on,almeter.demircan.ea:graph} \\
            $d$-degenerate & $O(d\sqrt{n})$ & $\Omega(n^{1/3} + d^2/\log d)$ & \cite{karpas.neiman.ea:on,almeter.demircan.ea:graph} \\
            \hline \multicolumn{4}{c}{} \\
            \hline
            Simple treewidth $\le t$ & $O(\log n/\log^{(t)} n)$ & $\Omega(\log n/\log^{(t)} n)$ & \cref{simple-t-trees} \\
            Treewidth $\le t$ & $O(\log n/\log^{(t+1)} n)$ & $\Omega(\log n/\log^{(t+1)} n)$ & \cref{t-trees} \\
            Planar graphs & $O(\log n/\log^{(3)} n)$ & $\Omega(\log n/\log^{(3)} n)$ & \cref{planar,t-trees} \\
            Outerplanar graphs & $O(\log n/\log^{(2)} n)$ & $\Omega(\log n/\log^{(2)} n)$ & \cref{t-trees}, \cite{karpas.neiman.ea:on} \\
            Genus-$g$ graphs & $O(g\log n/\log^{(3)} n)$ & $\Omega(\log n/\log^{(3)} n)$ & \cref{bounded-genus,t-trees} \\
            $A$-minor-free (apex $A$) & $O(\log n/\log^{(c(A))} n)$ & $\Uparrow$ & \cref{meta} \\
            $(g,k)$-planar & $O(\log n/\log^{(c(g,k))} n)$ & $\Uparrow$  & \cref{meta} \\
            \hline
        \end{tabular}
    } % centering
    \caption{Summary of previous and new results on $\trn$.  All new upper bounds hold for any constant $\ell$. All new lower bounds hold for $\ell=2$. Prior upper bounds hold only for $\ell=2$, with the exception of the $O(\ell\log n)$ upper bound for planar graphs.}
\label{summary-table}
\end{table}

At least three works have considered $\chi_\ell$ for finite $\ell$ with a focus on the case $\ell=2$.  These results are summarized in \cref{summary-table}.  Note that 2-rankings fall between two very well-studied graph colouring problems:
\begin{compactitem}
    \item \emph{star colourings}, which ensure that the graph induced by an 2 colour classes is forest of stars and
    \item \emph{distance-2 colourings} which ensure that the endpoints each non-trivial path of length at most 2 receive distinct colours.
\end{compactitem}
Every 2-ranking is a star colouring and every distance-2 colouring is a 2-ranking so, letting $\scn(G)$ and $\dtcn(G)$ denote the star colouring number of $G$ and distance-2 colouring number of $G$, respectively, we have $\scn(G) \le \trn(G)\le \dtcn(G)$.

\citet{karpas.neiman.ea:on} proved \cref{trees}---a tight bound of $\trn(T)\in O(\log n/\log\log n)$ for every $n$-vertex tree $T$---and \cref{planar-graphs}---the upper bound $\trn(G)\in O(\log n)$ for every $n$-vertex planar graph $G$.  More generally, the same authors show that, for any proper minor-closed family $\mathcal{G}$ of graphs and, for every positive integer $\ell$, $\chi_\ell(G)\in O(\ell\log n)$ for every $n$-vertex $G\in\mathcal{G}$.  They also show that, for fixed $d$, every $n$-vertex $d$-degenerate graph $G$ has $\trn(G)\in O(\sqrt{n})$ and there exists examples with $\trn(G)\in\Omega(n^{1/3})$.

\citet{shalu.antony:complexity} show that determining the minimum number of colours required by a 2-ranking of a given graph is NP-hard, even when restricted to planar bipartite graphs.  \citet{almeter.demircan.ea:graph} determine the exact value of $\trn(Q_d)=d+1$ where $Q_d$ is the $d$-cube.  They also shows that, for graphs $G$ of maximum degree 3, $\trn(G)\le 7$ and show the existence of a graph with maximum degree $k$ such that $\trn(G)\in\Omega(k^2/\log k)$.

It is not hard to see that any colouring $\varphi$ of $G$ is a vertex $\ell$-ranking if and only if, for every connected subgraph $X$ of $G$ having at most $\ell+1$ vertices, there is only one vertex $v\in V(X)$ such that $\varphi(v)=\max\{\varphi(v):v\in V(X)\}$.  This makes $\ell$-ranking a stronger notion than \emph{$\ell$-centered colouring}, which requires only that there exists some colour $\alpha$ such that there is exactly one vertex $v\in V(X)$ with $\varphi(v)=\alpha$. In this case, the difference between ``unique'' and ``unique maximum'' is surprisingly profound.  Planar graphs (and, indeed, all graphs families having similar product structure theorem) have $\ell$-centered colourings using a number of colours that depends only (polynomially) on $\ell$ \cite{debski.felsner.ea:improved,pilipczuk.siebertz:polynomial}.

The remainder of this paper is organized as follows: \Cref{sec:basics} reviews some basic tools used in the following sections.   \Cref{lower-bounds} proves the lower bound in \cref{t-trees}, which immediately implies the lower bounds in \cref{planar,simple-t-trees}. \Cref{upper-bounds} proves the upper bound in \cref{simple-t-trees}, from which the upper bounds in \cref{planar,t-trees,bounded-genus,meta} follow easily.  \Cref{conclusion} gives a brief summary and discusses directions for further work.

\section{Preliminaries}
\seclabel{basics}

In this paper we use standard graph theory terminology as used in the book by \citet{diestel:graph}
Every graph $G$ we consider is finite, simple, and undirected with vertex set denoted by $V(G)$ and edge set denoted by $E(G)$.  We use the shorthand $|G|:=|V(G)|$ to denote the number of vertices in $G$.  We use $N_G(v):=\{w\in V(G): vw\in E(G)\}$ to denote the \emph{open neighbourhood} of $v$ in $G$.  For each $n\in\N$, $K_n$ denotes the complete graph on $n$ vertices.

For any set $S$, $G[S]$ is the graph with vertex set $V(G[S]):=V(G)\cap S$ and edge set $E(G[S]):=\{vw\in E(G): \{v,w\}\subseteq S\}$, and $G-S:=G[V(G)\setminus S]$.  We say that a subgraph $G'$ of $G$ is an \emph{induced} subgraph of $G$ if $G[V(G')]=G'$.  The following simple lemma shows that, for vertex rankings, we need only consider induced paths:

\begin{obs}\label{induced-paths-only}
    A colouring $\varphi:V(G)\to\N$ of a graph $G$ is an $\ell$-ranking of $G$ if and only if, for every induced path $u_0,\ldots,u_p$ in $G$ of length at most $\ell$,
    \begin{inparaenum}[(i)]
        \item $\varphi(u_0)\neq\varphi(u_p)$; or
        \item $\varphi(u_0)<\max\{\varphi(u_0),\ldots,\varphi(u_p)\}$.
    \end{inparaenum}
\end{obs}

\begin{proof}
    By definition any $\ell$-ranking $\varphi$ of $G$ satisifies (i) or (ii) for every path of length at most $\ell$, including every induced path of length at most $\ell$, so this direction is trivial.

    For the other direction, suppose $G$ contains a (not necessarily induced) path $u_0,\ldots,u_p$ of length $r\le\ell$ with $\varphi(u_0)=\varphi(u_p)$ and $\varphi(u_0)=\max\{\varphi(u_0),\ldots,\varphi(u_p)\}$.  Let $w_0,\ldots,w_s$ be the shortest path from $w_0:=u_0$ to $w_s:=u_p$ in  the graph $G[\{u_0,\ldots,u_p\}]$.  Then $w_0,\ldots,w_s$ is an induced path in $G$ with $\varphi(w_0)=\varphi(u_0)=\varphi(u_p)=\varphi(w_s)$ and, since $\{w_0,\ldots,w_{s}\}\subseteq\{u_0,\ldots,u_{r}\}$, $\max\{\varphi(w_0),\ldots,\varphi(w_{s})\}\le\max\{u_0,\ldots,u_{r}\}$, so $\varphi(w_0)=\varphi(u_0)=\max\{\varphi(w_0),\ldots,\varphi(w_s)\}$, as required.
\end{proof}

The same reasoning used to prove \cref{induced-paths-only} also shows:

\begin{obs}\label{walks-too}
    A colouring $\varphi:V(G)\to\N$ of a graph $G$ is an $\ell$-ranking of $G$ if and only if, for every walk $w_0,\ldots,w_q$ in $G$ of length at most $\ell$,
    \begin{inparaenum}[(i)]
        \item $\varphi(w_0)\neq\varphi(w_q)$; or
        \item $\varphi(w_0)<\max\{\varphi(w_0),\ldots,\varphi(w_q)\}$.
    \end{inparaenum}
\end{obs}


The \emph{length} of a path $u_0,\ldots,u_p$ in a graph is equal to the number, $r$, of edges in the path. A path is \emph{trivial} if it has length 0 and \emph{non-trivial} otherwise.

Let $T$ be a rooted tree rooted at some node $r\in V(T)$.  For any node $x\in V(T)$, $P_T(x)$ denotes the path, in $T$, from $r$ to $x$.  The \emph{$T$-depth} of $x\in V(T)$, denoted by $d_T(x)$, is the length of the path $P_T(x)$.  A node $a\in V(T)$ is a \emph{$T$-ancestor} of $x\in V(T)$ if $a\in V(P_T(x))$. If $a$ is a $T$-ancestor of $x$ then $x$ is a \emph{$T$-descendant} of $a$.  Note that every node of $T$ is both a $T$-ancestor and $T$-descendant of itself.  If $a$ is a $T$-ancestor of $x$ and $x\neq a$ then $a$ is a \emph{strict} $T$-ancestor of $x$ and $x$ is a \emph{strict} $T$-descendant of $a$.  The strict ancestor relation induces a partial order $\prec_T$ on $V(T)$ in which $x\prec_T y$ if and only if $x$ is a strict $T$-ancestor of $y$.

For any graph $G$, and any two vertices $v,w\in V(G)$, $d_G(v,w)$ denotes the length of the shortest path, in $G$, from $v$ to $w$. For any integer $k\ge 0$, the \emph{$k$-th power} of $G$, denoted by $G^k$, is the graph with vertex set $V(G^k):=V(G)$ and edge set $E(G^{k}):=\{vw:v,w\in V(G),\,d_G(v,w)\le k\}$.
% In the special case $k=2$, $G^2$ is called the \emph{square} of $G$.
Note that any distance-$\ell$ colouring of $G$ is a proper colouring of $G^\ell$ and vice-versa, i.e., $\dlcn(G)=\chi(G^\ell)$.

For any $v\in V(G)$ and any $W\subseteq V(G)$, let $d_H(v,W)=\min\{d_G(v,w):w\in W\}$. A \emph{BFS layering} of $G$ is a partition of $V(G)$ into a sequence $\mathcal{L}:=(L_0,\ldots,L_m)$ of sets such that, for each $i\in\{1,\ldots,m\}$ and each $v\in L_i$, $d_G(v,L_0)=i$.  Any BFS layering $\mathcal{L}:=(L_0,\ldots,L_m)$ defines a partial order $\prec_{\mathcal{L}}$ on $V(G)$ in which $v\prec_{\mathcal{L}} w$ if and only if $v\in L_i$, $w\in L_j$ and $i<j$.

% A path $P:=u_0,\ldots,u_p$ in $G$ is an \emph{induced} path if $G[\{u_0,\ldots,u_p\}]$ is a path.



\subsection{Treewidth}

For two graphs $H$ and $X$, an \emph{$X$-decomposition} of $H$ is a sequence $\mathcal{X}:=(B_x:x\in V(X))$ of subsets of $V(H)$ called \emph{bags} indexed by the nodes of $X$ and such that
 \begin{inparaenum}[(i)]
     \item for each $v\in V(H)$, $X[\{x\in V(X):v\in B_x\}]$ is connected; and
     \item for each $vw\in E(H)$, there exists some $x\in V(X)$ such that $\{v,w\}\subseteq B_x$.
\end{inparaenum}
The \emph{width} of $\mathcal{X}$ is $\max\{|B_x|:x\in V(X)\}-1$. We say that $H$ is \emph{edge-maximal} with respect to $\mathcal{X}$ if, for each $x\in V(X)$, $B_x$ forms a clique in $H$. The $X$-decomposition $\mathcal{X}$ is \emph{smooth} if, for each edge $xy\in E(X)$, $|B_x\setminus B_y|\le 1$ and $|B_y\setminus B_x|\le 1$.

In the special case where $X$ is a tree (or a forest), $\mathcal{X}$ is called a \emph{tree decomposition} of $H$.  In the still more special case where $X$ is a path (or a collection of disjoint paths), $\mathcal{X}$ is called a \emph{path decomposition} of $H$. The \emph{treewidth} $\tw(H)$ of $H$ is the minimum width of any tree decomposition of $H$. The \emph{pathwidth} $\pw(H)$ of $H$ is the minimum width of any path decomposition of $H$.

For a graph $H$ and a tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$ of $H$ in which $T$ is a rooted tree, we use the notation $x_T(v)$ to denote the minimum $T$-depth node $x\in V(T)$ such that $v\in B_x$.  This induces a partial order $\prec_{\mathcal{T}}$ on $V(H)$ in which $v\prec_{\mathcal{T}} w$ if and only if $x_T(v)\prec_T x_T(w)$.  The following observations have straightforward proofs:

 \begin{obs}\label{induced-unimodal}
     Let $H$ be a graph that is edge maximal with respect to some tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$ of $H$.  Then, for any induced path $u_0,\ldots,u_p$ in $H$, $u_i\preceq_\mathcal{T} u_0$ or $u_i\preceq_\mathcal{T} u_p$ for each $i\in\{1,\ldots,p-1\}$.
 \end{obs}


\begin{obs}\label{order-relation}
    Let $H$ be a graph that is edge-maximal with respect to a tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$ of $H$, let $T$ be rooted at $r\in V(T)$, and let $\mathcal{L}:=L_0,\ldots,L_m$ be a BFS layering of $H$ with $L_0:=B_p$.  Then, for any two vertices $v,w\in V(H)$,
    \begin{compactenum}
        \item $v\prec_{\mathcal{T}}w$ implies $v\preceq_{\mathcal{L}}w$
        \item $v\prec_{\mathcal{L}}w$ implies $v\preceq_{\mathcal{T}}w$.
    \end{compactenum}
    Equivalently, there is no pair $v,w\in V(H)$ such that $v\prec_{\mathcal{L}}w$ and $w\prec_{\mathcal{T}}v$.
\end{obs}

\begin{obs}\label{up-neighbours}
    Let $H$ be a graph that is edge-maximal with respect to a width-$t$ tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$ of $H$, let $T$ be rooted at $r\in V(T)$, and let $\mathcal{L}:=L_0,\ldots,L_m$ be a BFS layering of $H$ with $L_0:=B_p$. Then, for any $i\in\{1,\ldots,m\}$ and any $v\in L_i$, $|N_H(v)\cap L_{i-1}|\le t$.
\end{obs}

% \begin{proof}
%     By \cref{order-relation}, $w\preceq_\mathcal{T} v$ for each $w\in N_H(v)\cap L_i$.  Proprety~(i) of tree decompositions therefore implies that $N_H(v)\cap L_{i-1}\subseteq B_{x_T(v)}$.  Therefore $t+1\ge |B_{x_T(v)}| \ge |N_H(v)\cap L_{i-1}|+1$, as required.
% \end{proof}



% We say that a path $w_0,\ldots,w_q$ in $H$ is \emph{$\mathcal{T}$-downward} if $w_0\prec_\mathcal{T}w_{1}\prec_\mathcal{T}\cdots\prec_\mathcal{T} w_q$.  A path $w_0,\ldots,w_q$ is \emph{$\mathcal{T}$-upward} if and only if its reversal $w_q,\ldots,w_0$ is \emph{$\mathcal{T}$-downward}.
% The following lemma, due to \citet{pilipczuk.siebertz:polynomial} bounds the number of vertices that can be reached from $v\in V(H)$ by $\mathcal{T}$-upward paths of length at most $\ell$.
%
% \begin{lem}[\cite{pilipczuk.siebertz:polynomial}]\label{upward-count}
%     Let $H$ be a $t$-tree with a construction order $\mathcal{R}$ generating a canonical tree decomposition $\mathcal{T}$.  Then, for each integer $\ell\ge 0$ and each $v\in V(H)$, the number of vertices in $H$ that can be reached by $\mathcal{T}$-upward paths beginning at $v$ is at most $\binom{\ell+t}{t}$.
% \end{lem}
% A path $u_0,\ldots,u_p$ in $H$ is \emph{$\mathcal{T}$-unimodal} if there exists $m\in\{0,\ldots,p\}$ such that $u_0,\ldots,u_m$ is $\mathcal{T}$-upward and $u_{m+1},\ldots,u_p$ is $\mathcal{T}$-downward.
%
% \begin{lem}\label{induced-unimodal}
%     Let $H$ be a $t$-tree with a construction order $\mathcal{R}$ generating a canonical tree decomposition $\mathcal{T}$ and let $u_0,\ldots,u_p$ be an induced path in $H$.  Then $u_0,\ldots,u_p$ is $\mathcal{T}$-unimodal.
% \end{lem}
%
% \begin{proof}
%     For the sake of contradiction, suppose otherwise.  First note that $x_T:V(H)\to V(T)$ is \emph{nearly bijective} in the sense that for distinct $v,w\in V(H)$, $x_T(v)\neq x_T(w)$ or $\{v,w\}\subseteq B_p$. In the latter case $x_T(v)=x_T(w)=r$.  Next observe that, for any edge $u_iu_{i+1}\in E(H)$, $x_T(u_i)\preceq_T x_T(u_{i+1})$ or $x_T(u_{i+1})\preceq_T x_T(u_{i})$.  There are a few cases to consider:
%     \begin{enumerate}
%         \item There exists $i\in\{1,\ldots,p-1\}$ such that $x_T(u_{i-1})= x_T(u_i)= x_T(u_{i+1})$.  But this implies the existence of the edge $u_{i-1}u_{i+1}$, a contradiction.
%
%         \item There exists $i\in\{1,\ldots,p-1\}$ such that $x_T(u_{i-1})\prec_\mathcal{T} x_T(u_i)= x_T(u_{i+1})$.  Since $x_T$ is nearly bijective, this implies that $x_T(u_{i})=x_T(u_{i+1})=r$.  But this contradicts $x_T(u_{i-1})\prec_\mathcal{T} x_T(u_i)$ since $r\prec_T x$ for every $x\in V(T)\setminus\{r\}$.
%
%         \item There exists $i\in\{1,\ldots,p-1\}$ such that $x_T(u_{i-1})= x_T(u_i)\succ_\mathcal{T} u_{i+1}$.  This is a contradiction for the same reason as the previous case.
%
%         \item There exists $i\in\{1,\ldots,p-1\}$ such that $x_T(u_{i-1}) \prec_\mathcal{T} x_T(u_i)\succ_\mathcal{T} x_T(u_{i+1})$.  This implies that $x_T(u_{i-1})\preceq_T x_T(u_{i+1}) \prec_T(u_{i})$ or that
%         $x_T(u_{i+1})\prec_T x_T(u_{i-1}) \prec_T(u_{i})$.  In the former case, Property~(ii) of tree decompositions implies that $u_{i-1}\in B_{x_T(u_{i+1})}$.  In the latter case, $u_{i+1}\in B_{x_T(u_{i-1})}$.  Both cases imply that $u_{i-1}u_{i+1}\in E(H)$, contradicting the fact that $u_0,\ldots,u_p$ is an induced path of $H$.
%     \end{enumerate}
%     If none of the preceding four cases occurs, then $u_0,\ldots,u_p$ is $\mathcal{T}$-unimodal.
% \end{proof}


%
%
% \begin{obs}\label{dominant-parent}
%     Let $H$ be a $t$-tree with construction order $\mathcal{R}:=(v_1,\ldots,v_n)$ and let $\mathcal{L}:=(L_0,\ldots,L_m)$ be a BFS layering of $H$ with $L_0:=\{v_1,\ldots,v_{\min\{t,n\}}\}$.  Then, for any $i\in\{1,\ldots,m\}$ and any vertex $v\in L_{i}$ with dominant parent $p$, $p\in L_{i-1}$.
% \end{obs}
%
% \begin{proof}
%     A well-known property of BFS layerings is that, for $i>0$, any vertex $v\in L_{i}$ has some neighbour $w\in L_{i-1}$.  By definition, $p\le_\mathcal{R} w$ so, by \cref{order-relation} $p\le_\mathcal{L} w$. Since $w\in L_{i-1}$, $p\in L_0\cup\cdots\cup L_{i-1}$.  Another well known property of BFS layerings is that $v$ has no neighbour in $L_0,\ldots,L_{i-2}$.  Therefore $p\in L_{i-1}$.
% \end{proof}

% The following simple result is used several times in the (fairly involved) proof of \cref{simple-t-trees}.  We note that the vertices $p,q,v$ in the statement of the result are not necessarily distinct.
%
% \begin{obs}\label{up-clique}
%     Let $H$ be a $t$-tree with construction order $\mathcal{R}:=(v_1,\ldots,v_n)$, let $\mathcal{L}:=(L_0,\ldots,L_m)$ be a BFS layering of $H$ with $L_0:=\{v_1,\ldots,v_{\min\{t,n\}}\}$, let $i\in\{0,\ldots,m-1\}$, let $uvw$ be a path in $H$ with $u,w\in L_{i+1}$, $v\in L_{i}$, and let $p,q\in L_{i}$ be the dominant parents of $u$ and $w$ respectively.  Then $H[\{v,p,q\}]$ is a clique.
% \end{obs}
%
% % We remark that, in \cref{up-clique} $\{v,p,q\}$ may consist of $1$, $2$, or $3$ distinct elements.
%
% \begin{proof}
%     Refer to \cref{up-clique-figure}. Consider the canonical tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$ of $H$ generated by $v_1,\ldots,v_n$.  By \cref{order-relation}, $v\prec_{\mathcal{T}} u,w$ and, by definition $p,q\preceq_{\mathcal{T}} v$.  Therefore $p,q\prec_{\mathcal{T}} v\prec_{\mathcal{T}} u,w$.  Since $pu\in E(H)$, this implies that $p\in B_{x_T(v)}$.  Similarly $q\in B_{x_T(v)}$.  By definition, $v\in B_{x_T(v)}$.  The vertices in $B_{x_T(v)}$ form a clique in $H$, so $\{v,p,q\}$ is a clique in $H$.
% \end{proof}
%
% \begin{figure}
%     \centering{
%         \includegraphics{figs/up-clique}
%     }
%     \caption{The proof of \cref{up-clique}}
%     \label{up-clique-figure}
% \end{figure}

% An incredibly useful property of graphs of small treewidth is that they have small separators.
We will make use of the following well-known and easy to prove vertex-weighted separator lemma:

\begin{lem}\label{weighted-separator}
    Let $H$ be a graph; let $\mathcal{T}:=(B_x:x\in V(T))$ be a tree decomposition of $H$; and let $\xi:V(H)\to\R$ be a function that is positive on $V(H)$.  Then, for any integer $c>1$, there exists $S_T\subseteq V(T)$ of size $|S_T|\le c$ such that, for each component $X$ of $H-(\bigcup_{x\in S_T} B_x)$, $\sum_{v\in V(X)} \xi(v) \le \tfrac{1}{c}\cdot\sum_{v\in V(H)} \xi(v)$.
\end{lem}

% \begin{proof}
%     (This proof is only included for the sake of being self-contained.)
%     Define $n_0:=\tfrac{1}{c}\cdot\sum_{v\in V(H)} \xi(v)$ and, for a subtree $T'$ of $T$, let $n_{T'}:=\sum_{y\in \bigcup_{x\in V(T')}B_x]} B_y$.  Let $T^{(0)}:=T$, let $i:=0$ and repeat the following steps until $n_{T^{(i)}} < n_0$:
%     \begin{compactenum}
%         \item Find a node $x_{i}\in V(T^{(i)})$ of maximal $T^{(i)}$-depth such that the subtree $T^{(i)}_{x_i}$ of $T^{(i)}$ containing $x_i$ and its $T^{(i)}$-descendants has $n_{T^{(i)}_{x_i}} > n_0$.
%
%         \item Set $T^{(i+1)}$ to be the component of $T^i-\{x_i\}$ containing $r$ and set $i:=i+1$.
%     \end{compactenum}
%     The key observation is that, since $x_i$ is of maximal depth, each component $X$ of $T^{(i)}-\{x_i\}$ other than $T^{(i+1)}$ has $n_X\le n_0$.
%     This procedure certainly terminates after at most $n_T/n_0 = O(c)$ steps and the set $S_T:=\{x_0,\ldots,x_p\}$ has the required properties.
% \end{proof}

\subsection{Simple Treewidth}


A tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$ of a graph $H$ is \emph{$t$-simple} if it has width $t$ and, for every $t$-element subset $S\subseteq V(H)$, $|\{x\in V(T):S\subseteq B_x\}|\le 2$.  The simple treewidth $\stw(H)$ of a graph $H$ is the minimum integer $t$ such that $H$ has a $t$-simple tree decomposition \cite{knauer.ueckerdt:simple}.
% A $t$-tree $H$ is a \emph{simple} $t$-tree if its canonical tree decompositions are $t$-simple.\footnote{Although a $t$-tree $H$ has different canonical tree decompositions depending on the choice of $v_1,\ldots,v_{t+1}$ in the construction order, each of these tree decompositions $(B_x:x\in V(T))$ generates the same set $\{B_x:x\in V(T)\}$ of bags that have a bijection with the $t+1$ cliques of $H$.  Therefore all of these tree decompositions are $t$-simple or none of them are.}
Though it appears implicitly, several times in the literature, \citet{knauer.ueckerdt:simple} define simple treewidth and the thesis of \citet{wulf:stacked} studies it extensively.
% \citet{markenzon.justel.ea:subclasses} define simple $t$-trees (which they call Simple Clique (SC) $t$-trees).

Simple treewidth is minor-monotone. This is stated by \citet{knauer.ueckerdt:simple} and \citet[Theorem~5.2]{wulf:stacked} gives a proof:

\begin{lem}[\cite{knauer.ueckerdt:simple,wulf:stacked}]\label{simple-minor-closed}
    For every graph $G$ and every minor $M$ of $G$, $\stw(M)\le\stw(G)$.
\end{lem}

We work with simple treewidth because it arises naturally in the graphs we are interested in:

\begin{lem}[\cite{knauer.ueckerdt:simple,markenzon.justel.ea:subclasses}]\label{simple-small-cases}
    For any graph $H$,
    \begin{compactenum}[(i)]
        \item $\stw(H)\le 1$ if and only if $H$ is a collection of paths;
        \item $\stw(H)\le 2$ if and only if $H$ is outerplanar;
        \item $\stw(H)\le 3$ if and only if $\tw(H)\le 3$ and $H$ is planar.
    \end{compactenum}
\end{lem}

Simple treewidth and treewidth are closely related:

\begin{lem}[\cite{knauer.ueckerdt:simple}]\label{simple-treewidth-vs-treewidth}
    For every graph $G$, $\tw(G)\le \stw(G)\le \tw(G)+1$.
\end{lem}

% The following two results show that, although not immediately obvious, simple treewidth and simple $t$-trees behave very much like treewidth and $t$-trees.  The first result, due to \citet[Theorem~3.27]{wulf:stacked}, shows that every graph of simple treewidth at most $t$ is a spanning subgraph of some simple $t$-tree.\footnote{The statement of \cite[Theorem~3.27]{wulf:stacked} does not explicitly state that $V(G)=V(H)$, but it is the case.  The relevant location is the proof that (iii)$\Rightarrow$(i) in Theorem~3.25 where, by definition, $V(\mathrm{fill}(H))=V(G)$.}
%
% [TODO: We can get away without this, so let's clean it up when we get the chance.]
% \begin{lem}[\cite{wulf:stacked}]\label{simple-subgraph}
%     For any graph $G$ with $\stw(G)\le t$, there exists a simple $t$-tree $H$ with $V(G)= V(H)$ and $E(G)\subseteq E(H)$.
% \end{lem}

A proof of the following lemma, using minor-monotonicity, is due to \citet{wood:personal}.

\begin{lem}[\cite{wood:personal}]\label{simple-bfs-layers}
    Let $H$ be a graph that edge-maximal with respect to some $t$-simple tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$ of $H$ and let $L_0,\ldots,L_m$ be the BFS ordering of $H$ with $L_0:=B_p$.   Then, for each $i\in\{1,\ldots,m\}$, $\stw(H[L_i])\le t-1$.
\end{lem}


\subsection{Product Structure}

For two graphs $G_1$ and $G_2$, the \emph{strong graph product} of $G_1$ and $G_2$, denoted $G_1\boxtimes G_2$, is a graph whose vertex set is the Cartesian product $V(G_1\boxtimes G_2):= V(G_1)\times V(G_2)$ and that contains an edge between $v=(v_1,v_2)$ and $w=(w_1,w_2)$ if and only if
\begin{inparaenum}[(i)]
    \item $v_1=w_1$ and $v_2w_2\in E(G_2)$;
    \item $v_2=w_2$ and $v_1w_1\in E(G_1)$; or
    \item $v_1w_1\in E(G_1)$ and $v_2w_2\in E(G_2)$.
\end{inparaenum}

The following recent result of \citet{dujmovic.joret.ea:planar}, which builds on earlier work of \citet{pilipczuk.siebertz:polynomial}, shows that every planar graph is the subgraph of a strong product of very simple graphs.

\begin{thm}[\cite{dujmovic.joret.ea:planar}]\label{product-structure}
    For every $n$-vertex planar graph $G$, there exists an at most $n$-vertex planar 3-tree $H$ and a path $P$ such that $G$ is isomorphic to a subgraph of $H\boxtimes K_3\boxtimes P$.
\end{thm}

As the following simple lemma shows, product structure is highly relevant to $\ell$-ranking:

\begin{lem}\label{product-lemma}
    For any two graphs $G_1$ and $G_2$, $\lrn(G_1\boxtimes G_2)\le \lrn(G_1)\cdot\dlcn(G_2)$.
\end{lem}

\begin{proof}
    For each $(x,y)\in V(G_1\boxtimes G_2)$, let $\varphi(x,y)=\dlcn(G_2)\cdot \rho(x) - \psi(y)$ where $\rho:V(G_1)\to\{1,\ldots,\lrn(G_1)\}$ is an $\ell$-ranking of $G_1$ and $\psi:V(G_2)\to\{0,\ldots,\dlcn(G_2)-1\}$ is a distance-$\ell$ colouring of $G_2$.

    To see that $\varphi$ is a $\ell$-ranking, consider any
    path $u_0,\ldots,u_p$ in $G_1\boxtimes G_2$ of length $r\le\ell$ such that $\varphi(u_0)=\varphi(u_p)$.  We must show that $\varphi(u_0)<\max\{\varphi(u_0),\ldots,\varphi(u_p)\}$.

    For each $i\in\{0,\ldots,p\}$, let $(u_{i,1},u_{i,2}):=u_i$, so that $u_{i,1}\in V(G_1)$ and $u_{i,2}\in V(G_2)$. Since $\varphi(u_0)=\varphi(u_p)$, $\rho(u_{0,2})=\rho(u_{r,2})$. Since $\rho$ is a distance-$\ell$ colouring of $G_2$ and $r\le\ell$, this implies that $u_{0,2}=u_{r,2}$.  This implies that $u_{0,1}\neq u_{r,1}$, otherwise $u_0=u_p$ and $u_0,\ldots,u_p$ is not a path.  Therefore, $u_{0,1},\ldots,u_{r,1}$ is a walk in $G_1$ with distinct endpoints.
    Since $\rho$ is an $\ell$-ranking of $G_1$, \cref{walks-too} implies that $\rho(u_{0,1})<\max\{\rho_{u_0,1},\ldots,u_{r,1}\}$ and therefore $\varphi(u)<\max\{\varphi(u_0),\ldots,\varphi(u_p)\}$, as required.
      % Therefore $G_1[\{u_{0,1},\ldots,u_{r,1}\}]$ contains a path $w_0,\ldots,w_s$ with $w_0=u_{0,1}$, $w_s=u_{r,1}$, and $\{w_1,\ldots,w_{s-1}\}\subseteq \{u_{1,1},\ldots,u_{r,1}\}$. Since $\varphi(u_0)=\varphi(u_1)$, $\psi(w_0)=\psi(u_{0,1})=\psi(u_p,1)=\psi(w_s)$.
    % Since $\psi$ is an $\ell$-ranking of $G_1$, this implies that $\psi(w_i)>\psi(w_0)$ for some $i\in\{1,\ldots,s-1\}$, so $\varphi(u_{j})>\varphi(u_0)$ for some $j\in\{1,\ldots,p-1\}$.
\end{proof}

Note that the graph $K_3\boxtimes P$, which appears in \cref{product-structure}, has maximum degree 8 so $(K_3\boxtimes P)^\ell$ has maximum degree at most $8\cdot 7^{\ell-1}$.  Since distance-$\ell$ colouring any graph is $G$ equivalent to properly colouring $G^{\ell}$, this implies that $\dtcn(K_3\boxtimes P)\le 8\cdot7^\ell$. The following lemma improves this constant using the fact that $(K_3\boxtimes P)^\ell$ is $3\ell+2$ degenerate (as can be seen by ordering vertices of $(K_3\boxtimes P)$ by the order that their second coordinate appears in $P$).

\begin{lem}\label{dumb}
    For any path $P$, $\dlcn(K_3\boxtimes P)\le 3(\ell+1)$.
\end{lem}

% \begin{proof}
%     Order the vertices of $K_3\boxtimes P$ as $(x_1,y_1),\ldots,(x_{3|P|},y_{3|P|})$ so that, if $y_i$ appears before $y_j$ in $P$, then $i<j$. For each $j\in\{1,\ldots,3|P|\}$, let $I_j\subset\{1,\ldots,j-1\}$ be the set of indices $i$ such that $K_3\boxtimes P$ contains a non-trivial path of length at most $\ell$ with endpoints $(x_i,y_i)$ and $(x_j,y_j)$.  It is easy to verify that $|I_j|\le 3(\ell+1)$.  For each $j\in\{1,\ldots,3|P|\}$, set $\varphi(x_j,y_j):=\min(\{1,\ldots,3(\ell+1)\}\setminus\{\varphi(x_i,y_i):i\in I_j\})$.  This gives a distance-$\ell$ colouring $\varphi:K_3\boxtimes P\to\{1,\ldots,3(\ell+1)\}$.
% \end{proof}
%

\subsection{Inequalities for Iterated Logarithms}

For any $x> 0$ and $a\ge 0$, we have the inequality,
\begin{equation}
    \log (x+a) = \log (x(1+a/x)) = \log x + \log(1+a/x) \le \log x + \log e^{a/x} = \log x + \frac{a}{x} \enspace , \label{log-x-plus-a}
\end{equation}
where the inequality follows from the inequality $e^z \le 1+z$, valid for all $z\in\R$.

Define the \emph{$\tau$ower} function $\tau:\N\to\N$ by
\[
  \tau(i) :=
    \begin{cases}
        1 & \text{for $i=0$} \\
        e^{\tau(i-1)} & \text{for $i\ge 1$.} \\
    \end{cases}
\]
Recall that, for any integer $i\ge 0$,
\[
    \log^{(i)} x :=
      \begin{cases}
          x & \text{for $i=0$} \\
          \log\left(\log^{(i-1)}x\right) & \text{for $i\ge 1$.} \\
      \end{cases}
\]

For any $x > \tau(i-1)$ and any $a\ge 0$, \cref{log-x-plus-a} generalizes as follows (by induction on $i$):
\begin{equation}
    \log^{(i)}(x+a) \le \log^{(i)} x + \frac{a}{\prod_{j=0}^{i-1}\log^{(j)} x} \label{logi-x-plus-a}
\end{equation}

In several places we have ratios involving iterated logarithms, in which case we make use of the following consequence of \cref{logi-x-plus-a}
\begin{equation}
    \frac{\log^{(i)} x+a}{\log^{(i)} x} \le 1 + \frac{a}{\prod_{j=0}^{i}\log^{(j)} x} \enspace, \label{logi-ratio}
\end{equation}
which is again valid for all $x> \tau(i-1)$.

\subsection{The $\gamma_{i,k}$ Function}


For any integer $i$, any real $k>\tau(i-1)$, and any real $n\in[1,(\log^{(i)} k)^k]$, we define $\gamma_{i,k}(n)$ to be the solution $x$ to the equation $(\log^{(i)} k)^k/(\log^{(i)} x)^{x}=n$.  The value of $\gamma_{i,k}(n)$ is well defined and $\tau(i)\le \gamma_{i,k}(n)\le k$, for the following reasons:  For $x\in[\tau(i),k]$, the left hand side is a continuous strictly decreasing function of $x$. Setting $x=\tau(i)$, the left hand side becomes $(\log^{(i)} k)^k \ge n$. Setting $x=k$, the left hand side becomes $1\le n$.


%========================================================================
\section{Lower Bounds}
\label{lower-bounds}

We now prove the lower bound in \cref{t-trees}, which establishes all the other lower bounds. The idea in this lower bound is to construct a graph $G$ that has a BFS layering $L_0,\ldots,L_m$ such that, for each $i,\in\{0,\ldots,m-1\}$ and each vertex $a\in L_i$, $G[N_G(a)\cap L_{i+1}]$ is a collection of treewidth-$(t-1)$ graphs $U_{a,0},\ldots,U_{a,k}$, each of which is a copy of a small treewidth-$(t-1)$ graph $U$ that requires at least $h$ colours.  This forces the colour of $a$ to exceed, by at least $h+1$, the smallest colour used in $U_{a,0},\ldots,U_{a,k}$.  Proceeding bottom up, this forces the vertex in $L_0$ to receive a colour larger than $(h+1)m$.  The lower bound is then obtained by using induction on $t$ to upper bound the size of the graph $U$ needed to ensure that $\trn(U)\ge h$ and choosing the parameters $h$ and $m$ appropriately.

\begin{lem}\label{apex-graph}
    Let $h,k\ge 1$ be integers, let $U$ be a graph with $\trn(U)\ge h$ and let $G$ be a graph obtained by taking $k+1$ disjoint copies $U_0,\ldots,U_k$ of $U$ and adding an apex vertex $a$ adjacent to each $v\in\bigcup_{i=0}^k V(U_i)$.  Then, for any integer $k_0\in \{1,\ldots,k\}$ and any 2-ranking of $\varphi:V(G)\to\{k_0,\ldots,k\}$, $\varphi(a) \ge k_0+h$.
\end{lem}

\begin{proof}
    Since $\trn(U_i)\ge h$, there exists $v_i\in V(U_i)$ such that $\varphi(v_i)\ge k_0+h-1$, for each $i\in\{0,\ldots,k\}$.  Since $|\{0,\ldots,k\}|=k+1>k-k_0+1=|\{k_0,\ldots,k\}|$ the Pigeonhole Principle implies that there exists distinct $i,j\in\{0,\ldots,k\}$ such that $\varphi(v_i)=\varphi(v_j)$.  Since $v_i a v_j$ is a path in $G$, this implies that $\varphi(a)\ge \varphi(v_i)+1\ge k_0+h$.
\end{proof}

For a graph $U$ and integers $h,m\ge 0$, we define the \emph{$(h,m)$-boost} $U^{(h,m)}$ of $U$ as follows: The vertex set of $U^{(h,m)}$ is the disjoint union of $L_0,\ldots,L_m$.  The set $L_0:=\{a_0\}$ consists of a single vertex. For each $i\in\{1,\ldots,m\}$ and each $a\in L_{i-1}$, $U^{(h,m)}$ contains $hm+1$ disjoint copies $U_{a,0},\ldots,U_{a,hm}$ of $U$ and contains the edge $av$ for each $v\in\bigcup_{j=0}^{hm} V(U_{a,j})$.  This determines the set $L_i=\bigcup_{a\in L_{i-1}}\bigcup_{j=0}^{hm} V(U_{a,j})$.  As a simple example, if $U$ is a 1-vertex graph, then $U^{(h,m)}$ is a complete $(hm+1)$-ary tree of height $m$.

\begin{lem}\label{boost}
    For any graph $U$, any integer $m\ge 0$, and any $h\ge\trn(U)$, $\trn(U^{(h,m)})\ge hm +1$.
\end{lem}

\begin{proof}
    Suppose, for the sake of contradiction, that $\trn(U^{(h,m)})=k<hm+1$ and let $\varphi:V(U^{(h,m)})\to\{1,\ldots,k\}$ be a 2-ranking of $U_{(h,m)}$.  Let $L_0,\ldots,L_{m}$ be the partition of $V(U^{(h,m)})$ used in the definition of $V(U^{(h,m)})$.
    We will show by induction on $m-i$ that, for each $a\in L_{i}$, $\varphi(a)\ge(m-i)h+1$. This gives the desired contradiction since it implies that, for the unique vertex $a_0\in L_0$, $\varphi(a_0)\ge m h+1 > k$.

    The base case of the induction, $m-i=0$, is trivial; it simply asserts that $\varphi(v)\ge 1$ for each $v\in L_m$.  For any $i\in\{0,\ldots,m-1\}$ we apply the inductive hypothesis to conclude that $\varphi(v)\in\{(m-i-1)h+1,\ldots,k\}$ for each $v\in L_{i+1}$.  For each $a\in L_i$, the subgraph of $U^{(h,m)}$ induced by $a$ and its neighbours in $L_{i+1}$ contains the graph described in \cref{apex-graph} with $k_0:=(m-i-1)h+1$.  The conclusion of \cref{apex-graph} therefore implies that $\varphi(a)\ge k_0+h=(m-i)h+1$, as required.
\end{proof}

\begin{lem}\label{boost-size}
    For any graph $U$ and any integers $h,m \ge 1$, $|U^{(h,m)}| \le (|U|\cdot h\cdot m)^{m}\cdot (1+O((|U|hm)^{-1})$.
\end{lem}

\begin{proof}
    It is easy to see that, for each $i\in \{0,\ldots,m\}$, $|L_i|=(|U|(hm+1))^i$.  Therefore,
    \[ |U^{h,m}| = \sum_{i=0}^m |L_i| = \sum_{i=0}^m (|U|(hm+1))^i = (|U|(hm))^{m}\cdot (1+O((|U|hm)^{-1}) \enspace . \qedhere
    \]
\end{proof}


\begin{lem}\label{boost-treewidth}
    For any graph $U$ and any integers $h,m\ge 1$, $\tw(U^{(h,m)})\le \tw(U)+1$.
\end{lem}

\begin{proof}
  Let $t:=\tw(U)$.
  Create a width-$(t+1)$ tree-decomposition $(B_x:x\in V(T))$ of $U^{(h,m)}$ as follows: Start with $T$ having a single node $z_0$ with $B_{z_0}=L_0$.  For each $i\in\{1,\ldots,m\}$, and each $a\in L_{i-1}$, find some bag $B_z$ in the current decomposition that contains $a$, take $h+1$ disjoint copies $(A_x:x\in V(T_0)),\ldots,(A_x:x\in V(T_h))$ of some width-$t$ tree decomposition $\mathcal{T}$ of $U$.  For each $i\in\{0,\ldots,h\}$, add an edge from $z$ to any node of the tree in $T_i$ and add $a$ to every bag in $T_i$.  It is straightforward to verify that this does, indeed, give a width-$\tw(U)+1$ tree-decomposition of $U^{(h,m)}$.
\end{proof}


\begin{lem}\label{treewidth-lower-bound}
    For each integer $t\ge 1$ and any integer $r\ge \tau(t)$, there exists a graph $G$, with $|G|\le (\log^{(t-1)}r)^{tr + o(r)}$, $\tw(G)\le t$, and $\trn(G)\ge r$.
\end{lem}

\begin{proof}
    The proof is by induction on $t$.  The base case $t=1$ has already been established by \citet{karpas.neiman.ea:on} who show that the complete $(r+1)$-ary tree $T$ of height $r-1$ has $\trn(T)\ge r$.  The tree $T$ has size $\sum_{i=0}^{r-1} (r+1)^i \le r^r=(\log^{(0)}r)^{r}$.  This establishes the result for $t=1$.

    Let $h:=\lceil\log r\rceil$ and $m:=\lceil r/\log r\rceil$ so that $hm\ge r$.  For $t>1$ we can apply the inductive hypothesis to obtain a graph $U$,     with $\tw(U)\le t-1$, $|U|=(\log^{(t-2)} h)^{(t-1)h}$ and $\trn(U)\ge h$.
    Now we take the graph $G:=U^{(h,m)}$.  By \cref{boost-treewidth}, $\tw(G)\le \tw(U)+1\le t$.  By \cref{boost},
    $\trn(G)\ge hm+1 > hm \ge r$.

    % In the following calculation we ignore the ceilings in the definitions of $h$ and $m$.
    By \cref{boost-size},
    \begin{align*}
        |G| & \le (|U|\cdot m\cdot h)^{m} \\
        & \le \left((\log^{(t-2)} h)^{(t-1)h + o(h)}\cdot m\cdot h\right)^{m} \\
        & = (\log^{(t-2)} h)^{(t-1)r + o(r)}\cdot r^{m} \\
        & = (\log^{(t-1)} r)^{(t-1)r + o(r)}\cdot r^{r/log r+o(r)} \\
        % & \text{(since $h:=\log r$)}\\
        % & = (\log^{(t-1)} r)^{(t-1)r + o(r)}\cdot r^{r/\log r}
        % & \text{(since $m:=r/\log r$)}\\
        & = (\log^{(t-1)} r)^{(t-1)r + o(r)}\cdot e^{r+o(r)} \\
        & \le (\log^{(t-1)} r)^{tr + o(r)} & \text{(since $r\ge \tau(t)$, so $\log^{(t-1)} r\ge e$).} & \qedhere
    \end{align*}
\end{proof}

\begin{proof}[Proof of \cref{t-trees} (lower bound)]
    \Cref{treewidth-lower-bound} produces a graph $G$, $n:=|G|\le (\log^{(t-1)} r)^{tr+o(r)}$, $\tw(G)\le t$, and $\trn(G)\ge r$.  So,
    \[  \log n \le (tr+o(r))\log^{(t)} r = t\cdot(1+o(1))\trn(G)\log^{(t)} \trn(G)\]
    and attempting to solve for $\trn(G)$ shows that $\trn(G)\in \Omega(\log n/\log^{(t+1)} n)$.
\end{proof}

The lower bound construction in this section gives some guidance on how to obtain a matching upper bound for $\trn(G)$.  Specifically, for some node $a\in L_i$, the colouring of the component $X$ of $H[\{a\}\cup\bigcup_{j=i+1}^m L_j]$ that contains $a$ can create a lower bound on $\varphi(a)$.  Specifically, if two vertices $u,w\in V(X[L_{i+1}]$ receives the same colour $\phi$ then $\varphi(a)>\phi$.  This suggests that one should attempt to minimize the largest colour that this is repeated in the colouring of $X[L_{i+1}]$.  Indeed, this is a guiding principle in our upper bound proof.


%========================================================================
\section{Upper Bounds}
\label{upper-bounds}

In this section we prove asymptotically tight bounds for the worst-case number of colours needed for $\ell$-ranking simple treewidth-$t$ graphs, treewidth-$t$ graphs, planar graphs, and bounded genus graphs.

\subsection{Simple Treewidth-$t$ Graphs}

This section is devoted to proving the upper bound in \cref{simple-t-trees}:

\begin{namedtheorem}[\weirdref{simple-t-trees}{a}]\weirdlabel{simple-t-trees}{a}
    For fixed integers $\ell\ge 2$, $t\ge 1$, every $n$-vertex graph $H$ with $\stw(H)\le t$ has $\lrn(H)\in O(\log n/\log^{(t)} n)$.
\end{namedtheorem}

\weirdref{simple-t-trees}{a} immediately implies the upper bounds in \cref{planar,t-trees}:

\begin{proof}[Proof of \cref{planar} (upper bound)]
    By \cref{product-structure}, $G$ is a subgraph of $H\boxtimes K_3\boxtimes P$ where $|H|\le n$, $\stw(H)\le 3$, and $P$ is a path. Therefore,
    \begin{align*}
        \lrn(G) & \le \lrn(H\boxtimes K_3\boxtimes P) \\
                & \le \lrn(H)\cdot \dlcn(K_3\boxtimes P)
                    & \text{(by \cref{product-structure})}\\
                & \le 3(\ell+1)\cdot\lrn(H) & \text{(by \cref{dumb})} \\
                & \in O(\log n/\log^{(3)} n) & \text{(by \weirdref{simple-t-trees}{a}).} & \qedhere
    \end{align*}
\end{proof}

\begin{proof}[Proof of \cref{t-trees} (upper bound)]
    By \cref{simple-treewidth-vs-treewidth}, $\stw(H)\le\tw(H)+1\le t+1$ so, by   \weirdref{simple-t-trees}{a}, $\trn(H)\in O(n\log^{(t+1)}n)$.
\end{proof}

\weirdref{simple-t-trees}{a} also has the following corollary, which strengthens \cref{trees}:

\begin{cor}\label{outerplanar}
    For each fixed integer $\ell\ge 2$, every $n$-vertex outerplanar graph $G$ has $\lrn(G)\in O(\log n/\log^{(2)} n)$.
\end{cor}

\begin{proof}
    By \cref{simple-small-cases}{(ii)}, $\stw(G)\le 2$ so, by \weirdref{simple-t-trees}{a} $\lrn(G)\in O(\log n/\log^{(2)} n)$.
\end{proof}

The proof of \weirdref{simple-t-trees}{a} is the most technically demanding part of the paper and is the subject of most of this section.  Globally, the proof is by induction on the value of $t$, though it is easy to miss this, since it is spread over several lemmas. The case $t=1$ is easy: By \cref{simple-small-cases}(i), any graph of simple treewidth 1 is a contained in a path and therefore has an $\ell$-ranking using $\ell+1\in O(\log n/\log^{(1)} n) = O(1)$ colours.  In the proof of \cref{t-tree-slack}, below, we will apply \weirdref{simple-t-trees}{a} to graphs of simple treewidth $t-1$. \cref{t-tree-slack} is then used in the proof of \cref{t-tree-technical} which is used in the proof of \weirdref{simple-t-trees}{a}, at the end of this section.

% The proof of \weirdref{simple-t-trees}{a} is the most technically demanding part of the paper, so we give a brief overview of the proof strategy before delving into the details.  The proof is by induction on the value of $t$.  The base, $t=1$, is easy: By \cref{simple-small-cases}(i), every simple 1-tree is forest of paths, which has a 2-ranking using 3 colours.  In the general case, we need to prove that $H$ has a 2-ranking using colours $\{1,\ldots,ak\}$ for some constant $a$ and some $k\in O(\log n/\log^{(t)} n)$.  An asymptotically equivalent statement of this is: If $n \le (\log^{(t-2)}k)^k$, then $H$ has a 2-ranking using colours $\{1,\ldots,ak\}$, and this is the version of the statement that we prove.
%
% We use a BFS layering $L_1,\ldots,L_m$ of $H$ and use the fact (\cref{simple-bfs-layers}) that each layer $L_i$ induces a simple $(t-1)$-forest $H[L_i]$, on which we can apply \weirdref{simple-t-trees}{a} inductively.\footnote{Here, and throughout, we make use of the fact $\trn(H)$ is monotone: it does not decrease when edges are added to $H$ and the fact (\cref{simple-subgraph}) that any graph $H$ with $\stw(H)\le t$ is a subgraph of some simple $t$-tree $H'$ with $V(H')=V(H)$ and $E(H')\supseteq E(H)$.}  The main difficulty with this approach is that a vertex $v$ in $H[L_i]$ dominates an entire simple $(t-1)$-forest $F$ in $H[L_{i+1}]$.  If some colour $\phi$ is used more than once in the colouring of $F$, then $v$ must be assigned a colour larger than $\phi$.
%
% To account for this, we use a strengthening of \weirdref{simple-t-trees}{a} that applies to any graph $H'$ contained in $H[L_{i+1}\cup\cdots\cup L_m]$.  This strengthening shows that, if $H'$ has size at most $(\log^{(t-2)} k)^k/(\log^{(t-2)} c)^c$ then $H'$ has a 2-ranking using colours $\{1,\ldots,ak\}$ in which no colour larger than $a(k-c-1)$ appears more than once in the first layer, $H'[L_{i+1}]$.
% % In essence, the size of $H'$ provides a lower bound, $a(k-c-1)$, on the colour assigned to some vertex $v$ in $L_i$.
%
% It turns out to be easier to forget about $L_{i+1},\ldots,L_{m}$ and to work, instead, with an induced subgraph $H'$ of $H[L_{i+1}]$, in which each vertex $v$ is assigned a lower bound $a(k-\gamma(v)-1)$ on its colour.  This lower bound can also be interpreted as a weight, $(\log^{(t-2)}k)^k/(\log^{(t-2)}\gamma(v))^{\gamma(v)}$, that describes the size of the graph $H_v$ in $H[L_{i+1}\cup\cdots\cup L_m]$ whose first layer $H_v[L_{i+1}]$ is dominated by $v$.  The condition that $H'$ has size at most $(\log^{(t-2)} k)^k/(\log^{(t-2)} c)^c$ translates roughly into the condition
% \[
%    \sum_{v\in V(H')}\frac{(\log^{(t-2)}k)^k}{(\log^{(t-2)}\gamma(v)^{\gamma(v)}} \le \frac{(k\log^{(t-2)} k)^k}{(c\log^{(t-2)} c)^c}
% \]
% We are able to show that $H'$ has a special kind of separator $S$ of size $O(c)$ such that
% \begin{compactenum}
%     \item $H'[S]$ can be 2-ranked using $O(c)$ large colours in $\{a(k-c-1)+1,\ldots,ak\}$ that are each used only once; and
%     \item Each component of $H'-S$ can be 2-ranked using $O(k-c)$ small colours $\{1,\ldots,a(k-c-1)\}$.
% \end{compactenum}
% Each of these colourings respect the lower bounds given by $\gamma(v)$ for each vertex $v$ of $H'$.
%
% The preceding proof sketch ignores a difficulty caused by the fact that the components in $H[L_{i+1}\cup\cdots\cup L_m]$ are attached to $t$-cliques in $H[L_i]$ rather than individual vertices of $H[L_i]$. When we treat each of these forests individually, we run into the problem that there may be two $t$-cliques $C_1$ and $C_2$ of $H[L_i]$ with a vertex $v$ in common.  A simple $(t-1)$-forest $F_1$ attached to $C_1$ may avoid using colours larger than $a(k-c)$ more than once and a forest $F_2$ attached to $C_2$ may avoid using colours larger than $a(k-c-1)$ more than once.  Nevertheless, $F_1$ may have one vertex $u$ of colour $\phi >a(k-c-1)$ and $F_2$ may also have one vertex $w$ of colour $\phi$.  Since $uvw$ is a path in $H$, $v$'s colour must be larger than $\phi$.  We get around this by using an auxilliary colouring $\zeta$ of the $t$-cliques in $H[L_i]$ so that if two $t$-cliques $C_1$ and $C_2$ have a vertex in common and the preceding situation occurs, then $\zeta(C_1)\neq \zeta(C_2)$.  The vertices in $F_1$ receive the secondary colour $\zeta(C_1)$ and the vertices in $F_2$ receive the secondary colour $\zeta(C_2)$.  In this way, the vertices $u$ and $w$ described above receive different colours.
%
% With this proof sketch complete, we now begin with the actual proof.

\subsubsection{The Bread}

We begin with a few helper lemmas.

\begin{lem}\label{pathwidth}
    For any graph $G$, $\lrn(G)\le (\ell+1)\pw(G) + 1$.
\end{lem}

\begin{proof}
    The proof is by induction on $\pw(G)$.  The base case $\pw(G)=0$ is trivial: In this case, $G$ contains no edges and can be $\ell$-ranked with $1 = (\ell+1)\pw(G)+1$ colours.

    For $\pw(G)>1$, it is well known that $G$ contains a sequence of vertices $v_1,\ldots,v_m$  such that
    \begin{inparaenum}[(i)]
        \item $G$ contains no edge $v_iv_j$ with $|i-j|>1$;
        \item $G$ contains no path $v_iw v_j$ with $w\not\in\{v_1,\ldots,v_m\}$ and $|i-j|>1$; and
        \item $\pw(G-\{v_1,\ldots,v_m\})\le \pw(H)-1$.
    \end{inparaenum}
    Property~(iii) implies that we can therefore inductively colour $G-\{v_1,\ldots,v_m\}$ using colours $\{1,\ldots,(\ell+1)(\pw(G)-1)+1\}$ and then colour each $v_i$ with colour $(\ell+1)(\pw(G)-1)+2+i\bmod (\ell+1)$.  Property~(i) ensures that this gives a $\ell$-ranking of $G[v_1,\ldots,v_m]$.  Property~(ii) and the fact that $v_1,\ldots,v_m$ are coloured using larger colours than those used to colour $G-\{v_1,\ldots,v_m\}$ ensures that the resulting colouring is an $\ell$-ranking of $G$.
\end{proof}

\begin{lem}\label{path-induced}
    Let $P=x_1,\ldots,x_m$ be a path and let $G$ be a graph that is edge-maximal with respect to a width-$t$ $P$-decomposition $\mathcal{P}:=(B_x:x\in V(P))$ of $G$.  Then there exists a set $U$, such that
    \begin{compactenum}[(Z1)]
        \item $B_{x_1}\cup B_{x_m}\subseteq U \subseteq V(G)$;\label{values-u}
        \item $|U|\in O(\ell^t)$; and \label{size-u}
        \item for each non-trivial induced path $w_0,\ldots,w_q$ in $G$ with $q\le\ell$ and $\{w_0,w_q\}\in U$,  $\{w_1,\ldots,w_{q-1}\}\subseteq U$.\label{induced-u}
    \end{compactenum}
\end{lem}

\begin{proof}
    To eliminate a level of subscripts, let $x_i:=i$ for each $i\in\{1,\ldots,m\}$.  The proof is by induction on $t$. In the base case, $t=0$, $G$ has no edges and, unless $m=1$, there are no non-trivial paths $w_0,\ldots,w_q$ with $w_0\in B_{1}\cup B_m$. The lemma is satisfied by taking $U:=B_{1}\cup B_{m}$.  In this case $|U|\le 2\in O(\ell^0)$.

    Now assume that $t\ge 1$. If $G$ is not connected, then $B_{1}$ and $B_{m}$ are in difference components of $G$.  Choosing $U:=B_{1}\cup B_{m}$ satisfies the requirements of the lemma since the only paths $w_0,\ldots,w_q$ that need consideration have $\{w_0,w_q\}\subseteq B_1$ or $\{w_0,w_q\}\subset B_m$.  Since we only consider induced paths in $G$ and $G$ is edge-maximal with respect to $\mathcal{P}$, this implies that $q\in\{0,1\}$, so $w_0,\ldots,w_q$ is either a trivial path or a single edge. In either case $\{w_0,\ldots,w_q\}\subseteq U$.

    We may now assume that $G$ is connected and, without loss of generality, that $\mathcal{P}$ is smooth. For each $v\in V(G)$, let $r(v):=\max\{i\in\{1,\ldots,m\}:v\in B_i\}$.  Consider the \emph{greedy path} $u_0,\ldots,u_p$ that begins at $u_0\in B_{1}$, ends at $u_p\in B_{m}$, and is defined as follows: $u_0$ is the vertex in $B_{1}$ that maximizes $r(u_0)$.  For $i\ge 1$, $u_i$ is the vertex in $B_{r(u_{i-1})}$ that maximizes $r(u_i)$.\footnote{The article ``the'' in this and the preceding sentence is a deliberate choice. Since $\mathcal{P}$ is smooth, there is exactly one vertex $u_i$ in $B_{r(u_{i-1})}$ that maximizes $r(u_i)$.}  It is well known that $u_0,\ldots,u_p$ is a shortest path from $B_{1}$ to $B_{m}$, i.e., $p=\min\{d_H(w_0,w_q): w_0\in B_1,\, w_q\in B_m\}$.  Therefore, if $p>\ell$, the lemma is again trivially satisified by taking $U:=B_{1}\cup B_{m}$.
    % Indeed, we only need consider paths $w_0,\ldots,w_q$ of length $q\le\ell$ and any such path must have $\{w_0,w_q\}\

    Otherwise, $u_0,\ldots,u_p$ defines a sequence $y_0,\ldots,y_p$ of nodes in $P$, where $y_0:=1$ and, for each $i\in\{1,\ldots,p-1\}$, $y_{i}:=r(u_{i-1})$.  Consider a path decomposition $\mathcal{P'}:=(B'_x:x\in V(P))$  obtained by removing $u_i$ from $B_{j}$ for each $i\in\{0,\ldots,p\}$ and each $j\in\{y_i,\ldots,m\}$. Let $G'$ be the graph with $V(G'):=\bigcup_{x=1}^m B'_x$ that is edge-maximal with respect to $\mathcal{P}'$.  Observe $\mathcal{P'}$ has width at most $t-1$.

    For each $i\in\{1,\ldots,p\}$, let $G'_i:=G'[\bigcup_{j=y_{i-1}}^{y_i}B'_j]$ and $\mathcal{P}'_i:=(B'_x:x\in\{y_{i-1},\ldots,y_i\})$.
    Note that $G'_i$ may contain $u_i$ (if $u_i\in B_{y_i-1}$) but $G'_i$ does not contain $u_{i-1}$ because $u_{i-1}$ does not appear in $B_j$ for any $j\in\{y_{i-1},\ldots,m\}$.  For each $i\in\{1,\ldots,p\}$, we apply the lemma inductively to $G'_i$ and $\mathcal{P}'_i$ to obtain a set $U'_i$ of size $O(\ell^{t-1})$ that satisfies the requirements of the lemma for the graph $G'_i$. Let $U:=\{u_0,\ldots,u_p\}\cup\bigcup_{i=1}^p U'_i$.

    For each $i\in\{1,\ldots,p\}$, $U$ contains $u_{i-1}$ and $u_i$.
    To obtain $U_i'$ we apply induction on $G_i$ using a path decomposition on a path whose endpoints are $y_{i-1}$ and $y_i$ having bags $B'_{y_{i-1}}=B_{y_{i-1}}\setminus u_{i-1}$ and $B'_{y_{i}}=B_{y_{i}}\setminus u_{i}$.  Therefore $U$ contains $\{u_{i-1},u_i\}\cup B'_{y_{i-1}}\cup B'_{y_i}=B_{y_{i-1}}\cup B_{y_i}$.

    In particular, $U$ contains $B_{y_0}=B_1$ and $B_{y_p}=B_m$, so $U$ satisfies (Z\ref{values-u}). The size of $U$ satisfies the recurrence $f(0)\le 2$ and $f(t)\le \ell+1+\ell\cdot f(t-1)$, which resolves to $f(t)\le (3\ell^{t+1}-\ell^t-\ell-1)/(\ell-1) \in O(\ell^t)$, so $U$ satisifes (Z\ref{size-u}).  All that remains is to show that $U$ satisfies (Z\ref{induced-u}).  Consider some induced path $w_0,\ldots,w_q$ in $G$ of length at most $\ell$ with $\{w_0,w_q\}\subseteq U$.  We want to show that $\{w_1,\ldots,w_{q-1}\}\subseteq U$.

    We say that a vertex $w_i$ is \emph{pinched} if $w_i\in B_{y_j}$ for some $j\in\{0,\ldots,p\}$. (Note that each of $u_0,\ldots,u_p$ is pinched.) The edges of $w_0,\ldots,w_q$ can be partitioned into subpaths of the form $w_{a},\ldots,w_{b}$ where
    \begin{inparaenum}[(i)]
        \item $a=0$ or $w_a$ is pinched;
        \item $b=q$ or $w_b$ is pinched; and
        \item none of $w_{a+1},\ldots,w_{b-1}$ are pinched.
    \end{inparaenum}
    First note that, for any such subpath $w_a,\ldots,w_b$, $\{w_a,w_b\}\subseteq U$, so we need only show that $w_{a+1},\ldots,w_{b-1}$ is contained in $U$.  There are three cases to consider:

    \begin{compactenum}
       \item $\{w_a,w_b\}\subseteq B_{y_j}$ for some $j\in\{0,\ldots,p\}$.  Since $G$ is edge maximal with respect to $\mathcal{P}$, this implies  $w_aw_b\in E(G)$. Since $w_a,\ldots,w_b$ is an induced path in $G$, $b=a+1$ and there is nothing to prove.

       \item $\{w_a,w_b\}\in V(G_j')$ for some $j\in\{1,\ldots,p\}$ (and not the preceding case). In this case, edge maximality implies that $B_{y_{j-1}}$ and $B_{y_{j}}$ each form cliques that separate $G'_{j}$ from $G-V(G'_j)$.  Since $w_a,\ldots,w_b$ is an induced path in $G$, this implies that $\{w_a,\ldots,w_b\}\subseteq V(G_j')$.  Therefore, $w_a,\ldots,w_b$ is an induced path in $G_j'$ so, by the inductive hypothesis, $\{w_{a+1},\ldots,w_{b-1}\}\subseteq U_j'\subseteq U$.  (Note that this includes the special case in which $u_j\in\{w_a,\ldots,w_b\}$.)

       \item $w_a = u_j$ for some $j\in\{0,\ldots,p\}$ and $w_b\in V(G_{j+1}')$.  There are three subcases to consider:
       \begin{compactenum}
            \item $w_{a+1}\in B_{y_{j+1}}$.  In this case $b=a+1$ and there is nothing to prove.

            \item $w_{a+1}=w_q$. In this case $b=q=a+1$ and there is nothing to prove.

            \item Neither of the previous two cases. We argue that this is not possible, so the previous two cases are already exhaustive.  Since $w_{a+1}\not\in B_{y_{j+1}}$, $w_{a+1}\in V(G_{j+1}')\setminus B_{y_{j+1}}$. Since $w_{a+1}\neq w_q$, ${a+2}\le q$ and $w_{a+2}\in V(G_{j+1}')$.  However since $G$ is edge maximal with respect to $\mathcal{P}$, $N_G(u_j)\supseteq V(G_{j+1}')$. In particular, $w_aw_{a+2}\in E(G)$, contradicting the assumption that $w_0,\ldots,w_q$ is an induced path in $G$. \qedhere
        \end{compactenum}
    \end{compactenum}
\end{proof}

A node $x$ in a rooted tree $T$ is a \emph{branching node} if $x$ has at least two children.  Let $\Lambda(T)$ denote the set of branching nodes in a tree $T$.  Let $H$ be a graph that is edge maximal with respect to some tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$ of width at most $t$. We define the \emph{$(\mathcal{T},\ell)$-skeleton} $\hat{H}$ of $H$ as the induced subgraph of $H$ whose vertex set is defined as follows:
\begin{compactenum}
    \item $V(\hat{H})$ contains $\bigcup_{x\in\Lambda(T)} B_x$.

    \item For each pair of branching nodes $x,y\in\Lambda(T)$ such that the path $P_T(x,y)$ from $x$ to $y$ in $T$ has no branching node in its interior, $V(\hat{H})$ contains the set $U_{xy}\subseteq V(H)$ obtained by applying \cref{path-induced} to the graph $G_{xy}:=H[\bigcup_{z\in V(P_T(x,y))} B_z]$ with the path decomposition $\mathcal{P}_{xy}:=(B_z:z\in P_T(x,y))$.  (Note that $G_{xy}$ and $\mathcal{P}_{xy}$ satisfy the edge-maximality required for \cref{path-induced} since $H$ is edge-maximal with respect to $\mathcal{T}$.)
\end{compactenum}


\begin{lem}\label{skeleton-paths}
    Let $w_0,\ldots,w_q$ be an induced path in $H$ of length at most $\ell$ and with endpoints $\{w_0,w_q\}\subseteq V(\hat{H})$. Then $\{w_1,\ldots,w_{q-1}\}\subseteq V(\hat{H})$.
\end{lem}

\begin{proof}
    Partition the edges of $w_0,\ldots,w_q$ into paths of the form $w_a,\ldots,w_b$ such that
    \begin{inparaenum}[(i)]
        \item $a=0$ or $w_a\in\bigcup_{x\in \Lambda(T)} B_x$;
        \item $b=q$ or $w_b\in\bigcup_{x\in \Lambda(T)} B_x$; and
        \item none of $w_{a+1},\ldots,w_{b-1}$ are contained $\bigcup_{x\in \Lambda(T)} B_x$.
    \end{inparaenum}
    This means that $w_a,\ldots,w_b$ is contained in $G_{xy}$ for some $x,y\in \Lambda(H)$.  Therefore $\{w_a,\ldots,w_b\}\subseteq U_{xy}\subseteq U$, as required.
\end{proof}


\begin{lem}\label{skeleton-size}
    $|V_t|\le |\Lambda(T)|\cdot O(\ell^t)$.
\end{lem}

\begin{proof}
    This follows from \cref{path-induced} (Z\ref{size-u}) and the fact that there are $|\Lambda(T)|-1$ distinct pairs $x,y\in\Lambda(T)$ such that $P_T(x,y)$ has no internal nodes in $\Lambda(T)$.
\end{proof}


\begin{lem}\label{skeleton-colour}
    Let $H$ be a graph that is edge maximal with respect to some width-$t$ tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$ of $H$ that defines a $(\mathcal{T},\ell)$-skeleton $\hat{H}$, of $H$.  Then $\lrn(H)\in O(\lrn(\hat{H}))$.
\end{lem}

\begin{proof}
    Let $\varphi:V(\hat{H})\to \{(\ell+1)t+2,\ldots,\lrn(\hat{H})+(\ell+1)t+1\}$ be an $\ell$-ranking of $\hat{H}$. The graph $P:=T-\Lambda(T)$ consists of disjoint paths and, for any edge $vw\in E(H-\hat{H}))$ there is a node $x\in V(P)$ such that $\{v,w\}\subseteq B_x$.  Therefore $(B_x:x\in V(P))$ is a width-$t$ path decomposition of $H-V(\hat{H})$, so $\pw(H-V(\hat{H}))\le t$.  Therefore, by \cref{pathwidth}, $H-V(\hat{H})$ has an $\ell$-ranking $\varphi:V(H-V(\hat{H}))\to\{1,\ldots,(\ell+1)t+1\}$.  This gives a colouring $\varphi: V(H)\to\{1,\ldots,\trn(\hat{H})+(\ell+1)t+1\}$.

    We claim that $\varphi$ is an $\ell$-ranking of $\hat{H}$.  To see this, consider some path $u_0,\ldots,u_p$ with $\varphi(u_0)=\varphi(u_p)$.  We must show that $\varphi(u_i)>\varphi(u_0)$ for some $i\in\{1,\ldots,p-1\}$.
    By \cref{induced-paths-only}, we may assume that $u_0,\ldots,u_p$ is an induced path. There are a few cases to consider:
    \begin{compactenum}
        \item $\{u_0,u_p\}\subseteq V(H-V(\hat{H}))$. There are two subcases:
        \begin{compactenum}
            \item $\{u_1,\ldots,u_{r-1}\}\subseteq V(H-V(\hat{H}))$.  In this case, $u_0,\ldots,p_p$ is a path in $H-V(\hat{H})$, so  $\varphi(u_0)<\varphi(u_i)$ for some $i\in\{1,\ldots,p-1\}$ since \cref{pathwidth} ensures that $\varphi$ is an $\ell$-ranking of $H-V(\hat{H})$.

            \item $u_i\in V(\hat{H})$ for some $i\in\{1,\ldots,p\}$. In this case, $\varphi(u_0)\le (\ell+1)t+1 < (\ell+1)t+2 \le \varphi(u_i)$.
        \end{compactenum}
        \item $\{u_0,u_p\}\subseteq V(\hat{H})$.
        % In this case, \cref{induced-unimodal} implies that $u_0,\ldots,u_p$ is $\mathcal{T}$-unimodal, i.e., $u_0,\ldots,u_p$ is the concatenation of two paths, one upward and one downward.
        By \cref{skeleton-paths}  $\{u_0,\ldots,u_p\}\subseteq V(\hat{H})$, so  $\varphi(u_0)<\varphi(u_i)$ for some $i\in\{1,\ldots,p-1\}$ since $\varphi$ is an $\ell$-ranking of $\hat{H}$. \qedhere
    \end{compactenum}
\end{proof}

\subsubsection{The Meat}

Now we arrive at the combinatorial core of the proof. The main idea is break $H$ up into a sequence of blocks, each of which consists of $\ell+1$.  Each pair of consecutive blocks overlaps in a single layer.  The following lemma is what allows us to handle the first block.  The purpose of the weighting $(n_v:v\in V(H))$ is to allow us to account for the fact that this first block has more layers attached to it.

\begin{lem}\label{t-tree-slack}
Let $t,d,\ell,\beta\in\N$ be fixed values, let $k\in N$ and $c\in\R$ be such that $t\ge 2$ and $\tau(t-1)\le c\le k-1$; let $H$ be a graph with $\diam(H)\le d$ and $\stw(H)\le t$ in which each vertex $v\in V(H)$ is assigned a real-valued weight $n_v\ge 1$. Then there exists a constant $a:=a(t,\ell,d,\beta)$ such that, if
\begin{equation}
     \sum_{v\in V(H)} n_v \le \beta\cdot\frac{(\log^{(t-2)} k)^k}{(\log^{(t-2)} c)^{c}} \enspace ,
 \label{total-weight}
\end{equation}
and
\begin{equation}
     \max\{n_v:v\in V(H)\} \le \frac{(\log^{(t-2)} k)^k}{(\log^{(t-2)} (c+s))^{c+s}} \enspace ,
 \label{max-weight}
\end{equation}
where $s := \log c/\log^{(t-1)} c$,
% and if $\phi_1,\ldots,\phi_t'$ are distinct integers, each greater than $a(k-c-1)$,
then $H$ has an $\ell$-ranking $\varphi:V(H)\to a(k-c-1)$ such that $\varphi(v)> a(k-\gamma_{t-2,k}(n_v)-1)$ for each $v\in V(H)$.
% \begin{compactenum}[(P1)]
    % \item for each $i\in\{1,\ldots,{t'}\}$, $\varphi(v_i)=\phi_i$; and
    % \item for each $v\in V(H)\setminus B_p$, $a(k-\gamma(v)-1) < \varphi(v) \le a(k-c-1)$.
% \end{compactenum}
\end{lem}

\begin{proof}
    % For each node $x\in V(T)\setminus\{r\}$, let $T_x$ denote the subtree of $T$ induced by $x$ and all its $T$-descendants and let $H_x:=H[\bigcup_{y\in V(T_x)} B_y]-B_p$ where $p$ is the parent of $x$ in $T$.
    % Recall that, for $x\neq r$, $B_x$ contains exactly one vertex $v_1'$ that is not present in $B_p$ where $p$ is the $T$-parent of $x$.
    Without loss of generality, we may assume $H$ is edge maximal with respect to some $t$-simple tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$ of $H$ rooted at some node $r\in V(T)$ with $|B_p|=t$.  Let $L_0,\ldots,L_h$ be a BFS layering of $H$ with $L_0:=B_p$.  Note that $h\le\diam(H)\le d$.

    The proof is by induction on $|H|$.  In the base case, $|H|=0$ and there is nothing to prove.
    % $1\le|H|\le t$, in which case $T$ has only one node $r$. For each $i\in\{1,\ldots,t'\}$, we set $\varphi(v_i):=\phi_i$, in order to satisfy (P1).  In this case Condition (P2) is vacuous since it does not apply to vertices in $B_p$.
    Now assume $|H|\ge 1$.  For each subgraph $X$ of $H$, define
    $
        n_{X}:=\sum_{v\in V(X)} n_v
        % \frac{(\log^{(t-2)} k)^k}{(\log^{(t-2)}\gamma(v))^{\gamma(v)}} \enspace .
    $.
    Note that \cref{total-weight} implies that $n_H\le(\log^{(t-2)} k)^k/(\log^{(t-2)}c)^c$.  For $v\in V(H)$ we use the shorthand $\gamma_v:=\gamma_{t-2,k}(n_v)$ and for any subgraph $X$ of $H$ we use the shorthand $\gamma_X := \gamma_{t-2,k}(n_X)$.  Note that \cref{total-weight} implies that $\gamma_H \ge (\log c)^c$ and $\gamma_v\ge(\log(c+s))^{c+s}$ for each $v\in V(H)$.

    Let
    \begin{equation}
        n_0 := \frac{(\log^{(t-2)} k)^k}{\left(\log^{(t-2)}\left(c+s+\tfrac{\log(c+s)}{\log^{(t-1)}(c+s)}\right)\right)^{c+s+\tfrac{\log(c+s)}{\log^{(t-1)}(c+s)}}} \enspace . \label{heavy-def}
    \end{equation}
    We say that a subgraph $X$ of $H$ is \emph{heavy} if $n_X>n_0$ and $X$ is \emph{light} otherwise.  For a heavy subgraph $X$,
    \begin{equation}
        \frac{|H|}{n_X} < \frac{|H|}{n_0}
        \le \beta\cdot \frac{\left(\log^{(t-2)}\left(c+s+\tfrac{\log(c+s)}{\log^{(t-1)}(c+s)}\right)\right)^{c+s+\tfrac{\log(c+s)}{\log^{(t-1)}(c+s)}}}{(\log^{(t-2)} c)^c}
         \in O\left(c^4\right)
    \enspace ,
    \end{equation}
    where the upper bound of $O(c^4)$ is justified by a calculation given in \cref{calculation-i}.
    % since $c+s\in O(c)$.

    By \cref{weighted-separator} with the weight function $\xi(v):=n_v$, there exists $S_T\subseteq V(T)$ of size $O(c^4)$ that defines $S:=\bigcup_{x\in S_T} B_x$ such that each component $X$ of $H-S$ is light.  Let $T'$ be the subtree of $T$ induced by $S_T$ and every $T$-ancestor of every node in $S_T$, i.e., $T':=T[\bigcup_{x\in S_T} V(P_T(x))]$. Let $H':=H[\bigcup_{x\in V(T')} B_x]$.  Observe that $\mathcal{T'}:=(B_x:x\in V(T'))$ is a $t$-simple tree decomposition of $H'$, so $\stw(H')\le t$.

    For each $i\in\{0,\ldots,h\}$, let $H'_i:=H'[L_i]$.  By \cref{simple-bfs-layers},  $\stw(H'_i)\le\stw(H[L_i])\le t-1$.  Furthermore, $\mathcal{T}'_i:=(B_x\cap L_i: x\in V(T'))$ is a tree decomposition of $H'_i$ and $H'_i$ is edge maximal with respect to $\mathcal{T}'_i$.
    % \footnote{Although, $\mathcal{T}'_i$ has width at most $t-1$, it is not necessarily a $(t-1)$-simple tree decomposition. We don't need it to be.}
    Each leaf $x$ of $T'$ is an element of $S_T$, therefore $T'$ has at most $|S_T|\in O(c^4)$ leaves. Since $T'$ has $O(c^4)$ leaves, it has $O(c^4)$ branching nodes.  Therefore, by \cref{skeleton-size}, the $(\mathcal{T}_i',\ell)$-skeleton $\hat{H}_i'$ of $H_i'$ has size $|\hat{H_i}'|\in O(c^4)$.

    By \weirdref{simple-t-trees}{a} applied to the graph $\hat{H}_i'$ (which has simple treewidth at most $t-1$),
    \[
       \lrn(\hat{H_i}')\in
       O\left(\frac{\log|\hat{H_i}'|}{\log^{(t-1)}|\hat{H_i}'|}\right)
       \subseteq O\left(\frac{\log c^4}{\log^{(t-1)} c^4}\right)
       = O\left(\frac{\log c}{\log^{(t-1)} c}\right)
       = O(s) \enspace .
    \]
    Therefore, by \cref{skeleton-colour} $\lrn(H_i')\in O(s)$, so
    $H_i'$ has an $\ell$-ranking $\varphi:V(H_i')\to \{\lceil a(k-c-1)\rceil-(i+1)q-1,\ldots,\lceil a(k-c-1)\rceil-iq-1\}$ for some $q\in O(s)$.

    In the preceding paragraphs, we have defined a colouring $\varphi: V(H')\to \{a(k-c-1)-(h+1)q,\ldots,a(k-c-1)\}$. For a sufficiently large constant $a:=a(t,\ell,d,\beta)$, $(h+1)q < as$, so $\lceil a(k-c-1)\rceil-(h+1)q >  a(k-c-s-1)$. Therefore, each vertex in $H'$ receives a colour larger than $a(k-c-s-1)$. By \cref{max-weight}, $\gamma_v\ge c+s$ for each $v\in V(H)$, so $\varphi(v)> a(k-c-s-1) \ge a(k-\gamma_v-1)$ for each $v\in V(H')$, as required.

    Since $S':=V(H')\supseteq S$, each component $X$ of $H-V(H')$ is light, so
    \[
       n_{X} \le \frac{(\log^{(t-2)} k)^k}{
        \left(
            \log^{(t-2)}
                \left(
                   c+s+\tfrac{\log(c+s)}{\log^{(t-1)}(c+s)}
               \right)
        \right)^{\left(
           c+s+\tfrac{\log(c+s)}{\log^{(t-1)}(c+s)}
       \right)}
       }
   \]
   Therefore, we can apply \cref{t-tree-slack} inductively on each component $X$ of $H-S'$ since $|X|<|H|$ and $X$ satisfies \cref{total-weight} with the value $c'=c+s$ and \cref{max-weight} with the value $s'=\log c'/\log^{(t-1)} c'$.\footnote{Indeed, $\sum_{v\in V(X)} n_x\le n_0$, so $\max\{n_v:v\in V(X)\}\le n_0= (\log^{(t-2)} k)^k/(\log^{(t-2)}(c'+s'))^{c'+s'}$.}  This gives an $\ell$-ranking $\varphi:V(X)\to\{1,\ldots,a(k-c'-1)\}$ in which $\varphi(v)> a(k-\gamma_v-1)$ for each $v\in V(X)$, as required.
   Doing this for each component $X$ of $H-S'$ completes the colouring $\varphi$ to a total colouring of $H$.

   All that remains is to verify that $\varphi$ is an $\ell$-ranking of $H$. To do this, consider any path $u_0,\ldots,u_p$ in $H$ with $\varphi(u_0)=\varphi(u_p)$.  By \cref{induced-paths-only} we may assume that $u_0,\ldots,u_p$ is an induced path in $H$.  We must show that $\varphi(u_0)<\varphi(u_j)$ for some $j\in\{1,\ldots,p-1\}$. There are a few cases to consider:
   \begin{compactenum}
        \item If $\varphi(u_0)=\varphi(u_p) > a(k-c'-1)$ then $\{u_0,u_p\}\subseteq V(H')$.  By \cref{induced-unimodal}, $x_T(u_i)$ is a $\mathcal{T}$-ancestor of at least one of $x_T(u_0)$ or $x_T(u_p)$ for each $i\in\{0,\ldots,p\}$.  By construction, $T'$ contains every $T$-ancestor of $x_T(u_0)$ and $T'$ contains every $T$-ancestor of $x_T(u_p)$.  Therefore $\{u_0,\ldots,u_p\}\subseteq \bigcup_{x\in V(T')} B_x=V(H')$.

        For distinct $i$ and $j$ vertices in $H'_i$ and $H'_j$ receive colours from disjoint sets.  Therefore, since $\varphi(u_0)=\varphi(u_p)$,  $\{u_0,u_p\}\subseteq V(H'_i)$ for some $i\in\{0,\ldots,h\}$.  By \cref{order-relation,induced-unimodal}, $\{u_0,\ldots,u_{r}\}\subseteq \bigcup_{j=0}^{i} V(H'_j)$.  There are two cases to consider:
        \begin{compactenum}
           \item $\{u_0,\ldots,u_{r}\}\subseteq V(H'_i)$ in which case $\varphi(u_j)>\varphi(u_0)$ for some $j\in\{1,\ldots,p-1\}$ since $\varphi$ is an $\ell$-ranking of $H'_i$ (by the application of \cref{skeleton-colour} to $H'_i$); or
           \item $u_j\in V(H'_{i-1})$ for some $j\in\{1,\ldots,p-1\}$.  In this case $\varphi(u_j)>a(k-c-1)-iq > a(k-c-1)-(i+1)q \ge \varphi(u_0)$.
       \end{compactenum}
       \item If $\varphi(u_0)=\varphi(u_p) \le a(k-c'-1)$ then $u_0\in V(X)$ and $u_p\in V(Y)$ for some components $X$ and $Y$ of $H-S'$.  Either
       \begin{compactenum}
            \item $u_j\in S'=V(H')$ for some $j\in\{1,\ldots,p-1\}$ in which case $\varphi(u_j)>a(k-c'-1)\ge\varphi(u_0)$; or
            \item $X=Y$ and $\{u_0,\ldots,u_p\}\subseteq V(X)$, in which case $\varphi(u_j)>\varphi(u_0)$ for some $j\in\{1,\ldots,p\}$ (by the application of \cref{t-tree-slack}, inductively, on $X$). \qedhere
        \end{compactenum}
    \end{compactenum}
\end{proof}

% The next lemma helps deal with the case where we don't necessarily have the slack $s$ required to apply \cref{t-tree-slack}.  In this case we use the top $O(c)$ colours (which we can only use once) to colour a separator, $S$ of $H$ so that each component of $H-S$ has the slack needed to apply \cref{t-tree-slack}.
%
% \begin{lem}\label{t-tree-no-slack-separator}
%     Let $t,k\in\N$ and $c\in\R$ with $t\ge 2$ and $\tau(t)\le c\le k-1$; let $H$ be a graph with $\tw(H)\le t-1$; let $\mathcal{T}:=(B_x:x\in V(T))$ be a tree decomposition of $H$ of width at most $t-1$;
%     % let $H$ be a simple $(t-1)$-tree; let $t':=\min\{t, |H|\}$; let $v_1,\ldots,v_{|H|}$ be a construction order for $H$ generating a canonical tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$ of $H$ rooted at $r\in V(T)$;
%     let $\gamma:V(H)\to\{z\in\N: z\ge \tau(t-1)\}$; and let
%     \[
%         n_H:=\sum_{v\in V(H)} \frac{\left(\log^{(t-2)} k\right)^k}{\left(\log^{(t-2)} \gamma(v)\right)^{\gamma(v)}} \enspace .
%     \]
%     There exists an integer constant $a>0$ such that,
%     if
%     \begin{equation}
%          n_H \in O\left( \frac{(\log^{(t-2)} k)^k}{(\log^{(t-2)} c)^{c}} \right)\enspace ,
%      \label{total-weight-ii}
%     \end{equation}
%     then there exists $S_T\subseteq V(T)$ defining $S:=\bigcup_{x\in S_T} B_x$ such that
%     \begin{compactenum}
%         \item $|S_T|\in O(c)$ and therefore $|S|\le (t+1)|S_T|\in O(c)$; and
%         \item For each component $X$ of $H-S$,
%         \[
%             n_X:=\sum_{v\in V(X)} \frac{\left(\log^{(t-2)} k\right)^k}{\left(\log^{(t-2)} \gamma(v)\right)^{\gamma(v)}}
%             \le n_0 :=
%             \frac{\left(\log^{(t-2)} k\right)^k}{\left(\log^{(t-2)} (c+s)\right)^{c+s}}
%         \]
%         where $s:=\log c/\log^{(t+1)} c$.
%     \end{compactenum}
% \end{lem}
%
% \begin{proof}
%     We say that a subgraph $H'$ of $H$ is \emph{heavy} if    $n_{H'}:=\sum_{v\in V(H')} > n_0$ and, $H'$ is \emph{light}, otherwise.
%     A computation similar to \cref{sizer} (see \cref{calculation}) shows that
%     $n_H/n_0 \in O(c)$.  The result now follows by applying \cref{weighted-separator} with the weight function $\xi:V(H)\to\R$ defined by $\xi(v):=(\log^{(t-2)} k)^k/(\log^{(t-2)} c)^{c}$.
% \end{proof}

% We are now ready to prove the technical statement that implies \weirdref{simple-t-trees}{a}.
% Note that in the following statement $H$ is a $t$-tree, no longer a $(t-1)$-tree.  This is the whole enchilada:

% \begin{lem}\label{two-tree-technical}
%
%     For every fixed positive integer $t$ there exist an integer constant $a>0$ such that, for every integer $k\ge \tau(t)$, every $n\le (\log^{(t-2)} k)^{k}$, and every graph $H$ with $\stw(H)\le t$, $\trn(H)\le ak$.
% \end{lem}
%
% \begin{proof}
%     Assume $n\ge t+1$, otherwise the result is obtained trivially for any $a\ge t+1$ by colouring each vertex of $H$ with a distinct colour.
%
%     By \cref{simple-subgraph} we may assume, without loss of generality, that $H$ is a simple $t$-tree.

Since our strategy is to use \cref{t-tree-slack} on the first $\ell+1$ BFS layers of $H$ and then recurse on the subgraphs attached to layer $\ell+1$, we need to define vertex weights $n_v$ that allow us to capture the sizes of the subgraphs attached to vertices in layer $\ell+1$.  The following lemma shows that the obvious approach to this does not overcount by more than a factor of $t$.

\begin{lem}\label{size-claim}
    Let $H$ be a graph that is edge maximal with respect to a tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$ of width at most $t$, let $T$ be rooted at $r\in V(T)$, and let $\mathcal{L}:=L_0,\ldots,L_m$ be a BFS layering of $H$ with $L_0=B_p$.  For each $i\in\{0,\ldots,m\}$ and each $v\in L_i$, let $H_v$ be the component of $H[\{v\}\bigcup_{j=i+1}^m L_j]$ that contains $v$ and let $\kappa_v:= t-1+|X_v|$.  Then $\sum_{v\in L_i} \kappa_v \le t\cdot|H|$.
\end{lem}

\begin{proof}
    For each component $X$ of $H[\bigcup_{j=i+1}^m L_j]$, let $C_X:=L_i\cap \bigcup_{w\in V(X)} N_H(w)$.  By \cref{up-neighbours}, $|C_X|\le t$ and a vertex $w\in V(X)$ appears in $H_v$ if and only if $v\in C_X$.  Therefore,
    \[
        \sum_{v\in L_i} \kappa_v \le t\cdot|L_i| + \sum_{X}|C_X|\cdot|X| \le t\cdot|L_i| + \sum_{X}t\cdot|X|\le t\cdot|H| \enspace .  \qedhere
    \]
\end{proof}

Finally, we can prove the technical lemma that implies \weirdref{simple-t-trees}{a}.

\begin{lem}\label{t-tree-technical}
    Let $n,k,t,\ell\in N$ and $c\in\R$ be such that $n\le (\log^{(t-2)} k)^k/(\log^{(t-2)} c)^{c}$;
    let $H$ be an $n$-vertex graph that is edge maximal with respect to some $t$-simple tree decomposition $\mathcal{T}:=(B_x:x\in V(T))$ of $H$ rooted at $r\in V(T)$; and
    let $B_p:=\{v_1,\ldots,v_{t}\}$; and
    let $L_0,\ldots,L_m$ be a BFS layering of $H$ with $L_0:=B_p$.

    Then, there exists an integer $a:=a(t,\ell)$ such that, for any distinct $\phi_0,\ldots,\phi_{t'}\in \{\lfloor a(k-c-1)\rfloor+1,\ldots,ak\}$ there exists an $\ell$-ranking $\varphi:V(G)\to\{1,\ldots,ak\}$ such that
    \begin{compactenum}[(R1)]
        \item $\varphi(v_i)=\phi_i$ for each $i\in\{1,\ldots,t'\}$; and
        \item $\varphi(v)<a(k-c-1)$ for each $v\in\bigcup_{j=1}^{\ell} L_i$.
    \end{compactenum}
\end{lem}

\begin{proof}
    The proof is by induction on $n$. If $n=0$, then there is nothing to prove.

    Let $n_0:=(\log^{(t-2)} k)^k/(\log^{(t-2)} (c+s))^{c+s}$ and, for each $v\in V(H)$, let $\kappa_v$ be defined as in \cref{size-claim}.  We say that a vertex $v\in L_{\ell+1}$ is \emph{dangerous} if $\kappa(v)>n_0$ and $v$ is \emph{harmless} otherwise.

    We now assign weights to the vertices of the graph $H_0:=H[\bigcup_{j=0}^{\ell+1}]$ in such a way that we can apply \cref{t-tree-slack} to $H_0$.  For each $v\in\bigcup_{j=0}^\ell L_j$, we set $n_v:=1$.  For each $v\in L_{\ell+1}$, we set $n_v := \min\{n_0, \kappa_v\}$.  With this assignment of weights, \cref{size-claim} implies that $\sum_{v\in V(H_0)} n_v\le tn$, which satisifies \cref{total-weight} with $\beta=t$ and, by definition, $\max\{n_v:v\in V(H_0)\}\le n_0$ which satisfies \cref{max-weight}.

    Again, we use the shorthand $\gamma_v := \gamma_{t-2,k}(n_v)$.    Therefore, by \cref{t-tree-slack}, $H_{0}$ has an $\ell$-ranking $\varphi:V(H_0)\to\{1,\ldots,\lfloor a(k-c-1)\rfloor\}$ in which $\varphi(v)> a(k-\gamma_v-1)$ for each $v\in V(H_0)$.
    By \cref{size-claim}, the number of dangerous vertices is at most
    \[
        \frac{tn}{n_0} \in O\left(\frac{(\log^{(t-2)} (c+s))^{c+s}}{(\log^{(t-2)} c)^c}\right) \in O(c) \enspace ,
    \]
    where the $O(c)$ upper bound is justified by a calculation in \cref{calculation-ii}.
    Before continuing, we make the following modifications to $\varphi$.

    \begin{compactenum}
        \item We set $\varphi(v_i):=\phi_i$ for each $i\in\{1,\ldots,t'\}$.
        \item For each dangerous vertex $v$, we set $\varphi(v)$ to a distinct value in $\{\lfloor a(k-c-1)\rfloor+1,\ldots,ak\}\setminus\{\phi_1,\ldots,\phi_t\}$. (Since the number of dangerous vertices is $O(c)$, this is always possible.)
    \end{compactenum}
    These modifications ensure that $\varphi$ satisfies requirements (R1) and (R2) and, since they only introduce new unique colours larger than any existing colour, they preserve the fact that $\varphi$ is an $\ell$-ranking of $H_0$.

    For each component $X$ of $H-H_0$, let $C_X:=L_i\cap \bigcup_{w\in V(X)} N_H(w)$ and let $H_X:=H[C_X\cup V(X)]$.  Recall that $|C_X|\le t$ (this is the same $C_X$ described in the proof of \cref{size-claim}).  We apply induction on $H_X$ for each component $X$ of $H-H_0$ using colours $\phi_1',\ldots,\phi_{t'}'$ already assigned to the vertices in $C_X$.
    When we do this, we obtain an $\ell$-ranking of $H_X$ in which each vertex $w$ of $X[\bigcup_{j=\ell+2}^{2\ell+1} L_j]$ receives a colour $\varphi(w) \le a(k-\gamma_{t-2,k}(|H_X|)-1)$.

    For each harmless vertex $v\in C_X$, $X$ is a subgraph of $H_v$, so $n_v\ge t+|X|\ge |C_X|+|X|= |H_X|$, so $\gamma_v \le \gamma_{t-2,k}(|H_X|)$. Therefore each harmless $v\in C_X$ is assigned a colour larger than each vertex $w$ in $X[\bigcup_{j=\ell+2}^{2\ell+1} L_j]$.  For each dangerous vertex $v\in C_X$, $\varphi(v)>a(k-c-1)$.  Since $|H_X|\le|H|$, $\gamma_{t-2,k}(|H_X|) \ge c$.  Therefore each dangerous vertex $v\in C_X$ also receives a colour larger than each vertex $w$ in $X[\bigcup_{j=\ell+2}^{2\ell+1} L_j]$.

    All that remains is to verify that the resulting colouring is, indeed, an $\ell$-ranking of $H$.  Consider some induced path $u_0,\ldots,u_p$ in $H$ of length $r\le\ell$ such that $\varphi(u_0)=\varphi(u_p)$.  There are some cases to consider:

    \begin{compactenum}
        \item $\{u_0,u_p\}\subseteq V(H_0)$. In this case, \cref{order-relation,induced-unimodal} imply that $\{u_0,\ldots,u_p\}\subseteq V(H_0)$.  However, we have already established that $\varphi$ is an $\ell$-ranking of $H_0$ through the application of \cref{t-tree-slack} and the subsequent recolouring of vertices in $L_0$ and $L_{\ell+1}$.  Therefore, $\varphi(u_0)<\max\{\varphi(u_0),\ldots,\varphi(u_p)\}$.

        \item $u_0\in V(X)$ for some component $X$ of $H-H_0$ and $u_i\in C_X$ for some $i\in\{1,\ldots,p-1\}$.  Since $i<p\le\ell$, this implies that $u_0\in\bigcup_{j=\ell+2}^{\ell+r+1} L_j\subseteq \bigcup_{j=\ell+2}^{2\ell+1}L_j$.  We have already argued above that this implies that $\varphi(u_i)>\varphi(u_0)$.

        \item $\{u_0,\ldots,u_p\}\subseteq V(H_C)$ for some $t$-clique $C$ in $H[L_{\ell+1}]$.  In this case, the inductive hypothesis ensures that $\varphi$ is an $\ell$-ranking of $H_C$, so $\varphi(u_0)<\max\{\varphi(u_0),\ldots,\varphi(u_p)\}$. \qedhere
    \end{compactenum}
\end{proof}

%
%     let $L_0,\ldots,L_m$ be a BFS layering of $H$ with $L_0:=B_p$; and .
% \end{lem}
%
%     The following technical claim essentially implies \cref{two-tree-technical}, but is suitable for induction on the layer $i$.
%
%     \begin{clm}\label{main-claim}
%         Let $H'$ be the union of one or more connected components of $H[\bigcup_{j=i}^m L_i]$. There exists a constant $a$ such that, if
%         \begin{equation}
%             \sum_{v\in V(H'[L_i])} n_v\le \frac{(\log^{(t-2)} k)^{k}}{(\log^{(t-2)} (c+s))^{c+s}} \enspace , \label{main-size}
%         \end{equation}
%         where $s:=\log c/\log^{(t-1)} c$,
%         then there exists $\varphi:V(H')\to\{1,\ldots,ak\}$ and $\psi:V(H')\to\{0,\ldots,t^{\ellt}-1\}$ such that
%         \begin{compactenum}[(P1)]
%             \item The function $\theta:V(H')\to\{1,\ldots,3t^{\ellt}ak\}$ defined by $\theta(v)=3t^{\ellt}\varphi(v) - 3\psi(v) -(\ell(v)\bmod 3)$ is a 2-ranking of $H'$;
%             \item for each $v\in V(H'[L_i])$, $\psi(v)=0$; and
%             \item for each $v\in V(H'[L_i])$, $\varphi(v)\le a(k-c-1)$.
%         \end{compactenum}
%     \end{clm}
%
%     \begin{proof}[Proof of \cref{main-claim}]
%         [TODO: The lemma wants $H'$ to be the union of connected components of $H[\bigcup_{j=i}^m L_i]$, but when we recurse, we give it $H^-_v:=H_v-\bigcup_{v'\in V(H'[L_i])} S_{v'}$.]
%
%         % In all cases, (P2) requires setting $\psi(v)=0$ for all $v\in V(H'[L_i])$, so we do this now and will not mention it again.
%         % By \cref{simple-subgraph}, we may assume that $H'[L_i]$ is a simple $(t-1)$-tree.
%
%         The proof is by induction on $m-i$. In the base case $m-i=0$, so $H'$ is a subgraph of $H[L_m]=H[L_i]$. By \cref{simple-bfs-layers} $\stw(H')\le \stw(H[L_i])\le t-1$.  Then, for each $v\in L_i$, $n_v=\tau(t-1)$.  Then
%         \begin{align*}
%             \sum_{v\in V(H')} \frac{(\log^{(t-2)} k)^k}{(\log^{(t-2)} \gamma(v))^{\gamma(v)}}
%             & = \sum_{v\in V(H')} n_v \\
%             % & = \tau(t-1)\cdot|H'| \\
%             % & \le \sum_{v\in V(H'[L_i])} n_v  & \text{(by \cref{size-claim})}\\
%             & \le \frac{(\log^{(t-2)} k)^{k}}{(\log^{(t-2)} c)^c} & \text{(by \cref{main-size})} \enspace .
%         \end{align*}
%         Applying \cref{t-tree-slack} to $H'$ gives a colouring $\varphi: V(H')\to\{1,\ldots,ak\}$ that satisfies (P1) and (P3).  To satisfy (P2) we set $\psi(v):=0$ for each $v\in V(H')$.  This handles the case $i=m$.
%
%         Before proceeding with the inductive step, we give some intuition and definitions for the secondary colouring $\psi$. For each $i\in\{1,\ldots,m\}$, $\tw(H[L_i])\le \stw(H[L_i])\le t$. Therefore, there exists a colouring $\zeta:V(H)\to\{0,\ldots,t-1\}$ such that $\zeta$ is a proper colouring of $H[L_i]$ for each $i\in\{1,\ldots,m\}$. For each $j\in\{1,\ldots,\ellt\}$, each $v\in H'[L_{i+j}]$, and each $s\in\{1,\ldots,j\}$, we will associate the vertex $v$ with a specific vertex $p_s(v)\in V(H'[L_{i+j-s}])$.  In this way, $v$ gets a $\ellt$-vector of colours $(\psi_1(v),\ldots,\psi_{\ellt-1}(v))$, where
%         \[
%             \psi_s(v) :=
%                 \begin{cases}
%                     \zeta(p_s(v)) & \text{if $s\in\{1,\ldots,j\}$} \\
%                     0             & \text{if $s\in\{j+1,\ldots,\ellt\}$.}
%                 \end{cases}
%         \]
%         This vector then defines the colour $\psi(v):=\sum_{s=1}^\ellt t^{i-1}\psi_s(v)$.
%
%         We now proceed with the inductive step, so $i\in\{0,\ldots,m-1\}$.
%         Now,
%         \[
%             \sum_{v\in V(H'[L_i])}\frac{(\log^{(t-2)} k)^k}{(\log^{(t-2)} \gamma(v))^{\gamma(v)}}
%             = \sum_{v\in V(H'[L_i])} n_v
%             \le \frac{(\log^{(t-2)} k)^k}{(\log^{(t-2)} (c+s))^{c+s}} \enspace .
%         \]
%        Therefore $\gamma$ satisfies the requirements for \cref{t-tree-slack}, so we can find a 2-ranking of $H'[L_i]$ that satisfies (P3) and satisfies (P1), at least for the graph $H'[L_i]$. In addition $\varphi(v)> a(k-c-\gamma(v)-1)$ for each $v\in V(H'[L_i])$.  We will show how to can extend $\varphi$ to a complete colouring of $H'$.
%
%        The next step is use \cref{t-tree-no-slack-separator} to break $H'-L_i$ into sufficiently small components.  For any $v\in H'[L_{i]}]$, define
%        \begin{align*}
%           n_{H^+_v} & := \sum_{w\in V(H^+_v)[L_{i+1}]} n_w \\
%                     & \le \tau(t-1)\cdot|H^+_v| & \text{(by \cref{size-claim})} \\
%                     & \le \tau(t-1)\cdot n_v & \text{(by \cref{size-claim})} \\
%                     & = \tau(t-1)\cdot\left(\frac{(\log^{(t-2)}k)^k}{(\log^{(t-2)}\gamma(v))^{\gamma(v)}}\right)
%                     & \text{(by definition of $\gamma(v)$)} \\
%                     & \in O\left(\frac{(\log^{(t-2)}k)^k}{(\log^{(t-2)}\gamma(v))^{\gamma(v)}}\right) &\text{(for $t\in O(1)$)}
%        \end{align*}
%        Therefore, $\gamma$ satisifies the conditions for applying \cref{t-tree-no-slack-separator} to $H^+_v[L_{i+1}]$.  Therefore, there exists a set $S_v\subseteq H^+_v[L_{i+1}]$ of size $O(\gamma(v)+1)$ such that each component $X$ of $H^+_v-S_v$ has $n_X\le (\log^{(t-2)} k)^k/(\log^{(t-2)} (\gamma(v))+s(v))^{\gamma(v)+s(v)}$, where $s(v):=\log\gamma(v)/\log^{(t-1)}\gamma(v)$.
%
%        Let $\zeta:V(H'[L_i])\to\{0,\ldots,t-1\}$ be a proper colouring of $H'[L_i]$.  Assign each of the vertices in $S_v$ a distinct colour $\varphi(w)$ from the set $\{\lfloor a(k-\gamma(v))\rfloor+1,\ldots,ak\}$.  In addition, assign $\psi(w):=\zeta(v)$.  Note that, if we do this for each $v\in V(H'[L_i])$ there may be some vertices $w\in L_{i+1}$ that are assigned colours $\varphi(w)$ and $\psi(w)$ more than once.  In this case, we arbitrarily choose one of the vertices $v\in H'[L_i]$ such that $w\in S_v$ and use the colours $\varphi(w)$ and $\psi(w)$ assigned to $w$ by $v$.
%
%        Recall that, for each vertex $w$ in $L_{i+1}$, the \emph{dominant parent} $p(w)$ of $w$ is in $L_i$ (\cref{dominant-parent}).  In particular, for any $w\in V(H'[L_{i+1}])$, $p(w)\in V(H'[L_{i}])$.
%        For each vertex $v$ in $H'[L_i]$ we define $D_v:=\{w\in H'[L_{i+1}]: p(w)=v\}$.  For each $v\in V(H'[L_i])$, define the graph $H_v$ to be the component of $H'[D_v\cup \bigcup_{j=i+2}^m L_j]$ that contains $D_v$.  Note that $H_v$ is a subgraph of $H^+_v$.
%
%        There are some vertices $w$ in $H_v[L_{i+1}]$ that have already been assigned colours $\varphi(w)$ and $\psi(w)$ because $w\in S_{v'}$ for some $v'\in V(H'[L_i])$.  Consider the \emph{uncoloured graph} $H^-_v:=H_v-\bigcup_{v'\in V(H'[L_i])} S_{v'}$.  Since $H^-_v\subseteq H_v\subseteq H^+_v$, any component $Y$ of $H^-_v$ has $n_Y\le (\log^{(t-2)} k)^k/(\log^{(t-2)} (\gamma(v))+s(v))^{\gamma(v)+s(v)}$.  Furthermore, if $Y$ is a subgraph of $H_C$ for some $t$-clique $C$ in $H'[L_i]$, then
%        \begin{equation}
%         n_Y \le \min_{v'\in C}\left(\frac{(\log^{(t-2)}k)^k}{(\log^{(t-2)} (\gamma(v'))+s(v'))^{\gamma(v')+s(v')}} \right) \enspace . \label{min}
%         \end{equation}
%        Again, this is because $Y\subseteq Y^+$ where $Y^+$ is a component of $H_C\subseteq H^+_{v'}$ and each component $Y'$ of $H^+_{v'}-S_{v'}$ has $n_{Y'}\le (\log^{(t-2)}k)^k/(\log^{(t-2)} (\gamma(v'))+s(v'))^{\gamma(v')+s(v')}$.
%
%        We apply the inductive hypothesis to each component $Y$ of $H^-_v$ and we obtain $\varphi:V(H^-_v)\to\{1,\ldots,ak\}$ and $\psi:V(H_w)\to\{0,1\}$ that satisfy the conditions of the claim.  We do this to colour $H^-_v$ for each $v\in V(H'[L_i])$.
%
%        At this point colourings $\varphi:V(H')\to\{1,\ldots,ak\}$ and $\psi:V(H')\to\{0,1\}$ are completely defined.  We must, however, make one small modification to $\psi$.  Since each vertex in $H'[L_{i+1}]$ is coloured by induction on some component of $H^-_v$ for some $v\in V(H'[L_i])$, $\psi(w)=0$ for each $w\in V(H'[L_{i+1}])$, and we are free to change this.
%        % Now, the graph $H'[L_i]$ is a $(t-1)$-forest and therefore has a proper $t$-colouring $\zeta:V(H'[L_i])\to\{0,\ldots,t-1\}$.
%        Recall that $\zeta:V(H'[L_i])\to\{0,\ldots,t-1\}$ is a proper $t$-colouring of $H'[L_i]$.  For each vertex $v$ in $H'[L_i]$ and each vertex $w$ in $H^-_v[L_{i+1}]$ we set $\psi(w):=\zeta(v)=\zeta(p(w))$.  This completes the description of the colourings $\varphi$ and $\psi$.
%
%        We have already ensured that $\varphi$ and $\psi$ satisfy (P2) and (P3). All that remains is to ensure that they satisfy (P1).  To do this, consider some path $uvw$ in $H'$.  We must show that $\theta(u)\neq\theta(w)$ or $\theta(u)<\theta(v)$.  There are a few cases to consider (see \cref{cases}):
%        \begin{figure}
%             \centering{
%                 \begin{tabular}{|c|c|c|}\hline & & \\[.1mm]
%                     \includegraphics{figs/cases-1} &
%                     \includegraphics{figs/cases-2} &
%                     \includegraphics{figs/cases-3} \\
%                     (1) & (2) & (3) \\ \hline & & \\[.1mm]
%                     \includegraphics{figs/cases-4} &
%                     \includegraphics{figs/cases-5} &
%                     \includegraphics{figs/cases-6} \\
%                     (4) & (5) & (6) \\ \hline & & \\[.1mm]
%                     \includegraphics{figs/cases-7} &
%                     \includegraphics{figs/cases-8} &
%                     \includegraphics{figs/cases-9} \\
%                     (7(a)) & (7(b)) & (8) \\ \hline
%                 \end{tabular}
%             }
%             \caption{Cases in the proof of \cref{main-claim}.}
%             \label{cases}
%        \end{figure}
%        \begin{compactenum}
%           \item If $u\in L_i$ and $w\in L_j$ for $i\neq j$ then $i\bmod 3\neq j\bmod 3$, so $\theta(u)\neq\theta(w)$.
%
%           \item If $u,w\in L_i$ and $v\in L_{i+1}$ then $u,w$ is contained in the parent clique $C_v$ of $v$.  In particular, $uw\in E(H'[L_i])$ so $\varphi(u)\neq\varphi(w)$ since \cref{t-tree-slack} produces a 2-ranking (which is a proper colouring) $\varphi$ of $H'[L_i]$.
%
%           \item If $u,v,w\in L_i$ then $uvw$ is completely contained in $H'[L_i]$ and $\varphi(u)\neq\varphi(w)$ or $\varphi(u)<\varphi(v)$ because \cref{t-tree-slack} produces a 2-ranking $\varphi$ of $H'[L_i]$.
%
%           \item If $uw\in E(H^-_p)$ or the path $u,v,w\in V(H^-_p)$ for some vertex $p$ in $H'[L_i]$ then the inductive hypothesis ensures that $\theta$ was already a 2-ranking of $H^-_v$ and the subsequent modifications to $\psi(w)$ for $w\in H^-_v[L_{i+1}]$ do not change this. In fact, these modifications do not change the relative order of $\theta(u)$ and $\theta(w)$ or the relative order of $\theta(u)$ and $\theta(v)$.
%
%           \item If $u,w\in V(H^-_p)$ for some $p\in V(H'[L_i])$, $v$ is in $H'[L_i]$, and $v\neq p$ then, by \cref{up-clique}, $pv\in E(H'[L_i])$.  Therefore, there exists a $t$-clique $C$ in $H'[L_i]$ with $\{p,v\}\subseteq C_u$ such that $u\in V(H_{C})$.  The vertex $u$ is contained in some component $Y$ of $H^-_v$. By \cref{min} and the application of \cref{t-tree-slack} to $Y$, $\varphi(u)\le a(k-\gamma(v)-1) < \varphi(v)$ so $\theta(u) < \theta(v)$.
%
%           \item If $u\in V(H^-_{p})$, $v\in V(H'[L_i])$ and $w\in V(H^-_q)$ for some $p\neq q$, then $p=p(v)$ and $q=p(w)$.  By \cref{up-clique}, the edge $pq\in E(H[L_i])$, so $\psi(u)=\zeta(p)\neq\zeta(q)=\psi(w)$ since $\zeta$ is a proper colouring of $H'[L_i]$.
%
%           \item If $u,w\in V(H_{p}-H^-_{p})$ for some $p\in V(H'[L_i])$ then $\varphi(u)$ and $\psi(u)$ were assigned by some vertex $p'\in V(H'[L_i])$ such that $v\in S_{p'}$.  Similarly, $\varphi(w)$ and $\psi(w)$ were assigned by some vertex $q'\in V(H'[L_i])$ such that $w\in S_{q'}$.  There are two subcases to consider:
%           \begin{compactenum}
%             \item If $p'=q'$ then $\varphi(u)\neq\varphi(w)$ since every vertex in $S_{p'}$ is assigned a unique colour by $\varphi$.
%             \item If $p'\neq q'$ then, by \cref{up-clique}, $p'q'\in E(H'[L_i])$ so that $\psi(u)=\zeta(p')\neq\zeta(q')=\psi(w)$.
%         \end{compactenum}
%         In either case $\theta(u)\neq\theta(w)$.
%
%         \item If $u,w\in H_p[L_{i+1}]$, $u\in V(H^-_{p})$ and $w\not\in V(H^-_{p})$ for some $p\in V(H'[L_i])$ then $w\in S_{q'}$ for some $q'\in V(H'[L_i])$ and $\varphi(w)$ (and $\psi(w)$) was assigned by $q'$, so $\varphi(w)>a(k-\gamma(q')-1)$. On the other hand, by \cref{min}, $\varphi(u) \le a(k-\gamma(q')-1)$.  Therefore $\varphi(u)<\varphi(w)$ so $\theta(u)\neq\theta(w)$.
%       \end{compactenum}
%       This completes the proof of \cref{main-claim}.
%     \end{proof}
%     Finally, to complete the proof of \cref{two-tree-technical} we apply \cref{main-claim} with $i=0$ and $H'=H$.  By \cref{size-claim} we can do this with any value $k$ such that $\tau(t-1)\cdot n \le (\log k)^{k}$ to show that $\trn(H)\le \tau(t-1)\cdot a\cdot k$ for some constant $a$.
% \end{proof}

Rewriting \cref{t-tree-technical} in terms of $n$ yields \weirdref{simple-t-trees}{a}:

\begin{proof}[Proof of \weirdref{simple-t-trees}{a}]
    By \cref{t-tree-technical}, $\lrn(H)\in O(k)$ for any $k$ that satisfies
    \[  (\log^{(t-2)} k)^{k} \ge n \Leftrightarrow
        k \ge \frac{\log n}{\log^{(t-1)} k}
    \]
    Taking $k=2\log n/\log^{(t)} n$, this becomes
    \[
        \frac{2\log n}{\log^{(t)} n}
        \ge \frac{\log n}{\log^{(t-1)}(\log n + 2 -\log^{(t)} n)}
        = \frac{\log n}{\log^{(t)} n - O(1/\log n)}
        = \frac{\log n}{\log^{(t)} n}+O(1) \enspace .
    \]
    which is clearly true for all sufficiently large $n$.
\end{proof}


\subsection{Bounded Genus Graphs}

We now prove the upper bound in \cref{bounded-genus}. A graph $G$ is an \emph{apex} graph if there exists an \emph{apex vertex} $v\in V(G)$ such that $G-\{v\}$ is planar. We make use of the following product structure theorem of \citet{dujmovic.joret.ea:planar}:\footnote{\citet{dujmovic.joret.ea:planar} state a version of \cref{product-structure} that describes $H$ as an apex graph of treewidth at most $4$.  By definition, this means that $H$ has an \emph{apex} vertex $v_0$ such that $H-\{v_0\}$ is planar.  In fact, in their proof, $v_0$ is a dominating vertex.  Because of this, the removal of $v_0$ also reduces the simple treewidth of $H$ to 3, yielding the version of \cref{product-structure-genus} stated here.}

\begin{thm}[\cite{dujmovic.joret.ea:planar}] \label{product-structure-genus}
    For every $n$-vertex graph $G$ of Euler genus at most $g$, there exists some at most $n$-vertex path $P$, some at most $n$-vertex graph $H$, and a vertex $v_0\in V(H)$ such that $\stw(H-\{v_0\})\le 3$ and $G$ is isomorphic to a subgraph of $H\boxtimes K_{\max\{2g,3\}}\boxtimes P$
\end{thm}

\begin{proof}[Proof of \cref{bounded-genus}]
    Apply \cref{product-structure-genus} to $G$ to obtain the graph $H$, path $P$, and apex vertex $v_0\in V(H)$.  By \cref{planar} there exists a $\ell$-ranking $\varphi:V(H-\{v_0\})\to \{1,\ldots,k\}$ with $k\in O(\log n/\log^{(3)} n)$. Setting $\varphi(v_0):=k+1$ then gives an $\ell$-ranking of $H$, so $\lrn(H)\le k+1\in O(\log n/\log^{(3)} n)$.  The same argument used to show that $\dlcn(K_3\boxtimes P)\le 3(\ell+1)$ (\cref{dumb}) shows that $\dtcn(K_{\max\{2g,3\}}\boxtimes P)\le \max\{2g+3\}\cdot(\ell+1)$.  \cref{bounded-genus} now follows from \cref{product-lemma}.
\end{proof}

\subsection{Other Graph Families with Product Structure}

As noted in the introduction, several other families of graphs are known to have product structure theorems like \cref{product-structure,product-structure-genus}.  In particular, \citet{dujmovic.joret.ea:planar} show:

\begin{thm}[\cite{dujmovic.joret.ea:planar}]\label{apex-minor-free}
    For any apex graph $A$, there exists a value $t$ such that any $n$-vertex $A$-minor free graph $G$ is isomorphic to a subgraph of $H\boxtimes P$ where $|H|\le n$, $\tw(H)\le t$, and $P$ is a path.
\end{thm}

\citet{dujmovic.morin.ea:structure} show a similar result for some non-minor-closed families of graphs, the most well-known of which are the $k$-planar graphs:

\begin{thm}[\cite{dujmovic.morin.ea:structure}]\label{gk-planar}
    For any integers $g$ and $k$, there exists a value $t$ such that any $n$-vertex $(g,k)$-planar graph $G$ is isomorphic to a subgraph of $H\boxtimes P$, where $|H|\le n$, $\tw(H)\le t$, and $P$ is a path.
\end{thm}

\begin{proof}[Proof of \cref{meta}]
    For any $n$-vertex member $G$ of these graph families, \cref{gk-planar,apex-minor-free} show that $G$ is a subgraph of $H\boxtimes P$ with $\tw(H)\le t$.  \Cref{product-lemma,t-trees} and the fact that $\lrn(P)\le \ell+1$ then imply \cref{meta}.
\end{proof}

%========================================================================
\section{Discussion}
\label{conclusion}

We have given asymptotically optimal bounds on the number of colours required by $\ell$-rankings of $n$-vertex graphs of treewidth $t$, graphs of simple treewidth $t$, planar 3-trees, outerplanar graphs, and planar graphs.  Prior to this work, the best known bounds for planar graphs were $\Omega(\log n/\log\log n)$ (trees) and $O(\log n)$.

Our upper bounds are constructive and lead to straightforward $O(n)$ time algorithms for finding $\ell$-rankings of (simple) treewidth $t$ graphs, including planar 3-trees, and outerplanar graphs.  For planar graphs, we require an algorithmic version of \cref{product-structure}. Currently, the fastest such algorithm runs in $O(n\log n)$ time \cite{morin:fast}.

Two directions for future work stand out:
\begin{inparaenum}[(i)]
    \item This work has deliberately ignored constants that depend on $\ell$ and $t$ (in our proof, the hidden constant in the big-Oh notation is at least $\Omega(\ell^t)$; see \cref{path-induced}).  Can this be improved?
    \item For constant $d$, the lower and upper bounds for 2-ranking $d$-degenerate graphs are $\Omega(n^{1/3})$ and $O(\sqrt{n})$, respectively.  Closing this gap is an intriguing open problem.
\end{inparaenum}

\section*{Acknowledgement}

The authors are grateful to David Wood who, after reading an early draft of this paper, pointed us to the notion of simple treewidth, which greatly simplifies and unifies the exposition.


\bibliographystyle{plainnat}
\bibliography{us}

\appendix
\section{Calculations}
\label{calculation}

\subsection{Calculation in the Proof \cref{t-tree-slack}}
\label{calculation-i}

\begin{align*}
    &\hspace{-2em} \left(\log^{(t-2)}\left(c+s+\tfrac{\log(c+s)}{\log^{(t-1)}(c+s)}\right)\right)^{c+s+\tfrac{\log(c+s)}{\log^{(t-1)}(c+s)}} \\
    & = \left(\log^{(t-2)}c\right)^{\left(c+s+\tfrac{\log(c+s)}{\log^{(t-1)}(c+s)}\right)
        \left(\tfrac{\log^{(t-1)}(c+s+\log(c+s)/\log^{(t-1)}(c+s))}{\log^{(t-1)}c}\right)} \\
        & \qquad\qquad\text{(change of base)} \\
    & < (\log^{(t-2)}c)^{\left(c+s+\tfrac{\log(c+s)}{\log^{(t-1)}(c+s)}\right)
        \left(1 + \tfrac{s+\log(c+s)/\log^{(t-1)}(c+s)}{\prod_{j=0}^{t-1}\log^{(j)}c}\right)} \\
        & \qquad\qquad\text{(by \cref{logi-ratio})}\\
    & < (\log^{(t-2)}c)^{\left(c+s+\tfrac{\log(c+s)}{\log^{(t-1)}(c+s)}\right)
        \left(1 + \tfrac{2\log(c+s)/\log^{(t-1)}(c+s)}{\prod_{j=0}^{t-1}\log^{(j)}c}\right)} \\
        & \qquad\qquad\text{(since $s=\log c/\log^{(t-1)} c$), so $s<\log(c+s)/\log^{(t-1)}(c+s)$)}\\
    & < (\log^{(t-2)}c)^{\left(c+s+\tfrac{\log(c+s)}{\log^{(t-1)}(c+s)}\right)
        \left(1 + \tfrac{2\log(c+s)/\log^{(t-1)}c}{\prod_{j=0}^{t-1}\log^{(j)}c}\right)} \\
        & \qquad\qquad\text{(since $c+s>c$)}\\
    & = (\log^{(t-2)}c)^{\left(c+s+\tfrac{\log(c+s)}{\log^{(t-1)}(c+s)}\right)
        \left(1 + \tfrac{2\log(c+s)}{c\log c\cdot\left(\prod_{j=2}^{t-1}\log^{(j)}(c+s)\right)\log^{(t-1)}c}\right)} \\
        & \qquad\qquad\text{(since $t\ge 2$)}\\
    & \le (\log^{(t-2)}c)^{\left(c+s+\tfrac{\log(c+s)}{\log^{(t-1)}(c+s)}\right)
        \left(1 + \tfrac{2\log(c+s)}{c\log c\cdot\log^{(t-1)}c}\right)} \\            & \qquad\qquad\text{(since $c\ge \tau(t-1)$, so $\textstyle \prod_{j=2}^{t-1}\log^{(j)}c\ge 1$)} \\
    & \le (\log^{(t-2)}c)^{\left(c+s+\tfrac{\log c+s/c}{\log^{(t-1)}(c+s)}\right)
        \left(1 + \tfrac{2\log c+2s/c}{c\cdot\log^{(t-1)}c}\right)} \\            & \qquad\qquad\text{(by \cref{logi-ratio})} \\
    & \le (\log^{(t-2)}c)^{c+s+\tfrac{\log c}{\log^{(t-1)}c} +
        \tfrac{2\log c}{\log^{(t-1)}c} + o\left(\tfrac{1}{\log^{(t-1)} c}\right)}  \\
    & = (\log^{(t-2)}c)^{c+\tfrac{4\log c}{\log^{(t-1)}c} + o\left(\tfrac{1}{\log^{(t-1)} c}\right)}  \\
    % & = (\log^{(t-2)}c)^{c}\cdot O(c^4) \\
    & = O\left(c^4\cdot\left(\log^{(t-2)}c\right)^{c}\right) \enspace .
\end{align*}

Therefore
\[
  \frac{\left(\log^{(t-2)}\left(c+\tfrac{\log c}{\log^{(t-1)} c}\right)\right)^{c+\tfrac{\log c}{\log^{(t-1)} c}}}
  {(\log^{(t-2)} c)^c}
  \in O(c^4) \enspace .
\]

\subsection{Calculation in the Proof \cref{t-tree-technical}}
\label{calculation-ii}

\begin{align*}
    % \frac{\left(\log^{(t-2)} k\right)^k}{n_{0}}
    & \hspace{-2em}(\log^{(t-2)}(c+s))^{c+s} \\
    & = \left(\log^{(t-2)}\left(c+\tfrac{\log c}{\log^{(t-1)} c}\right)\right)^{c+\tfrac{\log c}{\log^{(t-1)} c}} \\
    & = \left(\log^{(t-2)}c\right)^{\left(c+\tfrac{\log c}{\log^{(t-1)} c}\right)
    \left(\tfrac{\log^{(t-1)}\left(c+\log c/\log^{(t-1)} c\right)}{\log^{(t-1)} c}\right)} &\text{(change of base)} \\
    & = \left(\log^{(t-2)}c\right)^{\left(c+\tfrac{\log c}{\log^{(t-1)} c}\right)
    \left(
    1 + \tfrac{(\log e)^t\log c/\log^{(t-1)} c}{\prod_{j=0}^{t-1}\log^{(j)}c}
    \right)} & \text{(by \cref{logi-ratio})} \\
    & = \left(\log^{(t-2)}c\right)^{\left(c+\tfrac{\log c}{\log^{(t-1)} c}\right)
    \left(
    1 + \tfrac{(\log e)^t}{c\cdot\left(\prod_{j=2}^{t-1}\log^{(j)}c\right)\cdot\log^{(t-1)} c}
    \right)} & \text{(for $t\ge 2$)} \\
    & \le \left(\log^{(t-2)}c\right)^{\left(c+\tfrac{\log c}{\log^{(t-1)} c}\right)
    \left(
    1 + \tfrac{(\log e)^t}{c\cdot\log^{(t-1)} c}
    \right)} & \text{($c\ge \tau(t-1)$, so $\prod_{j=2}^{t-1}\log^{(j)}c\ge 1$)} \\
    & = \left(\log^{(t-2)}c\right)^{\left(c+\tfrac{\log c}{\log^{(t-1)} c}+
    \tfrac{(\log e)^t}{\log^{(t-1)} c} + \tfrac{(\log e)^t\log c}{c\cdot(\log^{(t-1)} c)^2}
    \right)}  \\
    & = \left(\log^{(t-2)}c\right)^{\left(c+\tfrac{\log c}{\log^{(t-1)} c}
      + O_c\left(\tfrac{1}{\log^{(t-1)} c}\right)
    \right)}  \\
    & \in O\left(c\cdot\left(\log^{(t-2)}c\right)^c\right)
\end{align*}

Therefore
\[
    \frac{(\log^{t-2} (c+s))^{c+s}}{(\log^{(t-2)}c)^c} \in O(c) \enspace .
\]



\end{document}
