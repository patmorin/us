\documentclass[kpfonts]{patmorin}
\listfiles
\usepackage{pat}
\usepackage{paralist}
\usepackage{dsfont}  % for \mathds{A}
\usepackage[utf8x]{inputenc}

\usepackage{graphicx}
\usepackage[noend]{algorithmic}

\usepackage{xcolor}
\definecolor{light-gray}{gray}{0.95}

\usepackage[normalem]{ulem}
\usepackage{cancel}
\usepackage{enumitem}

\usepackage[longnamesfirst,numbers,sort&compress]{natbib}

\usepackage{cleveref}

\newcommand{\snote}[1]{\fcolorbox{red}{yellow}{#1}}
\newcommand{\pnote}[1]{\ \newline\noindent\fcolorbox{red}{yellow}{\begin{minipage}{\textwidth}#1\end{minipage}}}
\setlength{\parskip}{1ex}

\title{\MakeUppercase{(Layered) Partitions versus Decompositions}}
\author{}

\DeclareMathOperator{\tw}{tw}
\DeclareMathOperator{\ltw}{ltw}
\DeclareMathOperator{\pw}{pw}
\DeclareMathOperator{\lpw}{lpw}
\DeclareMathOperator{\lhptw}{lhp-tw}
\DeclareMathOperator{\lhppw}{lhp-pw}


\title{\MakeUppercase{Optimal 2-Ranking of Planar Graphs}}
\author{Working Group}

\newcommand{\uqs}{\chi_2}
\newcommand{\hus}{\hat{\chi}_2}

\begin{document}
% \begin{titlepage}
\maketitle

\begin{abstract}
  A 2-ranking is a labelling of the vertices of a graph with integer colours so that the maximum label along any path of length at most 2 is unique.  We show that every $n$-vertex planar graph has a unique-superior colouring using $O(\log n/\log\log n)$ colours.
\end{abstract}
% \end{titlepage}

% \tableofcontents

% \newpage
% \pagenumbering{arabic}

\section{Introduction}

% A sequence $s_0,\ldots,s_p$ over some total order $(S,<)$ is \emph{ranked} if $\max\{s_0,\ldots,s_p\}$ occurs exactly once in $s_0,\ldots,s_p$.

A colouring of a graph $G$ is a function $\varphi:V(G)\to \N$.  A colouring $\varphi$ is an \emph{$\ell$-ranking} if, for every path $v_0,\ldots,v_r$ of length $r\le\ell$, $\max\{\varphi(v_0),\ldots,\varphi(v_r)\}$ appears exactly once in the sequence $\langle \varphi(v_0),\ldots,\varphi(v_r)\rangle$.\footnote{An alternative, but equivalent condition is that for every path $v_0,\ldots,v_r$ of length $r\le\ell$,
\begin{inparaenum}[(i)]
   \item $\varphi(v_0)\neq \varphi(v_r)$; or
   \item $\max\{\varphi(v_0),\ldots,\varphi(v_r)\} > \varphi(v_0)$.
\end{inparaenum}
}
The $\ell$-ranking number $\chi_\ell(G)$ is the minimum integer $k$ such that $G$ has a $\ell$-ranking $\varphi:V(G)\to \{1,\ldots,k\}$.

The case $\ell=2$ has received special attention \cite{almeter.demircan.ea:graph,karpas.neiman.ea:on}. A $2$-ranking is called a \emph{unique-superior colouring} (abbreviated \emph{us-colouring}) by \citet{karpas.neiman.ea:on} who prove the following result:

\setcounter{thm}{-1}
\begin{thm}[\cite{karpas.neiman.ea:on}]\label{trees}
    For every $n$-vertex tree $T$, $\uqs(T)\in O(\log n/\log\log n)$ and this is asymptotically optimal: for every $n\ge 1$ there exists an $n$-vertex tree $T$ with $\uqs(T)\in\Omega(\log n/\log\log n)$.
\end{thm}

The same authors show that $\uqs(G)\in O(\log n)$ for every $n$-vertex planar graph $G$ and leave the gap between this and the $\Omega(\log n/\log\log n)$ lower bound for trees as an open problem.  A consequence of the current paper is to close this gap:

\begin{thm}\label{planar}
    For every $n$-vertex planar graph $G$, $\uqs(G)\in O(\log n/\log\log n)$.
\end{thm}

Our proof of \cref{planar} makes use of a recent \emph{product structure theorem} of \citet{dujmovic.joret.ea:planar} which states that every planar graph $G$ is a subgraph of $H\boxtimes P$ where $H$ is an $8$-tree\footnote{A $k$-tree is an edge-maximal graph of treewidth $k$. Definitions appear later.}, $P$ is a path, and $\boxtimes$ denotes the strong graph product.  To apply this theorem, we generalize \cref{trees} as follows:

\begin{thm}\label{t-trees}
    For every fixed $t$ and every $n$-vertex $t$-tree, $\uqs(G) \in O(\log n/\log\log n)$.
\end{thm}

\cref{t-trees} is then applied to the graph $H$ along with a simple product colouring which shows that $\uqs(H\boxtimes P)\le 3\uqs(H)$.

The remainder of this paper is organized as follows: \Cref{sec:trees} reviews the proof of \cref{trees}. \Cref{sec:t-trees} proves \Cref{t-trees}.  \Cref{sec:products} proves \Cref{planar} as well its generalization to several other graph classes, including graphs of bounded genus, apex-minor-free graphs, bounded-degree graphs from minor-closed families, and $k$-planar graphs.




\section{A Restatement of the Proof for Trees}
\seclabel{trees}

In this section we review a slight variant of the proof of \cref{trees} by \citet{karpas.neiman.ea:on}. This presentation modifies the proof slightly so that it separates the treatment of the two different types length-$2$ paths in trees. This will simplify the arguments in \cref{sec:t-trees}.

Let $H$ be a rooted tree.  The \emph{depth} $d_H(V)$ of a node $v\in H$ is the length of the path $P_T(v)$ from the root $r$ of $H$ to $v$.  A node $a\in V(T)$ is a $T$-ancestor of $w\in V(T)$ if $a\in V(P_T(w))$.  A $T$-ancestor $a$ of $w$ is \emph{strict} if $a\neq w$.  If $a$ is a (strict) $T$-ancestor of $w$ then $w$ is a (strict) $T$-descendant of $a$.  A path $P$ in $H$ is \emph{vertical} if no two nodes in $P$ have the same depth, otherwise the path is \emph{humped}.  A \emph{humped} us-colouring of $H$ is a proper colouring of $H$ in which, for every humped length-$2$ path $uvw$ in $H$, at least one of $\varphi(u)$ or $\varphi(w)$ is not equal to $\max\{\varphi(u),\varphi(v),\varphi(w)\}$.  For a rooted tree $H$, we let $\hus(H)$ denote the \emph{humped us-chromatic number} of $H$; the smallest integer $k$ such that $H$ has a humped us-colouring $\varphi:V(H)\to\{1,\ldots,k\}$.

\begin{lem}\label{product}
    For any rooted tree $H$, $\uqs(H)\le 3\hus(H)$.
\end{lem}

\begin{proof}
    It is slightly more convenient to show the equivalent statement: If has a humped unique-superior colouring $\varphi:V(H)\to S$, then $H$ has a unique-superior colouring $\varphi':V(H)\to S\times\{0,1,2\}$, where the elements of $S\times\{0,1,2\}$ are ordered lexicographically.

    For each $v\in V(H)$, let $\varphi'(v):=(\varphi(v), d_H(v)\bmod 3)$. Since $\varphi$ is a humped us-colouring of $H$ we need only consider vertical paths of $H$.  But this is trivial since for every vertical path $uvw$ in $H$, $\{\varphi'(u),\varphi'(v),\varphi'(w)\}=\{0,1,2\}$, so $\varphi'(u)$, $\varphi'(v)$, and $\varphi'(w)$ are distinct.
\end{proof}

For integers $0\le i\le k$, let $f_k(i)$ be the smallest integer such that there exists an $f_k(i)$-node tree $H$ with root $r$ and some value $\ell \in\{i,\ldots,k\}$ such that $H$ does not have a humped unique-superior colouring $c:V(G)\to \{1,\ldots,k\}$ (in which the root of $H$ happens to be coloured $k$).

\begin{lem}\label{recursion}
    For any integers $1\le  i\le k$, $f_k(i) \ge (k-i+1)\cdot f_k(i-1)$
    \[
        f_k(i) \le \begin{cases}
                    k & \text{if $i=1$} \\
                    (k-i+1)\cdot f(i-1) & \text{if $i>1$}
                 \end{cases}
    \]
\end{lem}

\begin{proof}
    The proof is by induction on $i$. First consider the base case $i=1$ and let $H$ be a $f(1)$-node tree $H$ with root $r$ such that, for some $\ell\in\{1,\ldots,k\}$, $H$ does not have a a humped unique superior colouring $\varphi:V(G)\to \{1,\ldots,k\}$.  Let $r_1,\ldots,r_d$ be the children of $r$.
    Then, for each $j\in\{1,\ldots,d\}$, and each $\ell'\in \{1,\ldots,k\}$, the subtree $H_j$ of $H$ rooted at $r_i$ has fewer than $f(1)$ nodes, so $H_j$ has a humped unique-superior colouring $\varphi:V(H_j)\to \{1,\ldots,k\}$ with $\varphi(r_j)=\ell'$.  Therefore, if $d \le k-1$, we can obtain a humped unique-superior colouring of $H$ as follows:
    \begin{enumerate}
        \item Set $\varphi(r):=\ell$.
        \item For each $j\in\{1,\ldots,d\}$, assign each $r_j$ a unique colour  $\varphi(r_j)\in\{1,\ldots,k\}\setminus\{\ell\}$ and extend $\varphi$ to a humped unique-superior colouring $\varphi:V(H_j)\to\{1,\ldots,k\}$ of $H_j$.
    \end{enumerate}
    If $d\le k-1$, then $|\{1,\ldots,k\}-\{\ell\}|=k-1\ge d$, so Step~2 will succeed.
    It is easy to check that $\varphi:V(H)\to\{1,\ldots,k\}$ is a humped unique-superior colouring of $H$ with $\varphi(r)=\ell$.  By definition, no such colouring exists, therefore it must be the case that $d> k-1$, so $H$ has at least $k+1$ vertices.

    Next consider some $i\in\{2,\ldots,k\}$.  Let $r_1,\ldots,r_d$ be the children of $r$ ordered so that the subtrees $H_1,\ldots,H_{d'}$ each have size at least $f(i-1)$ and the subtrees $H_{d'+1},\ldots,H_d$ each have size less than $f(i-1)$.  If $d'\le k-i$, then we obtain a humped unique-superior colouring of $H$ as follows:
    \begin{enumerate}
        \item Set $\varphi(r):=\ell$.
        \item For each $j\in\{d'+1,\ldots,d\}$ set $\varphi(r_j)=i-1$ and extend this to a humped unique-superior colouring of $H_j$.
        \item For each $j\in\{1,\ldots,d'\}$, assign each $r_j$ a unique colour $\varphi(r_j)\in\{i,\ldots,k\}\setminus\{\ell\}$ and extend this to a humped unique-superior colouring of $H_j$.
    \end{enumerate}
    If $d'\le k-i$ then Step~3 is always possible since $|\{i,\ldots,k\}\setminus\{\ell\}|=k-i$. Again, it is easy to check that $\varphi:V(H)\to[k]$ is a humped unique-superior colouring of $H$ with $\varphi(r)=\ell$.  By definition, no such colouring exists, so it must be the case that $d'>k-i$. Therefore $H$ has at least $d'\cdot f_k(i-1)\ge (k-i+1)\cdot f_k(i-1)$ vertices.
\end{proof}

Unravelling the recurrence in \cref{recursion} shows that $f_k(k)\ge 1\cdot2\cdot\cdots k=k!$.  In particular, for any $n < f_k(k)=k!$, every $n$ vertex rooted tree $H$ has a humped unique-superior colouring $\varphi(H)\to\{1,\ldots,k\}$. Combining this with \cref{product} yields:

\begin{thm}[\cite{karpas.neiman.ea:on}]\label{trees-precise}
    For every tree $H$ with $n<k!$ vertices $\uqs(H)\le 3k$.
\end{thm}

Using Stirling's Approximation of $k!$ it easy to see that $n < k!$ for some $k\in\Theta(\log n/\log\log n)$, so \cref{trees} is a corollary of \cref{trees-precise}.

\section{A Less Obvious Restatement of the Proof for Trees}
\seclabel{trees}

\begin{lem}\label{tree-separator}
    For every integer $c\ge 1$ and for every $n$-vertex rooted tree $H$, there exists $S\subseteq V(H)$ such that
    \begin{inparaenum}[(i)]
        \item $H[S]$ is a tree that contains the root of $H$; \label{has-root}
        \item $H[S]$ has at most $c$ leaves; and \label{c-1-leaves}
        \item $H-S$ has no component larger than $n/(c+1)$. \label{max-component}
    \end{inparaenum}
\end{lem}

\begin{proof}
    Let $r$ be the root of $H$ and let $v_1,\ldots,v_n$ be the vertices of $H$ in the order they are encountered in a preorder traveral.  Let $L=\{v_{\lceil in/c\rceil}: i\in\{1,\ldots,c\}\}$.  Let $S:=\bigcup_{\ell\in L} V(P_H(\ell))$ so that $H[S]$ is the minimum spanning tree of $L\cup\{r\}$.  Clearly $S$ satisfies (\ref{has-root}).  Every leaf of $H[S]$ is contained in $L$, so $S$ satisifies (\ref{c-1-leaves}).  That $S$ satisfies (\ref{max-component}) follows from the fact that, for any $i\in\{1,\ldots,n\}$, $P_H(v_i)$ separates $v_1,\ldots,v_{i-1}$ from $v_{i+1},\ldots,v_n$ in the sense that, for every $1\le a\le b\le n$ the path from $a$ to $b$ in $H$ contains at least one vertex of $P_T(v_i)$.
\end{proof}

\begin{lem}\label{skinny-tree-colour}
    Let $1\le \ell \le n$ be integers, let $C$ be an $(\ell+1)$-element set of integers, let $\alpha\in C$, and let $H$ be an $n$-node tree rooted at $r\in v(H)$ having at most $\ell$ leaves.  Then $H$ has a humped us-colouring $\varphi:V(H)\to C$ in which $\varphi(r)=\alpha$.
\end{lem}

\begin{proof}
    The proof is by induction on $|V(H)|$. If $|V(H)|=1$ then $H$ has one node $r$ and the result is trivial.  Otherwise, let $r_1,\ldots,r_m$ be the children of $r$ and observe that $1\le m\le \ell$.  Set $\varphi(r):=\alpha$, as required and, for each $i\in\{1,\ldots,m\}$, set $\varphi(r_i)$ to the $i$th largest value in $C\setminus\{\alpha\}$, so that each child of $r$ is assigned a unique colour distinct from $r$. It is easy to check that this is a humped us-colouring of the star $H[\{r,r_1,\ldots,r_m\}]$ rooted at $r$ so all that remains is to colour the subtree $H_{r_i}$ rooted at $r_i$ for each $i\in\{1,\ldots,m\}$.  Applying induction to $H_{r_i}$ with $\alpha=\varphi(r_i)$ for each $i\in\{1,\ldots,m\}$ completes the proof.
\end{proof}


\begin{lem}\label{tree-algorithm}
    Let $1\le c\le k$ be integers and let $H$ be an $n$-vertex tree with $n\le k!/c!$, rooted at $r\in V(H)$. Then $H$ has a humped us-colouring $\varphi:V(H)\to\{0,\ldots,k\}$ with $\varphi(r)=k-c$.
\end{lem}

\begin{proof}
    The proof is by induction on $k-c$.  The base case, when $c=k$, occurs when $n\le k!/c!=1$ simply states that setting $\varphi(r)=0$ is gives a us-colouring of the 1-node tree whose only node is $r$.


    % The base case, when $c=k$ occurs when $n= k!/(k-1)!=k$.  In this case, $H$ has at most $k$ nodes and therefore, at most $k-1$ leaves.  The result then follows by applying \cref{skinny-tree-colour} with $C=\{1,\ldots,k\}$ and $\alpha=1$.

    For $1\le c<k$, let $S$ be the set described in \cref{tree-separator}.  Then $H[S]$ has at most $c$ leaves so, by \cref{skinny-tree-colour} with $\alpha=k-c$, $\varphi$ can be extended into a us-colouring $\varphi:S\to C$ of $H[S]$ using only the $c+1$ colours in $C:=\{k-c,\ldots,k\}$.  Now $H-S$ is a forest consisting of trees $H_{r_1},\ldots,H_{r_m}$ each having size at most $n/(c+1) \le k!/(c+1)!$ with roots $r_1,\ldots,r_m$, respectively.  For each $i\in\{1,\ldots,m\}$, apply induction on $H_{r_i}$ to extend $\varphi$ into a humped us-colouring $\varphi:V(H_{r_i})\to\{1,\ldots,k\}$ of $H_{r_i}$ in which $\varphi(r_i)=k-c$.  It is now straightforward to check that (because $\alpha(r_i)=k-c < k-c+1$ for each $i\in\{1,\ldots,m\}$) $\varphi$ is a humped us-colouring of $H$.
\end{proof}

Applying \cref{tree-algorithm} with $c=1$ and shifting $0,\ldots,k$ onto $1,\ldots,k+1$ gives:

\begin{cor}\label{tree-algorithm-ii}
    For every rooted tree $H$ with $n\le k!$ nodes, $\hus(H)\le k+1$.
\end{cor}

Combining \cref{tree-algorithm-ii} with \cref{product} gives the following
\begin{thm}[\cite{karpas.neiman.ea:on}]
    For every tree $H$ with $n\le k!$ vertices, $\uqs(H)\le 3(k+1)$.
\end{thm}


\section{Lower Bound for 2-trees}

\begin{lem}
    Any humped us-colouring of $T_{a,a}$ requires at least $a$ distinct colours.
\end{lem}

\begin{lem}
    Let $G:= (k-a)\times T_{a,a}$ consist of $k-a$ disjoint copies of $T_{a,a}$.
\end{lem}

\section{$2$-Trees}

In this section we consider how to solve this problem for 2-trees.

Let $T_{b,h}$ denote a complete $b$-ary tree of height $h$ (the rooted tree in which every leaf has depth $h$ and every non-leaf has exactly $b$ children).

\begin{lem}\label{big-complete-tree}
    Let $k\ge x\ge 1$ be integers.
    Let $T$ be an $r$-rooted tree that contains no copy of $T_{k,k}$ and such that $T$ contains no copy of $T_{k,h}$ rooted at $r$.  Then, for each $c\in\{h,\ldots,2k\}$, $T$ has a us-colouring $\varphi:V(T)\to \{1,\ldots,2k\}$ such that $\varphi(r)=c$.
\end{lem}

\begin{proof}
    The proof is by induction on $|V(T)|$.  The base case $|V(T)|=1$ is trivial.

    For $|V(T)|>1$, let $r_1,\ldots,r_d$ be the children of $r$ and, for each $i\in\{1,\ldots,d\}$, let $T_i$ be the subtree of $T$ rooted at $r_i$.  The subtrees $T_1,ldots,T_d$ can be partitioned into two sets $T_1,\ldots,T_{d'}$ and $T_{d'+1},\ldots,T_d$ so that $T_i$ contains a copy of $T_{k,h-1}$ that includes $r_i$ if and only if $i\le d'$.  Note that, possibly, $d'=0$.   Certainly, $d' < k$ since, otherwise $T$ contains a copy of $T_{k,h}$ rooted at $r$.

    Now, set $\varphi(r):=c$. For each $i\in\{1,\ldots,d'\}$, set $\varphi(r_i)$ to a distinct value in $\{k+1,\ldots,2k\}\setminus \{c\}$. For each $i\in\{d'+1,\ldots,d\}$, set $\varphi(r_i):=h-1 < c$.  By induction on each tree $T_i$, $\varphi$ can be completed to a humped us-colouring of $T_i$.  It is easy to verify that, such a colouring gives a humped us-colouring of $T$.
\end{proof}

A colouring $\varphi:V(G)\to\N$ is a \emph{$(>r)$-unique} if there is no colour $r'>r$ such that $\varphi(v)=\varphi(w)=r'$ for two distint vertices $v,w\in V(G)$.

For a tree $T$ and integer $k\ge \hus(T)$, let $\hus(T,k)$ denote the smallest integer $r$ such that $T$ has a humped $(>r)$-unique humped us-colouring $\varphi:V(G)\to\{1,\ldots,k\}$.

\begin{lem}\label{big-repeats}
    Let $k$ and $x$ be integers with $k\ge 2x+1$.
    If $\hus(T,k)> 2x+1$, then $|V(T)|\ge (k-2x+2)\cdot x^x$.
\end{lem}

\begin{proof}
    Let $T_1:= T$, let $i:=1$ and while $T_i$ contains a copy of $T_{x,x}$,
    select any maximum-depth node $r_i\in V(T_i)$ such that the subtree $T_{r_i}$ of $T_i$ rooted at $r_i$ contains a copy of $T_{x,x}$.  Set $T_{i+1}=T_i-T_{r_i}$ and set $i:=i+1$.  Note that choosing each $r_i$ to be of maximal depth ensures that $T_{r_i}$ does not contain a copy of $T_{x+1,x+1}$.

    This yields a sequence of trees $T_1,\ldots,T_m$ where, for each $i\in\{1,\ldots,m-1\}$, $|V(T_i)|\ge x^x$ and, by \cref{big-complete-tree} $\hus(T_i) \le 2x+1$.  We claim that $m-1 > k-2x$, so $m\ge k-2x+2$ and therefore $|V(T)|\ge (k-2x+2)\cdot x^x$, thus completing the proof.

    To see why this claim is true observe that, otherwise, we could obtain a $(>2x+1)$-unique humped us-colouring $\varphi:V(T)\to\{1,\ldots,k\}$ as follows: For each $i\in\{1,\ldots,m-1\}$ take a humped us-colouring of $T_i$ using $\{1,\ldots,2x+1\}$ so that $\varphi(r_i)=2x+1$.  Take a humped us-colouring of $T_m$ using $\{1,\ldots,2x\}$.   Finally, for each $i\in\{1,\ldots,m-1\}$, replace $\varphi(r_i)$ with a distinct colour in $\{2x+1,\ldots,k\}$.  This certainly produces a $(>2x+1)$-unique colouring and it is easy to verify that this colouring is indeed a humped us-colouring.
\end{proof}

For a function $f:V(G)\to\R^+$, a colouring $\varphi:V(G)\to\N$ is $f$-lower-bounded if $\varphi(v)\ge f(v)$ for each $v\in V(G)$.  For a tree $T$ and $f:V(G)\to\N$, we let $T^f$ denote the tree obtained by replacing each leaf $v$ of $T$ with $T_{\lceil f(v)/2\rceil,\lceil f(v)/2\rceil
}$.  \cref{big-complete-tree,big-repeats} generalize naturally to the following.

\begin{lem}\label{big-complete-tree}
    Let $k\ge x\ge 1$ be integers, let $T$ be a tree and let $f:V(T)\to\R$.  Then $T$ has an $f$-lower bounded humped us-colouring $\varphi:V(T)\to\{1,\ldots,2k\}$ or $T$ contains a subtree $S$ such that $S^f$ contains $T_{k,k}$.
\end{lem}

\begin{lem}\label{big-repeats}
    Let $k$ and $x$ be integers with $k\ge 2x+1$.
    If $\hus(T,k)> 2x+1$, then $|V(T)|\ge (k-2x+2)\cdot x^x$.
\end{lem}




a \emph{weight-constrained}




\section{Generalization to $t$-Trees}
\seclabel{t-trees}

A graph $H$ is a $t$-tree if $H$ is a clique of size $t$ or if it contains a vertex $v$ of degree $t$ whose neighbours form a clique and such that $H-\{t\}$ is a $t$-tree.  This recursive definition of $t$-trees implies that there is a permutation $\pi_1,\ldots,\pi_n$ of $V(G)$ such that $\pi_1,\ldots,\pi_t$ form a clique and, for each $i\in\{t+1,\ldots,n\}$, $\pi_i$ is adjacent to exactly $t$ vertices among $\pi_1,\ldots,\pi_{i-1}$ which themselves form a clique, which we call the \emph{parent clique} of $\pi_i$.  We call $\pi_1,\ldots,\pi_n$ a \emph{construction order} for $H$.

A \emph{tree decomposition} of a graph $H$ is a sequence $\mathcal{T}:=(B_x:x\in V(T))$ of subsets of $V(H)$ called \emph{bags} indexed by the nodes of a tree $T$ and such that
\begin{inparaenum}[(i)]
    \item for each $v\in V(H)$, $T[\{x\in V(T):v\in B_x\}]$ is connected; and
    \item for each $vw\in E(H)$, there exists some $x\in v(T)$ such that $\{v,w\}\subseteq B_x$.
\end{inparaenum}
The \emph{width} of $\mathcal{T}$ is $\max\{|B_x|:x\in V(T)\}-1$. The \emph{treewidth} of $H$ is the minimum width of any tree decomposition of $H$.

It is not difficult to see that every $t$-tree $H$ has treewidth $t$ and a tree-decomposition of $H$ can be constructed incrementally from a construction order $\pi_1,\ldots,\pi_n$ of $H$: Start with a tree $T$ that consists of a single node $r$ with bag $B_r:=\{\pi_1,\ldots,\pi_{t+1}\}$ and, for $i\gets t+2,\ldots,n$, let $x$ be the minimum-depth node of $T$ such that $\pi_i\in B_x$, and add a new leaf $\pi_i$ to $T$ adjacent to $x$ whose bag $B_{\pi_i}$ contains $\pi_i$ and its parent clique.  We call tree-decomposition constructed this way a \emph{canonical} tree decomposition of $H$.

For the remainder of this section, $H$ is a $t$-tree on $n\ge t+1$ vertices, $\pi_1,\ldots,\pi_n$ is a construction order for $H$, and $\mathcal{T}:=(B_x:x\in V(T))$ is a canonical tree decomposition of $H$.  It is easy to see that every bag of $\mathcal{T}$ has size exactly $t+1$, $T$ is rooted at $r$, and
\begin{inparaenum}[(i)]\setcounter{enumi}{2}
  \item for each node $y$ of $T$ with parent $x$, $|B_y\setminus B_x|=1$.\label{three}
\end{inparaenum}
Note that this implies that $|V(T)|=n-t$, since $B_r$ contains $t+1$ vertices of $H$ and, by (\ref{three}), each $x\in V(T)\setminus\{r\}$ includes exactly one vertex of $H$ that is not in its parent.

For each $v\in V(T)$ let $x_T(v)$ be the minimum-depth node $x\in V(T)$ such that $v\in B_x$.  A path $v_i,\ldots,v_r$ in $H$ is \emph{vertical} if $x_T(v_{i-1})$ is a strict $T$-ancestor of $x_T(v_i)$, for each $i\in\{1,\ldots,r\}$. (Equivalently, $v_0,\ldots,v_r$ is a subsequence of $\pi_1,\ldots,\pi_n$.) Any path in $H$ that is not vertical is \emph{humped}.  This allows us to define the humped us-chromatic number $\hus(H)=\hus(H,\mathcal{T})$ as in \cref{sec:trees}.

\begin{lem}
    For any $t$-tree $H$, $\uqs(H)\le \binom{t+2}{t}\hus(H)$.
\end{lem}

\begin{proof}
    A lemma of \citet{pilipczuk.siebertz:polynomial} (see \cite[Lemma~13]{pilipczuk.siebertz:polynomial-arxiv}) shows that from any vertex $v\in V(H)$, the number of vertical paths of length at most $p$ that end at $v$ is at most $\binom{t+p}{t}$.  Applying this with $p=2$ implies that we can greedily colour $v_1,\ldots,v_n$ to obtain a colouring $\psi:V(H)\to \{1,\ldots,\binom{t+2}{t}\}$ so that the endpoints of any non-trivial vertical path\footnote{A path is non-trivial if its length is at least 1.} of length at most $2$ are assigned different colours.  Let $\varphi:V(H)\to\{1,\ldots,k\}$ be a humped us-colouring of $H$.  As in \cref{product}, the colouring $\varphi':V(H)\to\{1,\ldots,k\}\times \{1,2,3\}$ defined by $\varphi'(v)=(\varphi(v),\varphi(v))$ proves the result.
\end{proof}

\begin{lem}
    For any graph $G$, $\uqs(G)\le 3\pw(G)+1$.
\end{lem}

\begin{proof}[Proof sketch]
    By induction on $\pw(G)$ starts by showing that, in the base case $\pw(G)=1$ (a caterpillar) the feet can all be coloured 1 and the the spine can be coloured with a repeating sequence $2,3,4,2,3,4\ldots$.
\end{proof}


\begin{obs}\label{colour-partition}
    Let $G$ be a graph, $X\subset V(G)$ and $\varphi:V(G)\to\N$ be such that
    \begin{compactenum}
        \item $\varphi:X\to\N$ is one-to-one;
        \item $\varphi$ is a us-colouring of $G-X$; and
        \item $\{\varphi(v):x\in X\} \cap \{\varphi(v):x\in V(G)\setminus X\} =\emptyset$.
    \end{compactenum}
    Then $\varphi$ is a us-colouring of $G$.
\end{obs}

For a node $x\in V(T)$, $T_x$ denotes the subtree of $T$ induced by all $T$-descendants of $x$, including $x$. Let $k$ be an integer such that $n:=|V(H)|\le \sqrt[4]{k!}$. The \emph{rank} of $x$, denoted $\rho_T(x)$ is the largest integer $c$ such that $|T_x| \le \sqrt[4]{k!/c!}$.  Since $\sigma_T(x) \le n \le \sqrt[4]{k!}$, $\rho_T(x)$ is well defined and $\rho_T(x)\in\{1,\ldots,k\}$ for every $x\in V(T)$.

For each $c\in\{1,\ldots,k\}$ let $L_c=\{x\in V(T):\rho_T(x) = c\}$ and let $X_c=\bigcup_{x\in L_c} B_x$.  For each $c\in\{1,\ldots,k\}$, $T[L_c]$ is a forest. Each root node of $T[L_c]$ is called a \emph{$c$-critical node}.  A node that is \emph{critical} if it is $c$-critical for some $c\in\{1,\ldots,k\}$.

\begin{lem}\label{descendant-count}
    For any node $x\in V(T)$ with $\rho_T(x)=c$, the number of $(c+1)$-critical $T$-descendants of $x$ is $O(\sqrt{c})$.
\end{lem}

\begin{proof}
    Since $\rho_T(x)=c$, $|T_x|\le \sqrt[4]{k!/c!}$.  Each $(c+1)$-critical node $y$ has $|T_y|> \sqrt[4]{k!/(c+2)!}$.  Letting $b$ denote the number of $(c+1)$-critical $T$-descendants of $x$ and chaining these inequalities gives
    \[
        b\sqrt[4]{k!/(c+2)!} < |T_x| \le \sqrt[4]{k!/c!} \enspace ,
    \]
    so $b \le \sqrt[4]{(c+1)(c+2)}=O(\sqrt{c})$.
\end{proof}

The following lemma illustrates our plan for us-colouring $H$.  Namely, it allows us to focus our remaining effort on finding a us-colouring of the subgraph of $H$ induced by critical nodes that has some additional properties.

\begin{lem}
    Let $C$ denote the set of critical nodes in $T$ and let $X=\bigcup_{x\in C} B_x$. and let $\varphi: X\to\N$ be a humped us-colouring of $H[X]$ such that, for each $c\in\{1,\ldots,k\}$ and each tree $T'$ in the forest $T[L_c]$, the restriction $\varphi: X\cap \bigcup_{x\in V(T')}B_x$ is one-to-one.  Then $\varphi$ can be completed to a humped us-colouring of $H$ such that $\varphi(v)\in\{-at\log k,\ldots,-1\}$ for every $v\in V(H)\setminus X$.
\end{lem}

\begin{proof}
    Consider the graph $H-X$.  The tree decomposition $(B_x:x\in T)$ yields a width-$t$ tree decomposition of $H-X$ in which each component $H'$ is mapped to a subtree $T'$ in the forest $T-C$.  By \cref{descendant-count}, (TODO: State this explicitly) each tree $T'$ in the forest $T-C$ has at $O(\sqrt[4]{k})$ leaves and therefore $\pw(T')=O(\log k)$.  It follows that $\pw(H')=O(t\pw(T'))=O(t\log k)$.  Thus $H'$ can be us-coloured using the colour set $\{-at\log k,\ldots,-1\}$.  By \cref{colour-partition}, this extends $\varphi$ to a us-colouring of $H[V(H')\cup N_H(V(H'))]$.  This graph covers every path $uvw$ of $H$ except those with $u$ and $w$ in different components of $H-X$.  But any such path must have $v\in X$, so $\varphi(v)\ge 0$ and $\varphi(u),\varphi(w)<0$.
\end{proof}
















Key definition:  The \emph{$i$-heavy subtree} of $T$ consists of those nodes $x$ such that the subtree $T_x$ rooted at $x$ has at least $f(i-1)$ nodes.  A heavy subtree will have at most $\alpha(k-i)$ leaves.


For each triple of integers $1\le i,t \le k$, $1\le i\le k$, let $f_{k,t}(i)$.



\section{Applying the Product Structure Theorem}
\seclabel{products}


\section{Conclusions}
\seclabel{conclusion}

New Stuff:

\begin{lem}\label{path-colour}
    Let $K$ be a $t$-path, let $\mathcal{P}:=(B_x:x\in V(P))$ be a width-$(t+1)$ path-decomposition of $K$ using the path $P=0,\ldots,m$, let $v_0$ be any vertex in $B_0$, and let $\varphi:B_{0}\setminus\{v_0\}\to\{\alpha\in N:\alpha > 3t\}$ be precolouring of all but one vertex of $B_{0}$.  The $\varphi$ can be extended to a us-colouring of $K$ in which $\varphi(v)\in\{0,\ldots,3t\}$ for each $v\in V(K)\setminus (B_0\setminus v_0)$.
\end{lem}

\begin{proof}
    The proof is by induction on $t$. In the base case $t=0$ and $K$ consists of an independent set (TODO: make sure $0$-tree is defined.) and all its uncoloured vertices can be coloured $0$.

    If $t>0$, it is well-known that $K$ contains a ``greedy path'' $w_0,\ldots,w_q$ such that $w_0\in B_0$, $w_q\in B_m$ and with the following property: (*)~there is no pair $1\le i<j-1\le q-1$ such that $w_i$ and $w_j$ are both adjacent to some $v\in V(K)\setminus \{w_0,\ldots,w_q\}$

    For each $i\in\{0,\ldots,q\}$, set $\varphi(w_i)=3t-i\bmod 3$ (unless $i=0$ and $w_0\neq x_0$, in which $\varphi(w_0)$ is already defined.) Now, the graph $K-\{w_0,\ldots,w_q\}$ is a partial $(t-1)$-path which can be augmented to to a $(t-1)$-path $K'$.  Applying induction on $K'$ gives a us-colouring $\varphi:V(K')\to\{0,\ldots,3(t-1)\}$ of $K'$ and it is easy to check that, because of property~(*) this completes $\varphi$ to a us-colouring of $K$.
\end{proof}

\begin{lem}
    Let $H$ be a $t$-tree, let $\mathcal{T}:=(B_x:x\in V(T))$ be a canonical path decomposition of $H$ where $T$ has root $r$,  let $T'$ be a subtree of $T$ with root $r'\neq r$ and having at most $\ell$ leaves, let $\kappa = (3t+1)\lceil\log_2(\ell+1)\rceil$, and let $\varphi:B_{r'}\setminus\{r'\}\to \{\alpha\in\N: \alpha > \tau\}$.  Then $\varphi$ can be completed to a us-colouring of the subgraph $H'=H[\bigcup_{x\in V(T')}B_x]$ so that $\varphi(v)\in\{1,\ldots,\tau\}$ for each $v\in V(H')\setminus (B_{r'}\setminus r')$.
\end{lem}

\begin{proof}
    The proof is by induction on $\ell$.  When $\ell=1$, $T'$ is a path and $H'$ is therefore a $t$-path.  The result then follows immediately from \cref{path-colouring}.

    Next we consider the case $\ell >1$.
    Let $T$ be ordered arbitrarily and let $x_1,\ldots,x_\ell$ be the leaves of $T'$ in the order they are encountered by an in in-order traversal.  Consider the path $P$ from the root of $T'$ to $x_{\lceil \ell/2\rceil}$.   Let $H[P]:=H[\bigcup_{x\in V(P)} B_x]$ and apply \cref{path-colouring} to $H[P]$ using the path decomposition $(B_x:x\in V(P))$ to obtain a us-colouring of $H[P]$ in which (after shifting) any newly-coloured vertex is assigned a colour in $\{\kappa - 3t,\ldots,\kappa\}$. Now, $T'-P$ is a forest that can be partitioned into two sets of trees, each of which has at most $\ell/2$ leaves.  We can now apply induction on each tree individually to obtain a us-colouring in which newly coloured nodes are assigned colours in $\{1,\ldots,\kappa-3t\}$.  It is easy to check that this gives a us-colouring of $H$.

    TODO: Check constants.
\end{proof}

\begin{lem}
    Let $H$ be a $t$-tree, let $\mathcal{T}:=(B_x:x\in V(T))$ be a canonical path decomposition of $H$,  let $T'$ be a subtree of $T$, let $\mathcal{P}=(P_x:x\in P)$ be a width-$p$ path decomposition of $T'$, let $S:=\bigcup_{x\in V(T')} B_x$  and let $Y:=\{x\in V(T): B_x\cap S\neq\emptyset\}$.
\end{lem}



\bibliographystyle{plainnat}
\bibliography{us}

\end{document}
